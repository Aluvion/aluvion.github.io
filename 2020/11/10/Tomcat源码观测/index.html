

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/css/images/bg/favicon.ico">
  <link rel="icon" href="/css/images/bg/favicon.ico">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Aluvion">
  <meta name="keywords" content="">
  
    <meta name="description" content="前言 说到 Java Web 就是 Tomcat，在后面学习 Java 无文件 WebShell 之前先来观摩一下 Tomcat 源码。 主要看看 filter、servlet 等。">
<meta property="og:type" content="article">
<meta property="og:title" content="Tomcat源码观测">
<meta property="og:url" content="http://yoursite.com/2020/11/10/Tomcat%E6%BA%90%E7%A0%81%E8%A7%82%E6%B5%8B/index.html">
<meta property="og:site_name" content="Twings">
<meta property="og:description" content="前言 说到 Java Web 就是 Tomcat，在后面学习 Java 无文件 WebShell 之前先来观摩一下 Tomcat 源码。 主要看看 filter、servlet 等。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-11-10T13:51:40.000Z">
<meta property="article:modified_time" content="2022-04-15T13:51:06.759Z">
<meta property="article:author" content="Aluvion">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="Tomcat">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>Tomcat源码观测 - Twings</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yoursite.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/css/images/bg/bg5.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Tomcat源码观测"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2020-11-10 21:51" pubdate>
          2020年11月10日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.9k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          58 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Tomcat源码观测</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p> 说到 Java Web 就是 Tomcat，在后面学习 Java 无文件 WebShell 之前先来观摩一下 Tomcat 源码。</p>
<p>主要看看 filter、servlet 等。</p>
<span id="more"></span>

<hr>
<h3 id="catalina-sh"><a href="#catalina-sh" class="headerlink" title="catalina.sh"></a>catalina.sh</h3><p>启动 Tomcat 的方法之一：.&#x2F;catalina.sh start，在脚本中执行的启动如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">eval</span> <span class="hljs-built_in">exec</span> <span class="hljs-string">&quot;\&quot;<span class="hljs-variable">$_RUNJAVA</span>\&quot;&quot;</span> <span class="hljs-string">&quot;\&quot;<span class="hljs-variable">$CATALINA_LOGGING_CONFIG</span>\&quot;&quot;</span> <span class="hljs-variable">$LOGGING_MANAGER</span> <span class="hljs-string">&quot;<span class="hljs-variable">$JAVA_OPTS</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$CATALINA_OPTS</span>&quot;</span> \<br>    -D<span class="hljs-variable">$ENDORSED_PROP</span>=<span class="hljs-string">&quot;\&quot;<span class="hljs-variable">$JAVA_ENDORSED_DIRS</span>\&quot;&quot;</span> \<br>    -classpath <span class="hljs-string">&quot;\&quot;<span class="hljs-variable">$CLASSPATH</span>\&quot;&quot;</span> \<br>    -Dcatalina.base=<span class="hljs-string">&quot;\&quot;<span class="hljs-variable">$CATALINA_BASE</span>\&quot;&quot;</span> \<br>    -Dcatalina.home=<span class="hljs-string">&quot;\&quot;<span class="hljs-variable">$CATALINA_HOME</span>\&quot;&quot;</span> \<br>    -Djava.io.tmpdir=<span class="hljs-string">&quot;\&quot;<span class="hljs-variable">$CATALINA_TMPDIR</span>\&quot;&quot;</span> \<br>    org.apache.catalina.startup.Bootstrap <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span> start<br></code></pre></td></tr></table></figure>

<p>通过 ps 查看到的完整命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs basH">/usr/lib/jvm/jdk1.8.0_191/jre/bin/java <br>-Djava.util.logging.config.file=/opt/apache-tomcat-9.0.12/conf/logging.properties <br>-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager <br>-Djdk.tls.ephemeralDHKeySize=2048 <br>-Djava.protocol.handler.pkgs=org.apache.catalina.webresources <br>-Dorg.apache.catalina.security.SecurityListener.UMASK=0027 <br>-Dignore.endorsed.dirs= <br>-classpath /opt/apache-tomcat-9.0.12/bin/bootstrap.jar:/opt/apache-tomcat-9.0.12/bin/tomcat-juli.jar <br>-Dcatalina.base=/opt/apache-tomcat-9.0.12 <br>-Dcatalina.home=/opt/apache-tomcat-9.0.12 <br>-Djava.io.tmpdir=/opt/apache-tomcat-9.0.12/temp <br>org.apache.catalina.startup.Bootstrap start<br></code></pre></td></tr></table></figure>

<p>这里的 classpath 主要是两个 jar：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">-classpath /opt/apache-tomcat-9.0.12/bin/bootstrap.jar:/opt/apache-tomcat-9.0.12/bin/tomcat-juli.jar <br></code></pre></td></tr></table></figure>

<p>以 start 为参数调用了 org.apache.catalina.startup.Bootstrap 类。</p>
<h3 id="load-init"><a href="#load-init" class="headerlink" title="load&#x2F;init"></a>load&#x2F;init</h3><p>这个类在 bootstrap.jar 中，静态代码块主要是设置各种环境变量，就不提了，看下 main 函数，前一半代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-keyword">synchronized</span>(daemonLock) &#123;<br>        <span class="hljs-keyword">if</span> (daemon == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">bootstrap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();<br><br>            <span class="hljs-keyword">try</span> &#123;<br>            	bootstrap.init();<br>            &#125; <span class="hljs-keyword">catch</span> (Throwable var5) &#123;<br>                ...<br>            &#125;<br><br>            daemon = bootstrap;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>        	Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);<br>        &#125;<br>    &#125;<br>	...<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先设置线程的环境，初始化环境的代码在 Bootstrap 的 init 函数中，前一半如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-built_in">this</span>.initClassLoaders();<br>    Thread.currentThread().setContextClassLoader(<span class="hljs-built_in">this</span>.catalinaLoader);<br>    SecurityClassLoad.securityClassLoad(<span class="hljs-built_in">this</span>.catalinaLoader);<br>    <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>    	log.debug(<span class="hljs-string">&quot;Loading startup class&quot;</span>);<br>    &#125;<br><br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先初始化了类加载器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initClassLoaders</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">this</span>.commonLoader = <span class="hljs-built_in">this</span>.createClassLoader(<span class="hljs-string">&quot;common&quot;</span>, (ClassLoader)<span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.commonLoader == <span class="hljs-literal">null</span>) &#123;<br>        	<span class="hljs-built_in">this</span>.commonLoader = <span class="hljs-built_in">this</span>.getClass().getClassLoader();<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.catalinaLoader = <span class="hljs-built_in">this</span>.createClassLoader(<span class="hljs-string">&quot;server&quot;</span>, <span class="hljs-built_in">this</span>.commonLoader);<br>        <span class="hljs-built_in">this</span>.sharedLoader = <span class="hljs-built_in">this</span>.createClassLoader(<span class="hljs-string">&quot;shared&quot;</span>, <span class="hljs-built_in">this</span>.commonLoader);<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable var2) &#123;<br>        handleThrowable(var2);<br>        log.error(<span class="hljs-string">&quot;Class loader creation threw exception&quot;</span>, var2);<br>        System.exit(<span class="hljs-number">1</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到这里会创建三个类加载器，其中 catalinaLoader 和 sharedLoader 是 commonLoader 的子类加载器，createClassLoader 函数中的创建代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> ClassLoader <span class="hljs-title function_">createClassLoader</span><span class="hljs-params">(String name, ClassLoader parent)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> CatalinaProperties.getProperty(name + <span class="hljs-string">&quot;.loader&quot;</span>);<br>    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> &amp;&amp; !value.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>        value = <span class="hljs-built_in">this</span>.replace(value);<br>        List&lt;Repository&gt; repositories = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        String[] repositoryPaths = getPaths(value);<br>        String[] var6 = repositoryPaths;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var7</span> <span class="hljs-operator">=</span> repositoryPaths.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var8</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var8 &lt; var7; ++var8) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">repository</span> <span class="hljs-operator">=</span> var6[var8];<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(repository);<br>                repositories.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Repository</span>(repository, RepositoryType.URL));<br>            &#125; <span class="hljs-keyword">catch</span> (MalformedURLException var11) &#123;<br>                <span class="hljs-keyword">if</span> (repository.endsWith(<span class="hljs-string">&quot;*.jar&quot;</span>)) &#123;<br>                    repository = repository.substring(<span class="hljs-number">0</span>, repository.length() - <span class="hljs-string">&quot;*.jar&quot;</span>.length());<br>                    repositories.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Repository</span>(repository, RepositoryType.GLOB));<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (repository.endsWith(<span class="hljs-string">&quot;.jar&quot;</span>)) &#123;<br>                    repositories.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Repository</span>(repository, RepositoryType.JAR));<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    repositories.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Repository</span>(repository, RepositoryType.DIR));<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> ClassLoaderFactory.createClassLoader(repositories, parent);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>    	<span class="hljs-keyword">return</span> parent;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>简单来说，就是从配置中获取加载类的路径然后创建类加载器，观察 CatalinaProperties 类的 getProperty 和 loadProperties 函数，可以看到配置来自 &#x2F;org&#x2F;apache&#x2F;catalina&#x2F;startup&#x2F;catalina.properties：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nix">c<span class="hljs-attr">ommon.loader</span><span class="hljs-operator">=</span><span class="hljs-string">&quot;<span class="hljs-subst">$&#123;catalina.base&#125;</span>/lib&quot;</span>,<span class="hljs-string">&quot;<span class="hljs-subst">$&#123;catalina.base&#125;</span>/lib/*.jar&quot;</span>,<span class="hljs-string">&quot;<span class="hljs-subst">$&#123;catalina.home&#125;</span>/lib&quot;</span>,<span class="hljs-string">&quot;<span class="hljs-subst">$&#123;catalina.home&#125;</span>/lib/*.jar&quot;</span><br>s<span class="hljs-attr">erver.loader</span><span class="hljs-operator">=</span><br>s<span class="hljs-attr">hared.loader</span><span class="hljs-operator">=</span><br></code></pre></td></tr></table></figure>

<p>可以看到，commonLoader 类加载器的加载路径是 Tomcat 的 lib 目录，而 catalinaLoader 和 sharedLoader 的加载路径为空，也就是说他们的值都是 commonLoader。</p>
<p>创建完类加载器后， 会加载一个 org.apache.catalina.startup.Catalina 类，实例化并将 sharedLoader，即 commonLoader 放入其中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">Class&lt;?&gt; startupClass = <span class="hljs-built_in">this</span>.catalinaLoader.loadClass(<span class="hljs-string">&quot;org.apache.catalina.startup.Catalina&quot;</span>);<br><span class="hljs-type">Object</span> <span class="hljs-variable">startupInstance</span> <span class="hljs-operator">=</span> startupClass.getConstructor().newInstance();<br><span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>    log.debug(<span class="hljs-string">&quot;Setting startup class properties&quot;</span>);<br>&#125;<br><br><span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;setParentClassLoader&quot;</span>;<br>Class&lt;?&gt;[] paramTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Class.forName(<span class="hljs-string">&quot;java.lang.ClassLoader&quot;</span>)&#125;;<br>Object[] paramValues = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-built_in">this</span>.sharedLoader&#125;;<br><span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> startupInstance.getClass().getMethod(methodName, paramTypes);<br>method.invoke(startupInstance, paramValues);<br><span class="hljs-built_in">this</span>.catalinaDaemon = startupInstance;<br></code></pre></td></tr></table></figure>

<p>回到 main 函数，start 命令会执行的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (command.equals(<span class="hljs-string">&quot;start&quot;</span>)) &#123;<br>    daemon.setAwait(<span class="hljs-literal">true</span>);<br>    daemon.load(args);<br>    daemon.start();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == daemon.getServer()) &#123;<br>    	System.exit(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>setAwait 只是给一个布尔属性赋值，跳过它看 load 函数。</p>
<p>调用的 load 函数来自 org.apache.catalina.startup.Catalina 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.loaded) &#123;<br>        <span class="hljs-built_in">this</span>.loaded = <span class="hljs-literal">true</span>;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> System.nanoTime();<br>        <span class="hljs-built_in">this</span>.initDirs();<br>        <span class="hljs-built_in">this</span>.initNaming();<br>        <span class="hljs-built_in">this</span>.parseServerXml(<span class="hljs-literal">true</span>);<br>        ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>此时还没有加载，所以 loaded 为 false，前面的环境变量设置（时间、目录等）跳过，后面的 parseServerXml 函数一看就是跟加载 web 配置文件相关的函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseServerXml</span><span class="hljs-params">(<span class="hljs-type">boolean</span> start)</span> &#123;<br>    ConfigFileLoader.setSource(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CatalinaBaseConfigurationSource</span>(Bootstrap.getCatalinaBaseFile(), <span class="hljs-built_in">this</span>.getConfigFile()));<br>    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.configFile();<br>    <span class="hljs-type">File</span> <span class="hljs-variable">serverXmlLocation</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.generateCode) &#123;<br>        ...<br>    &#125;<br><br>    Catalina.<span class="hljs-type">ServerXml</span> <span class="hljs-variable">serverXml</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.useGeneratedCode) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (serverXml != <span class="hljs-literal">null</span>) &#123;<br>        serverXml.load(<span class="hljs-built_in">this</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> ConfigFileLoader.getSource().getServerXml();<br>            <span class="hljs-type">Throwable</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Digester</span> <span class="hljs-variable">digester</span> <span class="hljs-operator">=</span> start ? <span class="hljs-built_in">this</span>.createStartDigester() : <span class="hljs-built_in">this</span>.createStopDigester();<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> resource.getInputStream();<br>                <span class="hljs-type">InputSource</span> <span class="hljs-variable">inputSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(resource.getURI().toURL().toString());<br>                inputSource.setByteStream(inputStream);<br>                digester.push(<span class="hljs-built_in">this</span>);<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.generateCode) &#123;<br>                    ...<br>                &#125;<br><br>                digester.parse(inputSource);<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.generateCode) &#123;<br>                    ...<br>                &#125;<br>            &#125; <br>            ...<br>        &#125; <br>        ...<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>实例化了一个 Digester XML 解析器，并将自身 Catalina 对象放入栈中，用于后面保存解析过程中生成的对象。</p>
<p>配置文件来自 CatalinaBaseConfigurationSource 类，使用 ConfigFileLoader.getSource().getServerXml() 获取配置文件资源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Resource <span class="hljs-title function_">getServerXml</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">IOException</span> <span class="hljs-variable">ioe</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">Resource</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.serverXmlPath != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-built_in">this</span>.serverXmlPath.equals(<span class="hljs-string">&quot;conf/server.xml&quot;</span>)) &#123;<br>            result = <span class="hljs-built_in">this</span>.getResource(<span class="hljs-built_in">this</span>.serverXmlPath);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            result = <span class="hljs-built_in">super</span>.getServerXml();<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException var6) &#123;<br>        ioe = var6;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> &amp;&amp; ioe != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> ioe;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>this.serverXmlPath 来自实例化时传入的 this.getConfigFile()，即 Catalina 类的 configFile 属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-type">String</span> <span class="hljs-variable">configFile</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;conf/server.xml&quot;</span>;<br></code></pre></td></tr></table></figure>

<p>获取配置文件资源后，然后开始使用 Digester 解析 xml（<a href="https://www.cnblogs.com/cenyu/p/11079144.html">参考文章</a>），这是个匹配 -&gt; 回调感觉的解析器，详细的规则可以在 createStartDigester 函数中看到，比如这三句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">digester.addObjectCreate(<span class="hljs-string">&quot;Server&quot;</span>, <span class="hljs-string">&quot;org.apache.catalina.core.StandardServer&quot;</span>, <span class="hljs-string">&quot;className&quot;</span>);<br>digester.addSetProperties(<span class="hljs-string">&quot;Server&quot;</span>);<br>digester.addSetNext(<span class="hljs-string">&quot;Server&quot;</span>, <span class="hljs-string">&quot;setServer&quot;</span>, <span class="hljs-string">&quot;org.apache.catalina.Server&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>这里的规则匹配 Server 标签，addObjectCreate 规则在没有 className 属性的情况下默认实例化一个 org.apache.catalina.core.StandardServer 类并放入栈中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">begin</span><span class="hljs-params">(String namespace, String name, Attributes attributes)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">realClassName</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getRealClassName(attributes);<br>    <span class="hljs-keyword">if</span> (realClassName == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(sm.getString(<span class="hljs-string">&quot;rule.noClassName&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;namespace, name&#125;));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        Class&lt;?&gt; clazz = <span class="hljs-built_in">this</span>.digester.getClassLoader().loadClass(realClassName);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> clazz.getConstructor().newInstance();<br>        <span class="hljs-built_in">this</span>.digester.push(instance);<br>        ...<br><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getRealClassName</span><span class="hljs-params">(Attributes attributes)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">realClassName</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.className;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.attributeName != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> attributes.getValue(<span class="hljs-built_in">this</span>.attributeName);<br>        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>            realClassName = value;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> realClassName;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>addSetProperties 规则用其他属性给 StandardServer 类赋值，跳过。</p>
<p>addSetNext 规则将 StandardServer 对象作为参数，调用 Catalina 对象的 setServer 函数将 StandardServer 保存起来。</p>
<p>解析完 server.xml 之后，Tomcat 服务端对象已经创建好并按层次保存在 Catalina 对象的 server 属性中了，回到 load 函数，接下来的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Server</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getServer();<br><span class="hljs-keyword">if</span> (s != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-built_in">this</span>.getServer().setCatalina(<span class="hljs-built_in">this</span>);<br>    <span class="hljs-built_in">this</span>.getServer().setCatalinaHome(Bootstrap.getCatalinaHomeFile());<br>    <span class="hljs-built_in">this</span>.getServer().setCatalinaBase(Bootstrap.getCatalinaBaseFile());<br>    <span class="hljs-built_in">this</span>.initStreams();<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">this</span>.getServer().init();<br>    &#125; <span class="hljs-keyword">catch</span> (LifecycleException var5) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (log.isInfoEnabled()) &#123;<br>        log.info(...);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用 this.getServer().init() 开始初始化服务端，看了一下各个模块类的 initInternal 函数，好像没什么特别的，那就直接回到 main 函数里面 daemon.start() 这一句吧。</p>
<h3 id="start"><a href="#start" class="headerlink" title="start"></a>start</h3><p>观察 server.xml 中的配置，可以发现一个 Service 就是一个 Web 服务，所以我们关注 Service 的启动，Service 的配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">Service</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Catalina&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Connector</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8080&quot;</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">&quot;HTTP/1.1&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">connectionTimeout</span>=<span class="hljs-string">&quot;20000&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">redirectPort</span>=<span class="hljs-string">&quot;8443&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Engine</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Catalina&quot;</span> <span class="hljs-attr">defaultHost</span>=<span class="hljs-string">&quot;localhost&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Realm</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.realm.LockOutRealm&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">Realm</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">resourceName</span>=<span class="hljs-string">&quot;UserDatabase&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">Realm</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Host</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;localhost&quot;</span>  <span class="hljs-attr">appBase</span>=<span class="hljs-string">&quot;webapps&quot;</span></span><br><span class="hljs-tag">              <span class="hljs-attr">unpackWARs</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">autoDeploy</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="hljs-attr">directory</span>=<span class="hljs-string">&quot;logs&quot;</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">prefix</span>=<span class="hljs-string">&quot;localhost_access_log&quot;</span> <span class="hljs-attr">suffix</span>=<span class="hljs-string">&quot;.txt&quot;</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;%h %l %u %t <span class="hljs-symbol">&amp;quot;</span>%r<span class="hljs-symbol">&amp;quot;</span> %s %b&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">Host</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">Engine</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Service</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>观察里面的配置项，可以看出 Connector 应该用于处理 HTTP 协议，而 Host 部分应该用于处理 HTTP 请求。</p>
<p>跟 init 类似，start 主要调用的是 startInternal 函数，Service 的 startInternal 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException &#123;<br>    <span class="hljs-keyword">if</span> (log.isInfoEnabled()) &#123;<br>        log.info(sm.getString(<span class="hljs-string">&quot;standardService.start.name&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-built_in">this</span>.name&#125;));<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.setState(LifecycleState.STARTING);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.engine != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>.engine) &#123;<br>            <span class="hljs-built_in">this</span>.engine.start();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>.executors) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.mapperListener.start();<br>    <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>.connectorsLock) &#123;<br>        Connector[] var10 = <span class="hljs-built_in">this</span>.connectors;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var11</span> <span class="hljs-operator">=</span> var10.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var4 &lt; var11; ++var4) &#123;<br>            <span class="hljs-type">Connector</span> <span class="hljs-variable">connector</span> <span class="hljs-operator">=</span> var10[var4];<br>            <span class="hljs-keyword">if</span> (connector.getState() != LifecycleState.FAILED) &#123;<br>                connector.start();<br>            &#125;<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>因为配置文件中没有 executors，所以就跳过了，简单来说就是启动 engine、mapperListener 和 connector，我们先看看 engine：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException &#123;<br>    <span class="hljs-keyword">if</span> (log.isInfoEnabled()) &#123;<br>        log.info(sm.getString(<span class="hljs-string">&quot;standardEngine.start&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;ServerInfo.getServerInfo()&#125;));<br>    &#125;<br><br>    <span class="hljs-built_in">super</span>.startInternal();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>engine 的启动没什么特别的，再看看 mapperListener：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException &#123;<br>    <span class="hljs-built_in">this</span>.setState(LifecycleState.STARTING);<br>    <span class="hljs-type">Engine</span> <span class="hljs-variable">engine</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.service.getContainer();<br>    <span class="hljs-keyword">if</span> (engine != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-built_in">this</span>.findDefaultHost();<br>        <span class="hljs-built_in">this</span>.addListeners(engine);<br>        Container[] conHosts = engine.findChildren();<br>        Container[] var3 = conHosts;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> conHosts.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var5 &lt; var4; ++var5) &#123;<br>            <span class="hljs-type">Container</span> <span class="hljs-variable">conHost</span> <span class="hljs-operator">=</span> var3[var5];<br>            <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> (Host)conHost;<br>            <span class="hljs-keyword">if</span> (!LifecycleState.NEW.equals(host.getState())) &#123;<br>                <span class="hljs-built_in">this</span>.registerHost(host);<br>            &#125;<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看代码中的命名，engine 应该就是我们在 Tomcat 中常常看到的 container。</p>
<p>mapperListener 启动时首先调用 findDefaultHost：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findDefaultHost</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Engine</span> <span class="hljs-variable">engine</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.service.getContainer();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">defaultHost</span> <span class="hljs-operator">=</span> engine.getDefaultHost();<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">found</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (defaultHost != <span class="hljs-literal">null</span> &amp;&amp; defaultHost.length() &gt; <span class="hljs-number">0</span>) &#123;<br>        Container[] containers = engine.findChildren();<br>        Container[] var5 = containers;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> containers.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var7</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var7 &lt; var6; ++var7) &#123;<br>            <span class="hljs-type">Container</span> <span class="hljs-variable">container</span> <span class="hljs-operator">=</span> var5[var7];<br>            <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> (Host)container;<br>            <span class="hljs-keyword">if</span> (defaultHost.equalsIgnoreCase(host.getName())) &#123;<br>                found = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br><br>            String[] aliases = host.findAliases();<br>            String[] var11 = aliases;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">var12</span> <span class="hljs-operator">=</span> aliases.length;<br><br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var13</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var13 &lt; var12; ++var13) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">alias</span> <span class="hljs-operator">=</span> var11[var13];<br>                <span class="hljs-keyword">if</span> (defaultHost.equalsIgnoreCase(alias)) &#123;<br>                    found = <span class="hljs-literal">true</span>;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (found) &#123;<br>        <span class="hljs-built_in">this</span>.mapper.setDefaultHostName(defaultHost);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        log.error(sm.getString(<span class="hljs-string">&quot;mapperListener.unknownDefaultHost&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;defaultHost, <span class="hljs-built_in">this</span>.service&#125;));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，只有在 engine 的 children 中找到一个其 name 和 defaultHost 相对应的，才会给 this.mapper 赋值。</p>
<p>engine 的 children 是通过 addChild 添加的，具体的解析规则可以到 HostRuleSet 类中找到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">digester.addObjectCreate(<span class="hljs-built_in">this</span>.prefix + <span class="hljs-string">&quot;Host&quot;</span>, <span class="hljs-string">&quot;org.apache.catalina.core.StandardHost&quot;</span>, <span class="hljs-string">&quot;className&quot;</span>);<br>digester.addSetProperties(<span class="hljs-built_in">this</span>.prefix + <span class="hljs-string">&quot;Host&quot;</span>);<br>...<br>digester.addSetNext(<span class="hljs-built_in">this</span>.prefix + <span class="hljs-string">&quot;Host&quot;</span>, <span class="hljs-string">&quot;addChild&quot;</span>, <span class="hljs-string">&quot;org.apache.catalina.Container&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>简单来说它的 children 就是 Host，因为 Host 中配置的 name 和 engine 中的 defaultHost 相同，所以会将 defaultHost 赋给 mapper。 </p>
<p>findDefaultHost 结束后，调用 addListeners 将自身这个 MapperListener 对象放入 Host 及 Host 的 children 中（默认配置时应该为空）。</p>
<p>最后调用 registerHost，将 Host 注册进 mapper 中（感觉 MapperListener 跟 Host 互相套娃的）。</p>
<p>回到 Service，下一步执行的是 connector 的 start：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getPortWithOffset() &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleException</span>(sm.getString(<span class="hljs-string">&quot;coyoteConnector.invalidPort&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-built_in">this</span>.getPortWithOffset()&#125;));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">this</span>.setState(LifecycleState.STARTING);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.protocolHandler.start();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception var2) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LifecycleException</span>(sm.getString(<span class="hljs-string">&quot;coyoteConnector.protocolHandlerStartFailed&quot;</span>), var2);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里启动了 protocolHandler，看名字就是用于处理协议的类，是在 connector 的构造函数中初始化的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ProtocolHandler</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br><span class="hljs-keyword">try</span> &#123;<br>    p = ProtocolHandler.create(protocol, apr);<br>&#125; <span class="hljs-keyword">catch</span> (Exception var5) &#123;<br>    log.error(sm.getString(<span class="hljs-string">&quot;coyoteConnector.protocolHandlerInstantiationFailed&quot;</span>), var5);<br>&#125;<br><br><span class="hljs-keyword">if</span> (p != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-built_in">this</span>.protocolHandler = p;<br>    <span class="hljs-built_in">this</span>.protocolHandlerClassName = <span class="hljs-built_in">this</span>.protocolHandler.getClass().getName();<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">this</span>.protocolHandler = <span class="hljs-literal">null</span>;<br>    <span class="hljs-built_in">this</span>.protocolHandlerClassName = protocol;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>而配置的协议为 HTTP&#x2F;1.1：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> ProtocolHandler <span class="hljs-title function_">create</span><span class="hljs-params">(String protocol, <span class="hljs-type">boolean</span> apr)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException, NoSuchMethodException, SecurityException &#123;<br>    <span class="hljs-keyword">if</span> (protocol == <span class="hljs-literal">null</span> || <span class="hljs-string">&quot;HTTP/1.1&quot;</span>.equals(protocol) || !apr &amp;&amp; Http11NioProtocol.class.getName().equals(protocol) || apr &amp;&amp; Http11AprProtocol.class.getName().equals(protocol)) &#123;<br>        <span class="hljs-keyword">return</span> (ProtocolHandler)(apr ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Http11AprProtocol</span>() : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Http11NioProtocol</span>());<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;AJP/1.3&quot;</span>.equals(protocol) || !apr &amp;&amp; AjpNioProtocol.class.getName().equals(protocol) || apr &amp;&amp; AjpAprProtocol.class.getName().equals(protocol)) &#123;<br>        <span class="hljs-keyword">return</span> (ProtocolHandler)(apr ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">AjpAprProtocol</span>() : <span class="hljs-keyword">new</span> <span class="hljs-title class_">AjpNioProtocol</span>());<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        Class&lt;?&gt; clazz = Class.forName(protocol);<br>        <span class="hljs-keyword">return</span> (ProtocolHandler)clazz.getConstructor().newInstance();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>默认没有开启 apr 的情况下，处理 HTTP 协议的类应该就是 Http11NioProtocol。</p>
<h3 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown"></a>shutdown</h3><p>回到 Catalina 类的 start 函数，最后会执行 await 开始监听请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.await) &#123;<br>    <span class="hljs-built_in">this</span>.await();<br>    <span class="hljs-built_in">this</span>.stop();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>this.await 在 Bootstrap 对象执行 daemon.setAwait(true) 时赋值为 true，await 函数会执行到 Server 的 await 函数，首先在 8005 端口创建了一个监听本地请求的 ServerSocket：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.awaitSocket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerSocket</span>(<span class="hljs-built_in">this</span>.getPortWithOffset(), <span class="hljs-number">1</span>, InetAddress.getByName(<span class="hljs-built_in">this</span>.address));<br></code></pre></td></tr></table></figure>

<p>然后从 client 读取字符，如果收到的命令为 shutdown 就会中断监听并关闭 socket：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-variable">match</span> <span class="hljs-operator">=</span> command.toString().equals(<span class="hljs-built_in">this</span>.shutdown);<br><span class="hljs-keyword">if</span> (match) &#123;<br>    log.info(sm.getString(<span class="hljs-string">&quot;standardServer.shutdownViaPort&quot;</span>));<br>    var32 = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">break</span>;<br>&#125;<br>...<br>serverSocket = <span class="hljs-built_in">this</span>.awaitSocket;<br><span class="hljs-built_in">this</span>.awaitThread = <span class="hljs-literal">null</span>;<br><span class="hljs-built_in">this</span>.awaitSocket = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (serverSocket != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        serverSocket.close();<br>    &#125; <span class="hljs-keyword">catch</span> (IOException var65) &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里的死循环结束之后，就会结束 await 函数并调用 this.stop：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.useShutdownHook) &#123;<br>            Runtime.getRuntime().removeShutdownHook(<span class="hljs-built_in">this</span>.shutdownHook);<br>            <span class="hljs-type">LogManager</span> <span class="hljs-variable">logManager</span> <span class="hljs-operator">=</span> LogManager.getLogManager();<br>            <span class="hljs-keyword">if</span> (logManager <span class="hljs-keyword">instanceof</span> ClassLoaderLogManager) &#123;<br>                ((ClassLoaderLogManager)logManager).setUseShutdownHook(<span class="hljs-literal">true</span>);<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable var3) &#123;<br>        ExceptionUtils.handleThrowable(var3);<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">Server</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getServer();<br>        <span class="hljs-type">LifecycleState</span> <span class="hljs-variable">state</span> <span class="hljs-operator">=</span> s.getState();<br>        <span class="hljs-keyword">if</span> (LifecycleState.STOPPING_PREP.compareTo(state) &gt; <span class="hljs-number">0</span> || LifecycleState.DESTROYED.compareTo(state) &lt; <span class="hljs-number">0</span>) &#123;<br>            s.stop();<br>            s.destroy();<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (LifecycleException var4) &#123;<br>        log.error(sm.getString(<span class="hljs-string">&quot;catalina.stopError&quot;</span>), var4);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用 Server 的 stop 和 destroy，大体来说就是一级级下去分别调用了 Service、Engine 等模块类的停止函数，就把整个 Tomcat 服务关闭了。</p>
<p>当我们使用 stop 命令关闭 Tomcat 时，Catalina 类会解析配置文件，获取 IP 端口等信息并传输 shutdown 命令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>(s.getAddress(), s.getPortWithOffset());<br>    <span class="hljs-type">Throwable</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">stream</span> <span class="hljs-operator">=</span> socket.getOutputStream();<br>        <span class="hljs-type">Throwable</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">shutdown</span> <span class="hljs-operator">=</span> s.getShutdown();<br><br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; shutdown.length(); ++i) &#123;<br>                stream.write(shutdown.charAt(i));<br>            &#125;<br><br>            stream.flush();<br>        &#125; <br>        ...<br><br>        &#125;<br>    &#125; <br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这样一来就实现了关闭 Tomcat。</p>
<h3 id="await"><a href="#await" class="headerlink" title="await"></a>await</h3><p>回到 connector 中执行的这一句代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.protocolHandler.start();<br></code></pre></td></tr></table></figure>

<p>这里就开始启动 web 部分的监听了，来到 Http11NioProtocol 父类 AbstractProtocol 的 start 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getLog().isInfoEnabled()) &#123;<br>        <span class="hljs-built_in">this</span>.getLog().info(sm.getString(<span class="hljs-string">&quot;abstractProtocolHandler.start&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-built_in">this</span>.getName()&#125;));<br>        <span class="hljs-built_in">this</span>.logPortOffset();<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.endpoint.start();<br>    <span class="hljs-built_in">this</span>.monitorFuture = <span class="hljs-built_in">this</span>.getUtilityExecutor().scheduleWithFixedDelay(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">if</span> (!AbstractProtocol.<span class="hljs-built_in">this</span>.isPaused()) &#123;<br>                AbstractProtocol.<span class="hljs-built_in">this</span>.startAsyncTimeout();<br>            &#125;<br><br>        &#125;<br>    &#125;, <span class="hljs-number">0L</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先调用了 endpoint.start，看下 endpoint 是个什么对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Http11NioProtocol</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">super</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEndpoint</span>());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后来到 Http11NioProtocol 类的 startInternal 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.running) &#123;<br>        <span class="hljs-built_in">this</span>.running = <span class="hljs-literal">true</span>;<br>        <span class="hljs-built_in">this</span>.paused = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.socketProperties.getProcessorCache() != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">this</span>.processorCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronizedStack</span>(<span class="hljs-number">128</span>, <span class="hljs-built_in">this</span>.socketProperties.getProcessorCache());<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.socketProperties.getEventCache() != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">this</span>.eventCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronizedStack</span>(<span class="hljs-number">128</span>, <span class="hljs-built_in">this</span>.socketProperties.getEventCache());<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.socketProperties.getBufferPool() != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">this</span>.nioChannels = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronizedStack</span>(<span class="hljs-number">128</span>, <span class="hljs-built_in">this</span>.socketProperties.getBufferPool());<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getExecutor() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-built_in">this</span>.createExecutor();<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.initializeConnectionLatch();<br>        <span class="hljs-built_in">this</span>.poller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEndpoint</span>.Poller();<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">pollerThread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-built_in">this</span>.poller, <span class="hljs-built_in">this</span>.getName() + <span class="hljs-string">&quot;-ClientPoller&quot;</span>);<br>        pollerThread.setPriority(<span class="hljs-built_in">this</span>.threadPriority);<br>        pollerThread.setDaemon(<span class="hljs-literal">true</span>);<br>        pollerThread.start();<br>        <span class="hljs-built_in">this</span>.startAcceptorThread();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>Tomcat 中的客户端请求处理是通过 Acceptor 和 Poller 两部分实现的，我们先看看 Acceptor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">byte</span> <span class="hljs-variable">errorDelay</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-built_in">this</span>.endpoint.isRunning()) &#123;<br>        ...<br><br>        <span class="hljs-built_in">this</span>.state = Acceptor.AcceptorState.RUNNING;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-built_in">this</span>.endpoint.countUpOrAwaitConnection();<br>            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.endpoint.isPaused()) &#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    socket = <span class="hljs-built_in">this</span>.endpoint.serverSocketAccept();<br>                &#125; <span class="hljs-keyword">catch</span> (Exception var6) &#123;<br>                    <span class="hljs-built_in">this</span>.endpoint.countDownConnection();<br>                    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.endpoint.isRunning()) &#123;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br><br>                    <span class="hljs-built_in">this</span>.handleExceptionWithDelay(errorDelay);<br>                    <span class="hljs-keyword">throw</span> var6;<br>                &#125;<br><br>                errorDelay = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.endpoint.isRunning() &amp;&amp; !<span class="hljs-built_in">this</span>.endpoint.isPaused()) &#123;<br>                    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.endpoint.setSocketOptions(socket)) &#123;<br>                        <span class="hljs-built_in">this</span>.endpoint.closeSocket(socket);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-built_in">this</span>.endpoint.destroySocket(socket);<br>                &#125;<br>            &#125;<br>        &#125; <br>        ...<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.state = Acceptor.AcceptorState.ENDED;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用 this.endpoint.serverSocketAccept 获取一个 SocketChannel：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> SocketChannel <span class="hljs-title function_">serverSocketAccept</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.serverSock.accept();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>accept 函数会一直阻塞直到新的请求到来。serverSock 的初始化在 initServerSocket 函数中（往上可以追溯到 Connector 的 this.protocolHandler.init() 这一句）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.serverSock = ServerSocketChannel.open();<br><span class="hljs-built_in">this</span>.socketProperties.setProperties(<span class="hljs-built_in">this</span>.serverSock.socket());<br><span class="hljs-type">InetSocketAddress</span> <span class="hljs-variable">addr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-built_in">this</span>.getAddress(), <span class="hljs-built_in">this</span>.getPortWithOffset());<br><span class="hljs-built_in">this</span>.serverSock.socket().bind(addr, <span class="hljs-built_in">this</span>.getAcceptCount());<br></code></pre></td></tr></table></figure>

<p>可以看到监听的地址和端口来自自身的两个属性，他们的赋值方式要追溯到 connector 的创建去了，解析 XML 时：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Connector</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Connector</span>(protocolName);<br>...<br><br><span class="hljs-built_in">this</span>.digester.push(con);<br></code></pre></td></tr></table></figure>

<p>创建一个 Connector 并放入栈中（如上文所说，protocolHandler 就是在 connector 构造函数中创建的），然后下一条规则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">digester.addSetProperties(<span class="hljs-string">&quot;Server/Service/Connector&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;executor&quot;</span>, <span class="hljs-string">&quot;sslImplementationName&quot;</span>, <span class="hljs-string">&quot;protocol&quot;</span>&#125;);<br></code></pre></td></tr></table></figure>

<p>除了这三个属性，其他都会进行赋值，SetPropertiesRule 的赋值处理如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (!IntrospectionUtils.setProperty(top, name, value, <span class="hljs-literal">true</span>, actualMethod)) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.digester.getRulesValidation() &amp;&amp; !<span class="hljs-string">&quot;optional&quot;</span>.equals(name)) &#123;<br>        <span class="hljs-built_in">this</span>.digester.log.warn(sm.getString(<span class="hljs-string">&quot;rule.noProperty&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-built_in">this</span>.digester.match, name, value&#125;));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>IntrospectionUtils 的处理比较别致，找不到特定属性的 setter 时会调用 setProperty：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;setProperty&quot;</span>.equals(method.getName())) &#123;<br>    <span class="hljs-keyword">if</span> (method.getReturnType() == Boolean.TYPE) &#123;<br>        setPropertyMethodBool = method;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        setPropertyMethodVoid = method;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>对于 connector 来说就是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setProperty</span><span class="hljs-params">(String name, String value)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.protocolHandler == <span class="hljs-literal">null</span> ? <span class="hljs-literal">false</span> : IntrospectionUtils.setProperty(<span class="hljs-built_in">this</span>.protocolHandler, name, value);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>对于 protocolHandler（Http11NioProtocol）来说就是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAddress</span><span class="hljs-params">(InetAddress ia)</span> &#123;<br>    <span class="hljs-built_in">this</span>.endpoint.setAddress(ia);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>所以一层层反射下去就会给 endpoint 赋值。</p>
<p>不过又有个问题，connector 反射的参数类型为 String，而 protocolHandler 却是 InetAddress，所以中间还存在一个类型转换的操作。再回到了 IntrospectionUtils，这里又有个对 InetAddress 类型参数的别致操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;java.net.InetAddress&quot;</span>.equals(paramType.getName())) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        params[<span class="hljs-number">0</span>] = InetAddress.getByName(value);<br>    &#125; <span class="hljs-keyword">catch</span> (UnknownHostException var20) &#123;<br>        <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>            log.debug(<span class="hljs-string">&quot;IntrospectionUtils: Unable to resolve host name:&quot;</span> + value);<br>        &#125;<br><br>        ok = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (actualMethod != <span class="hljs-literal">null</span>) &#123;<br>        actualMethod.append(method.getName()).append(<span class="hljs-string">&quot;(InetAddress.getByName(\&quot;&quot;</span>).append(value).append(<span class="hljs-string">&quot;\&quot;))&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>所以在 connector 中配置 address 可以设置 Tomcat 的监听地址。</p>
<p>不过看 server.xml，里面是没有配置 address 的，所以就是默认的 0.0.0.0：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">InetSocketAddress</span><span class="hljs-params">(InetAddress addr, <span class="hljs-type">int</span> port)</span> &#123;<br>    holder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddressHolder</span>(<br>        <span class="hljs-literal">null</span>,<br>        addr == <span class="hljs-literal">null</span> ? InetAddress.anyLocalAddress() : addr,<br>        checkPort(port));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>回到 Acceptor，在接收到请求并获取到一个 SocketChannel 之后，会调用 setSocketOptions：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setSocketOptions</span><span class="hljs-params">(SocketChannel socket)</span> &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">socketWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">NioChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.nioChannels != <span class="hljs-literal">null</span>) &#123;<br>            channel = (NioChannel)<span class="hljs-built_in">this</span>.nioChannels.pop();<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (channel == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">SocketBufferHandler</span> <span class="hljs-variable">bufhandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SocketBufferHandler</span>(<span class="hljs-built_in">this</span>.socketProperties.getAppReadBufSize(), <span class="hljs-built_in">this</span>.socketProperties.getAppWriteBufSize(), <span class="hljs-built_in">this</span>.socketProperties.getDirectBuffer());<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isSSLEnabled()) &#123;<br>                channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecureNioChannel</span>(bufhandler, <span class="hljs-built_in">this</span>.selectorPool, <span class="hljs-built_in">this</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioChannel</span>(bufhandler);<br>            &#125;<br>        &#125;<br><br>        NioEndpoint.<span class="hljs-type">NioSocketWrapper</span> <span class="hljs-variable">newWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEndpoint</span>.NioSocketWrapper((NioChannel)channel, <span class="hljs-built_in">this</span>);<br>        ((NioChannel)channel).reset(socket, newWrapper);<br>        <span class="hljs-built_in">this</span>.connections.put(socket, newWrapper);<br>        socket.configureBlocking(<span class="hljs-literal">false</span>);<br>        <span class="hljs-built_in">this</span>.socketProperties.setProperties(socket.socket());<br>        newWrapper.setReadTimeout((<span class="hljs-type">long</span>)<span class="hljs-built_in">this</span>.getConnectionTimeout());<br>        newWrapper.setWriteTimeout((<span class="hljs-type">long</span>)<span class="hljs-built_in">this</span>.getConnectionTimeout());<br>        newWrapper.setKeepAliveLeft(<span class="hljs-built_in">this</span>.getMaxKeepAliveRequests());<br>        <span class="hljs-built_in">this</span>.poller.register((NioChannel)channel, newWrapper);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125; <br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>新建一个 NioChannel，将 SocketChannel 和 NioSocketWrapper 放进去，再将新生成的 channel 和 wrapper 一起放入 connections Map 并注册进 Poller 中，注册进 Poller 中的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(NioChannel socket, NioEndpoint.NioSocketWrapper socketWrapper)</span> &#123;<br>    socketWrapper.interestOps(<span class="hljs-number">1</span>);<br>    NioEndpoint.<span class="hljs-type">PollerEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (NioEndpoint.<span class="hljs-built_in">this</span>.eventCache != <span class="hljs-literal">null</span>) &#123;<br>        event = (NioEndpoint.PollerEvent)NioEndpoint.<span class="hljs-built_in">this</span>.eventCache.pop();<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (event == <span class="hljs-literal">null</span>) &#123;<br>        event = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEndpoint</span>.PollerEvent(socket, <span class="hljs-number">256</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        event.reset(socket, <span class="hljs-number">256</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.addEvent(event);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>简单来说就是会添加进 events 这个队列中，Acceptor 的 run 函数大致结束了，接下来看看 Poller 的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasEvents</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>        label59: &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.close) &#123;<br>                    hasEvents = <span class="hljs-built_in">this</span>.events();<br>                    ...<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.close) &#123;<br>                    <span class="hljs-keyword">break</span> label59;<br>                &#125;<br><br>                ...<br>            &#125; <br>            ...<br>        &#125;<br><br>        ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看看 events 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">events</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    NioEndpoint.<span class="hljs-type">PollerEvent</span> <span class="hljs-variable">pe</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.events.size(); i &lt; size &amp;&amp; (pe = (NioEndpoint.PollerEvent)<span class="hljs-built_in">this</span>.events.poll()) != <span class="hljs-literal">null</span>; ++i) &#123;<br>        result = <span class="hljs-literal">true</span>;<br>        <span class="hljs-type">NioChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> pe.getSocket();<br>        NioEndpoint.<span class="hljs-type">NioSocketWrapper</span> <span class="hljs-variable">socketWrapper</span> <span class="hljs-operator">=</span> channel.getSocketWrapper();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">interestOps</span> <span class="hljs-operator">=</span> pe.getInterestOps();<br>        <span class="hljs-keyword">if</span> (interestOps == <span class="hljs-number">256</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                channel.getIOChannel().register(<span class="hljs-built_in">this</span>.getSelector(), <span class="hljs-number">1</span>, socketWrapper);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception var12) &#123;<br>                NioEndpoint.log.error(AbstractEndpoint.sm.getString(<span class="hljs-string">&quot;endpoint.nio.registerFail&quot;</span>), var12);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            ...<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (NioEndpoint.<span class="hljs-built_in">this</span>.running &amp;&amp; !NioEndpoint.<span class="hljs-built_in">this</span>.paused &amp;&amp; NioEndpoint.<span class="hljs-built_in">this</span>.eventCache != <span class="hljs-literal">null</span>) &#123;<br>            pe.reset();<br>            NioEndpoint.<span class="hljs-built_in">this</span>.eventCache.push(pe);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用 poll 从中队列中取出一个 event（并从队列中删除），关注这一句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.getIOChannel().register(<span class="hljs-built_in">this</span>.getSelector(), <span class="hljs-number">1</span>, socketWrapper);<br></code></pre></td></tr></table></figure>

<p>这里将 channel 注册到了 selector 上，并监听 read 事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">OP_READ</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">0</span>;<br></code></pre></td></tr></table></figure>

<p>继续看 run 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.wakeupCounter.getAndSet(-<span class="hljs-number">1L</span>) &gt; <span class="hljs-number">0L</span>) &#123;<br>    <span class="hljs-built_in">this</span>.keyCount = <span class="hljs-built_in">this</span>.selector.selectNow();<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">this</span>.keyCount = <span class="hljs-built_in">this</span>.selector.select(NioEndpoint.<span class="hljs-built_in">this</span>.selectorTimeout);<br>&#125;<br><br><span class="hljs-built_in">this</span>.wakeupCounter.set(<span class="hljs-number">0L</span>);<br></code></pre></td></tr></table></figure>

<p>wakeupCounter 是一个初始为 0 的计数器，每次 addEvent 就会 +1，没有 event 时就会为 0，从而进入 this.selector.select 的阻塞，超时时间为 1 秒。</p>
<p>如果存在有效事件，keyCount 就是有效事件的数量，后面就开始处理这些事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Iterator</span> <span class="hljs-variable">iterator</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.keyCount &gt; <span class="hljs-number">0</span> ? <span class="hljs-built_in">this</span>.selector.selectedKeys().iterator() : <span class="hljs-literal">null</span>;<br><br><span class="hljs-keyword">while</span>(iterator != <span class="hljs-literal">null</span> &amp;&amp; iterator.hasNext()) &#123;<br>    <span class="hljs-type">SelectionKey</span> <span class="hljs-variable">sk</span> <span class="hljs-operator">=</span> (SelectionKey)iterator.next();<br>    NioEndpoint.<span class="hljs-type">NioSocketWrapper</span> <span class="hljs-variable">socketWrapper</span> <span class="hljs-operator">=</span> (NioEndpoint.NioSocketWrapper)sk.attachment();<br>    <span class="hljs-keyword">if</span> (socketWrapper == <span class="hljs-literal">null</span>) &#123;<br>        iterator.remove();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        iterator.remove();<br>        <span class="hljs-built_in">this</span>.processKey(sk, socketWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看看 processKey 函数，关注 read 的部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (sk.isReadable()) &#123;<br>    <span class="hljs-keyword">if</span> (socketWrapper.readOperation != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!socketWrapper.readOperation.process()) &#123;<br>            closeSocket = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!NioEndpoint.<span class="hljs-built_in">this</span>.processSocket(socketWrapper, SocketEvent.OPEN_READ, <span class="hljs-literal">true</span>)) &#123;<br>        closeSocket = <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>下一步 processSocket：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (handshake == <span class="hljs-number">0</span>) &#123;<br>    AbstractEndpoint.Handler.<span class="hljs-type">SocketState</span> <span class="hljs-variable">state</span> <span class="hljs-operator">=</span> AbstractEndpoint.Handler.SocketState.OPEN;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.event == <span class="hljs-literal">null</span>) &#123;<br>        state = NioEndpoint.<span class="hljs-built_in">this</span>.getHandler().process(<span class="hljs-built_in">this</span>.socketWrapper, SocketEvent.OPEN_READ);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        state = NioEndpoint.<span class="hljs-built_in">this</span>.getHandler().process(<span class="hljs-built_in">this</span>.socketWrapper, <span class="hljs-built_in">this</span>.event);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (state == AbstractEndpoint.Handler.SocketState.CLOSED) &#123;<br>        poller.cancelledKey(socket.getIOChannel().keyFor(poller.getSelector()), <span class="hljs-built_in">this</span>.socketWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>handshake 为 0 代表 TCP 握手完成（大概），然后调用 handler 的 process 函数，这里的 handler 是个 ConnectionHandler 类，在 protocolHandler 实例化时赋值（AbstractHttp11Protocol 类构造函数）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">AbstractProtocol.ConnectionHandler&lt;S&gt; cHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbstractProtocol</span>.ConnectionHandler(<span class="hljs-built_in">this</span>);<br><span class="hljs-built_in">this</span>.setHandler(cHandler);<br><span class="hljs-built_in">this</span>.getEndpoint().setHandler(cHandler);<br></code></pre></td></tr></table></figure>

<p>process：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (processor == <span class="hljs-literal">null</span>) &#123;<br>    processor = <span class="hljs-built_in">this</span>.getProtocol().createProcessor();<br>    <span class="hljs-built_in">this</span>.register(processor);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getLog().isDebugEnabled()) &#123;<br>        <span class="hljs-built_in">this</span>.getLog().debug(AbstractProtocol.sm.getString(<span class="hljs-string">&quot;abstractConnectionHandler.processorCreate&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;processor&#125;));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>第一次访问时没有 processor，所以会调用 createProcessor 生成一个，AbstractHttp11Protocol 类的 createProcessor  函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Processor <span class="hljs-title function_">createProcessor</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Http11Processor</span> <span class="hljs-variable">processor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Http11Processor</span>(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.adapter);<br>    <span class="hljs-keyword">return</span> processor;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>生成的是 Http11Processor，然后调用其 process 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">state = processor.process(wrapper, status);<br></code></pre></td></tr></table></figure>

<p>然后来到 AbstractProcessorLight 类的 process：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == SocketEvent.OPEN_READ) &#123;<br>    state = <span class="hljs-built_in">this</span>.service(socketWrapper);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>回到 Http11Processor 类的 service 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.getAdapter().service(<span class="hljs-built_in">this</span>.request, <span class="hljs-built_in">this</span>.response);<br></code></pre></td></tr></table></figure>

<p>可以看到，这里有 request 和 response 两个属性，都来自 org.apache.coyote 包，找一下他们的生成方式，在父类 AbstractProcessor 的构造函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">AbstractProcessor</span><span class="hljs-params">(Adapter adapter)</span> &#123;<br>    <span class="hljs-built_in">this</span>(adapter, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>());<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-title function_">AbstractProcessor</span><span class="hljs-params">(Adapter adapter, Request coyoteRequest, Response coyoteResponse)</span> &#123;<br>    <span class="hljs-built_in">this</span>.hostNameC = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-built_in">this</span>.asyncTimeout = -<span class="hljs-number">1L</span>;<br>    <span class="hljs-built_in">this</span>.asyncTimeoutGeneration = <span class="hljs-number">0L</span>;<br>    <span class="hljs-built_in">this</span>.socketWrapper = <span class="hljs-literal">null</span>;<br>    <span class="hljs-built_in">this</span>.errorState = ErrorState.NONE;<br>    <span class="hljs-built_in">this</span>.adapter = adapter;<br>    <span class="hljs-built_in">this</span>.asyncStateMachine = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncStateMachine</span>(<span class="hljs-built_in">this</span>);<br>    <span class="hljs-built_in">this</span>.request = coyoteRequest;<br>    <span class="hljs-built_in">this</span>.response = coyoteResponse;<br>    <span class="hljs-built_in">this</span>.response.setHook(<span class="hljs-built_in">this</span>);<br>    <span class="hljs-built_in">this</span>.request.setResponse(<span class="hljs-built_in">this</span>.response);<br>    <span class="hljs-built_in">this</span>.request.setHook(<span class="hljs-built_in">this</span>);<br>    <span class="hljs-built_in">this</span>.userDataHelper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDataHelper</span>(<span class="hljs-built_in">this</span>.getLog());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到 response 就存放在 request 中，Http11Processor 放在 request 和 response 中。不过仔细观察这个 request 中的属性，会发现他们似乎并不是我们习惯的那个 request。</p>
<p>而 Adapter 的赋值要追溯到 Connector 的 initInternal 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.adapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CoyoteAdapter</span>(<span class="hljs-built_in">this</span>);<br></code></pre></td></tr></table></figure>

<p>跟进 CoyoteAdapter 类的 service 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (Request)req.getNote(<span class="hljs-number">1</span>);<br><span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> (Response)res.getNote(<span class="hljs-number">1</span>);<br><span class="hljs-keyword">if</span> (request == <span class="hljs-literal">null</span>) &#123;<br>    request = <span class="hljs-built_in">this</span>.connector.createRequest();<br>    request.setCoyoteRequest(req);<br>    response = <span class="hljs-built_in">this</span>.connector.createResponse();<br>    response.setCoyoteResponse(res);<br>    request.setResponse(response);<br>    response.setRequest(request);<br>    req.setNote(<span class="hljs-number">1</span>, request);<br>    res.setNote(<span class="hljs-number">1</span>, response);<br>    req.getParameters().setQueryStringCharset(<span class="hljs-built_in">this</span>.connector.getURICharset());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到我们习惯的 request（org.apache.catalina.connector），第一次访问时 request（org.apache.coyote）是刚刚生成的，所以 note 属性里面没有保存 request（org.apache.catalina.connector），这时会调用 createRequest&#x2F;createResponse 从 connector 生成并保存起来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Request <span class="hljs-title function_">createRequest</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>(<span class="hljs-built_in">this</span>);<br>&#125;<br><br><span class="hljs-keyword">public</span> Response <span class="hljs-title function_">createResponse</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.protocolHandler.getDesiredBufferSize();<br>    <span class="hljs-keyword">return</span> size &gt; <span class="hljs-number">0</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(size) : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>request 和 response 互相嵌套，connector 套进了 request 中。</p>
<p>然后开始处理 HTTP 请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">postParseSuccess = <span class="hljs-built_in">this</span>.postParseRequest(req, request, res, response);<br><span class="hljs-keyword">if</span> (postParseSuccess) &#123;<br>    request.setAsyncSupported(<span class="hljs-built_in">this</span>.connector.getService().getContainer().getPipeline().isAsyncSupported());<br>    <span class="hljs-built_in">this</span>.connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用 postParseRequest 解析请求，如果解析成功就会开始反射，看这一长串链式执行，可以简化成 engine.getPipeline().getFirst().invoke(request, response)，我们回到 engine 去看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardPipeline</span>(<span class="hljs-built_in">this</span>);<br></code></pre></td></tr></table></figure>

<p>StandardPipeline 类的 getFirst 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Valve <span class="hljs-title function_">getFirst</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.first != <span class="hljs-literal">null</span> ? <span class="hljs-built_in">this</span>.first : <span class="hljs-built_in">this</span>.basic;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调试可以发现，这里的 first 为 null，basic 来自 engine 的构造函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.pipeline.setBasic(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEngineValve</span>());<br></code></pre></td></tr></table></figure>

<p>所以最后的反射函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>    <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> request.getHost();<br>    <span class="hljs-keyword">if</span> (host != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (request.isAsyncSupported()) &#123;<br>            request.setAsyncSupported(host.getPipeline().isAsyncSupported());<br>        &#125;<br><br>        host.getPipeline().getFirst().invoke(request, response);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看看这里的 host 是怎么生成的，回到 postParseRequest，里面有一句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-built_in">this</span>.connector.getService().getMapper().map(serverName, decodedURI, version, request.getMappingData());<br></code></pre></td></tr></table></figure>

<p>会来到 Mapper 类的 internalMap 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Mapper.MappedHost[] hosts = <span class="hljs-built_in">this</span>.hosts;<br>Mapper.<span class="hljs-type">MappedHost</span> <span class="hljs-variable">mappedHost</span> <span class="hljs-operator">=</span> (Mapper.MappedHost)exactFindIgnoreCase(hosts, host);<br>...<br><br>mappingData.host = (Host)mappedHost.object;<br></code></pre></td></tr></table></figure>

<p>hosts 是一个数组，通过 addHost 函数进行添加，再往上回到 MapperListener 类的 registerHost 函数中，在前面 start 的时候会注册进去：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startInternal</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> LifecycleException &#123;<br>    <span class="hljs-built_in">this</span>.setState(LifecycleState.STARTING);<br>    <span class="hljs-type">Engine</span> <span class="hljs-variable">engine</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.service.getContainer();<br>    <span class="hljs-keyword">if</span> (engine != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-built_in">this</span>.findDefaultHost();<br>        <span class="hljs-built_in">this</span>.addListeners(engine);<br>        Container[] conHosts = engine.findChildren();<br>        Container[] var3 = conHosts;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> conHosts.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var5 &lt; var4; ++var5) &#123;<br>            <span class="hljs-type">Container</span> <span class="hljs-variable">conHost</span> <span class="hljs-operator">=</span> var3[var5];<br>            <span class="hljs-type">Host</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> (Host)conHost;<br>            <span class="hljs-keyword">if</span> (!LifecycleState.NEW.equals(host.getState())) &#123;<br>                <span class="hljs-built_in">this</span>.registerHost(host);<br>            &#125;<br>        &#125;<br><br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>可以看到源数据来自 engine，即 server.xml 中配置并解析生成的 standardHost 对象。然后再调用 exactFindIgnoreCase 从这些 hosts 中获取该次请求对应的 host：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> &lt;T, E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Mapper</span>.MapElement&lt;T&gt;&gt; E <span class="hljs-title function_">exactFindIgnoreCase</span><span class="hljs-params">(E[] map, CharChunk name)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">pos</span> <span class="hljs-operator">=</span> findIgnoreCase(map, name);<br>    <span class="hljs-keyword">if</span> (pos &gt;= <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">E</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> map[pos];<br>        <span class="hljs-keyword">if</span> (name.equalsIgnoreCase(result.name)) &#123;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>简单来说就是将访问的 host 和 sever.xml 中配置的 host 匹配一下。</p>
<p>除了 host，mappingData 中还存放了其他重要属性，比如说 context，我们继续往下看 internalMap 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Mapper.<span class="hljs-type">ContextList</span> <span class="hljs-variable">contextList</span> <span class="hljs-operator">=</span> mappedHost.contextList;<br>Mapper.MappedContext[] contexts = contextList.contexts;<br><span class="hljs-type">int</span> <span class="hljs-variable">pos</span> <span class="hljs-operator">=</span> find(contexts, (CharChunk)uri);<br></code></pre></td></tr></table></figure>

<p>这里出现了一个 host 中的属性 contextList，它是在 registerHost 的时候注册的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerHost</span><span class="hljs-params">(Host host)</span> &#123;<br>    String[] aliases = host.findAliases();<br>    <span class="hljs-built_in">this</span>.mapper.addHost(host.getName(), aliases, host);<br>    Container[] var3 = host.findChildren();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> var3.length;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var5 &lt; var4; ++var5) &#123;<br>        <span class="hljs-type">Container</span> <span class="hljs-variable">container</span> <span class="hljs-operator">=</span> var3[var5];<br>        <span class="hljs-keyword">if</span> (container.getState().isAvailable()) &#123;<br>            <span class="hljs-built_in">this</span>.registerContext((Context)container);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.findDefaultHost();<br>    ...<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后在 addContextVersion 函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">Mapper.<span class="hljs-type">ContextVersion</span> <span class="hljs-variable">newContextVersion</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mapper</span>.ContextVersion(version, path, slashCount, context, resources, welcomeResources);<br><span class="hljs-keyword">if</span> (wrappers != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-built_in">this</span>.addWrappers(newContextVersion, wrappers);<br>&#125;<br><br>Mapper.<span class="hljs-type">ContextList</span> <span class="hljs-variable">contextList</span> <span class="hljs-operator">=</span> mappedHost.contextList;<br>Mapper.<span class="hljs-type">MappedContext</span> <span class="hljs-variable">mappedContext</span> <span class="hljs-operator">=</span> (Mapper.MappedContext)exactFind(contextList.contexts, (String)path);<br><span class="hljs-keyword">if</span> (mappedContext == <span class="hljs-literal">null</span>) &#123;<br>    mappedContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mapper</span>.MappedContext(path, newContextVersion);<br>    Mapper.<span class="hljs-type">ContextList</span> <span class="hljs-variable">newContextList</span> <span class="hljs-operator">=</span> contextList.addContext(mappedContext, slashCount);<br>    <span class="hljs-keyword">if</span> (newContextList != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-built_in">this</span>.updateContextList(mappedHost, newContextList);<br>        <span class="hljs-built_in">this</span>.contextObjectToContextVersionMap.put(context, newContextVersion);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>context 和 contextVersion 放入 MappedContext，再放入 contextList 中。</p>
<p>context 配置在 server.xml 的 host 模块下面，代表一个 web 项目（war 包或其解压后的目录），而因为 Tomcat 开启了 autoDeploy 和 unpackWARs，所以文件中没有静态配置，而是由 Tomcat 进行动态加载。顺带一提的是 context 的 name 就是配置中的 path，在 setPath 函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.getName() == <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-built_in">this</span>.setName(<span class="hljs-built_in">this</span>.path);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续 internalMap，通过 uri 匹配到对应的 context 后，会将其放入 mappingData 中。（standardContext 就保存在 contextVersion 中）</p>
<p>还有一个重要属性 wrapper，获取 context 之后，会调用 internalMapWrapper 获取相应的 wrapper，先来看看 wrapper 的生成方式，context 中的 wrapper 在 ContextConfig 类中生成，这个类会解析 web.xml 并做相应处理，其 configureContext 函数一部分如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">var35 = webxml.getServlets().values().iterator();<br><br>Iterator var7;<br><span class="hljs-keyword">while</span>(var35.hasNext()) &#123;<br>    <span class="hljs-type">ServletDef</span> <span class="hljs-variable">servlet</span> <span class="hljs-operator">=</span> (ServletDef)var35.next();<br>    <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.context.createWrapper();<br>    ...<br>    <span class="hljs-built_in">this</span>.context.addChild(wrapper);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>生成 wrapper 然后用 addChild 添加到 context 中，可以发现  wrapper 和 servlet 是对应的，中间有一大段将 servlet 相关数据存储在 wrapper 中的代码被我省略了，接下来回到 standardContext 类的 createWrapper 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardWrapper</span>();<br></code></pre></td></tr></table></figure>

<p>wrapper 是一个 StandardWrapper 类，其他的没有什么特别操作了。在注册 context 的时候（registerContext），这些 wrapper 会经过 prepareWrapperMappingInfo 函数处理，合成一个 List：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepareWrapperMappingInfo</span><span class="hljs-params">(Context context, Wrapper wrapper, List&lt;WrapperMappingInfo&gt; wrappers)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">wrapperName</span> <span class="hljs-operator">=</span> wrapper.getName();<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">resourceOnly</span> <span class="hljs-operator">=</span> context.isResourceOnlyServlet(wrapperName);<br>    String[] mappings = wrapper.findMappings();<br>    String[] var7 = mappings;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">var8</span> <span class="hljs-operator">=</span> mappings.length;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var9</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var9 &lt; var8; ++var9) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mapping</span> <span class="hljs-operator">=</span> var7[var9];<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">jspWildCard</span> <span class="hljs-operator">=</span> wrapperName.equals(<span class="hljs-string">&quot;jsp&quot;</span>) &amp;&amp; mapping.endsWith(<span class="hljs-string">&quot;/*&quot;</span>);<br>        wrappers.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WrapperMappingInfo</span>(mapping, wrapper, jspWildCard, resourceOnly));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后通过 addWrappers 分门别类组装成 MappedWrapper 放入 contextVersion：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addWrappers</span><span class="hljs-params">(Mapper.ContextVersion contextVersion, Collection&lt;WrapperMappingInfo&gt; wrappers)</span> &#123;<br>    <span class="hljs-type">Iterator</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> wrappers.iterator();<br><br>    <span class="hljs-keyword">while</span>(var3.hasNext()) &#123;<br>        <span class="hljs-type">WrapperMappingInfo</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> (WrapperMappingInfo)var3.next();<br>        <span class="hljs-built_in">this</span>.addWrapper(contextVersion, wrapper.getMapping(), wrapper.getWrapper(), wrapper.isJspWildCard(), wrapper.isResourceOnly());<br>    &#125;<br><br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addWrapper</span><span class="hljs-params">(Mapper.ContextVersion context, String path, Wrapper wrapper, <span class="hljs-type">boolean</span> jspWildCard, <span class="hljs-type">boolean</span> resourceOnly)</span> &#123;<br>    <span class="hljs-keyword">synchronized</span>(context) &#123;<br>        String name;<br>        Mapper.MappedWrapper newWrapper;<br>        Mapper.MappedWrapper[] oldWrappers;<br>        Mapper.MappedWrapper[] newWrappers;<br>        <span class="hljs-keyword">if</span> (path.endsWith(<span class="hljs-string">&quot;/*&quot;</span>)) &#123;<br>            name = path.substring(<span class="hljs-number">0</span>, path.length() - <span class="hljs-number">2</span>);<br>            newWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mapper</span>.MappedWrapper(name, wrapper, jspWildCard, resourceOnly);<br>            oldWrappers = context.wildcardWrappers;<br>            newWrappers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mapper</span>.MappedWrapper[oldWrappers.length + <span class="hljs-number">1</span>];<br>            <span class="hljs-keyword">if</span> (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;<br>                context.Wrappers = newWrappers;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">slashCount</span> <span class="hljs-operator">=</span> slashCount(newWrapper.name);<br>                <span class="hljs-keyword">if</span> (slashCount &gt; context.nesting) &#123;<br>                    context.nesting = slashCount;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path.startsWith(<span class="hljs-string">&quot;*.&quot;</span>)) &#123;<br>            name = path.substring(<span class="hljs-number">2</span>);<br>            newWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mapper</span>.MappedWrapper(name, wrapper, jspWildCard, resourceOnly);<br>            oldWrappers = context.extensionWrappers;<br>            newWrappers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mapper</span>.MappedWrapper[oldWrappers.length + <span class="hljs-number">1</span>];<br>            <span class="hljs-keyword">if</span> (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;<br>                context.extensionWrappers = newWrappers;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path.equals(<span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>            Mapper.<span class="hljs-type">MappedWrapper</span> <span class="hljs-variable">newWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mapper</span>.MappedWrapper(<span class="hljs-string">&quot;&quot;</span>, wrapper, jspWildCard, resourceOnly);<br>            context.defaultWrapper = newWrapper;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (path.length() == <span class="hljs-number">0</span>) &#123;<br>                name = <span class="hljs-string">&quot;/&quot;</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                name = path;<br>            &#125;<br><br>            newWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mapper</span>.MappedWrapper(name, wrapper, jspWildCard, resourceOnly);<br>            oldWrappers = context.exactWrappers;<br>            newWrappers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mapper</span>.MappedWrapper[oldWrappers.length + <span class="hljs-number">1</span>];<br>            <span class="hljs-keyword">if</span> (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;<br>                context.exactWrappers = newWrappers;<br>            &#125;<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>主要有几个分类：</p>
<ul>
<li>wildcardWrappers：&#x2F;* 通配符结尾的路径</li>
<li>extensionWrappers：某一类后缀的路径</li>
<li>defaultWrapper：&#x2F; 结尾的默认（首页?）路径</li>
<li>exactWrappers：全匹配的详细路径</li>
</ul>
<p>现在回到 internalMapWrapper，可以看到匹配成功后，会将 wrapper 放入 mappingData 中。</p>
<p>回到反射，下一步是 StandardHostValve 类，获取的 context 就是前面 internalMap 函数匹配到的那个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> request.getContext();<br>...<br>context.getPipeline().getFirst().invoke(request, response);<br></code></pre></td></tr></table></figure>

<p>然后是 StandardContextValve 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>    <span class="hljs-type">MessageBytes</span> <span class="hljs-variable">requestPathMB</span> <span class="hljs-operator">=</span> request.getRequestPathMB();<br>    <span class="hljs-keyword">if</span> (!requestPathMB.startsWithIgnoreCase(<span class="hljs-string">&quot;/META-INF/&quot;</span>, <span class="hljs-number">0</span>) &amp;&amp; !requestPathMB.equalsIgnoreCase(<span class="hljs-string">&quot;/META-INF&quot;</span>) &amp;&amp; !requestPathMB.startsWithIgnoreCase(<span class="hljs-string">&quot;/WEB-INF/&quot;</span>, <span class="hljs-number">0</span>) &amp;&amp; !requestPathMB.equalsIgnoreCase(<span class="hljs-string">&quot;/WEB-INF&quot;</span>)) &#123;<br>        <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> request.getWrapper();<br>        <span class="hljs-keyword">if</span> (wrapper != <span class="hljs-literal">null</span> &amp;&amp; !wrapper.isUnavailable()) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                response.sendAcknowledgement();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException var6) &#123;<br>                <span class="hljs-built_in">this</span>.container.getLogger().error(sm.getString(<span class="hljs-string">&quot;standardContextValve.acknowledgeException&quot;</span>), var6);<br>                request.setAttribute(<span class="hljs-string">&quot;javax.servlet.error.exception&quot;</span>, var6);<br>                response.sendError(<span class="hljs-number">500</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (request.isAsyncSupported()) &#123;<br>                request.setAsyncSupported(wrapper.getPipeline().isAsyncSupported());<br>            &#125;<br><br>            wrapper.getPipeline().getFirst().invoke(request, response);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            response.sendError(<span class="hljs-number">404</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        response.sendError(<span class="hljs-number">404</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后是 StandardWrapperValve 类，首先会生成一个 Servlet 对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span> (!unavailable) &#123;<br>        servlet = wrapper.allocate();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>wrapper 的 allocate 函数中，会先检查自身的 instance 属性中有没有加载好的 servlet，没有则会调用 loadServlet 进行加载：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">servlet = (Servlet)instanceManager.newInstance(<span class="hljs-built_in">this</span>.servletClass);<br></code></pre></td></tr></table></figure>

<p>这里的 servletClass 来自 web.xml 中配置的类。</p>
<p>获取到 servlet 后，会调用 createFilterChain 创建 filterChain：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ApplicationFilterChain</span> <span class="hljs-variable">filterChain</span> <span class="hljs-operator">=</span> ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);<br></code></pre></td></tr></table></figure>

<p>createFilterChain：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ApplicationFilterChain</span> <span class="hljs-variable">filterChain</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (request <span class="hljs-keyword">instanceof</span> Request) &#123;<br>    <span class="hljs-type">Request</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (Request)request;<br>    <span class="hljs-keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;<br>        filterChain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterChain</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        filterChain = (ApplicationFilterChain)req.getFilterChain();<br>        <span class="hljs-keyword">if</span> (filterChain == <span class="hljs-literal">null</span>) &#123;<br>            filterChain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterChain</span>();<br>            req.setFilterChain(filterChain);<br>        &#125;<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    filterChain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApplicationFilterChain</span>();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>首先该 request 对象中有没有存放有 filterChain，如果没有（比如第一次访问）则生成一个 ApplicationFilterChain 对象。继续往下看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">filterChain.setServlet(servlet);<br>filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());<br><span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (StandardContext)wrapper.getParent();<br>FilterMap[] filterMaps = context.findFilterMaps();<br></code></pre></td></tr></table></figure>

<p>将 servlet 放入 filterChain，取出 context，再从 context 中取出 filterMaps，filterMaps 的赋值可以回到 configureContext：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">var2 = webxml.getFilterMappings().iterator();<br><br><span class="hljs-keyword">while</span>(var2.hasNext()) &#123;<br>    <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> (FilterMap)var2.next();<br>    <span class="hljs-built_in">this</span>.context.addFilterMap(filterMap);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>简单来说也是从 web.xml 中来的。回到 createFilterChain：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">servletName</span> <span class="hljs-operator">=</span> wrapper.getName();<br>FilterMap[] var10 = filterMaps;<br><span class="hljs-type">int</span> <span class="hljs-variable">var11</span> <span class="hljs-operator">=</span> filterMaps.length;<br><br><span class="hljs-type">int</span> var12;<br>FilterMap filterMap;<br>ApplicationFilterConfig filterConfig;<br><span class="hljs-keyword">for</span>(var12 = <span class="hljs-number">0</span>; var12 &lt; var11; ++var12) &#123;<br>    filterMap = var10[var12];<br>    <span class="hljs-keyword">if</span> (matchDispatcher(filterMap, dispatcher) &amp;&amp; matchFiltersURL(filterMap, requestPath)) &#123;<br>        filterConfig = (ApplicationFilterConfig)context.findFilterConfig(filterMap.getFilterName());<br>        <span class="hljs-keyword">if</span> (filterConfig != <span class="hljs-literal">null</span>) &#123;<br>            filterChain.addFilter(filterConfig);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>匹配上 DispatcherType 和 requestPath 就会加入 filterChain 中。</p>
<p>回到 StandardWrapperValve，创建完 filterChain 之后执行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">filterChain.doFilter(request.getRequest(), response.getResponse());<br></code></pre></td></tr></table></figure>

<p>即：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.pos &lt; <span class="hljs-built_in">this</span>.n) &#123;<br>    <span class="hljs-type">ApplicationFilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.filters[<span class="hljs-built_in">this</span>.pos++];<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">Filter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> filterConfig.getFilter();<br>        <span class="hljs-keyword">if</span> (request.isAsyncSupported() &amp;&amp; <span class="hljs-string">&quot;false&quot;</span>.equalsIgnoreCase(filterConfig.getFilterDef().getAsyncSupported())) &#123;<br>            request.setAttribute(<span class="hljs-string">&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;</span>, Boolean.FALSE);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;<br>            <span class="hljs-type">Principal</span> <span class="hljs-variable">principal</span> <span class="hljs-operator">=</span> ((HttpServletRequest)request).getUserPrincipal();<br>            Object[] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;request, response, <span class="hljs-built_in">this</span>&#125;;<br>            SecurityUtil.doAsPrivilege(<span class="hljs-string">&quot;doFilter&quot;</span>, filter, classType, args, principal);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            filter.doFilter(request, response, <span class="hljs-built_in">this</span>);<br>        &#125;<br><br>    &#125; <span class="hljs-keyword">catch</span> (ServletException | RuntimeException | IOException var15) &#123;<br>        <span class="hljs-keyword">throw</span> var15;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable var16) &#123;<br>        <span class="hljs-type">Throwable</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> ExceptionUtils.unwrapInvocationTargetException(var16);<br>        ExceptionUtils.handleThrowable(e);<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletException</span>(sm.getString(<span class="hljs-string">&quot;filterChain.filter&quot;</span>), e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>依次调用这些 filter 的 doFilter 函数，在处理完 filter 之后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;<br>        lastServicedRequest.set(request);<br>        lastServicedResponse.set(response);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (request.isAsyncSupported() &amp;&amp; !<span class="hljs-built_in">this</span>.servletSupportsAsync) &#123;<br>        request.setAttribute(<span class="hljs-string">&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;</span>, Boolean.FALSE);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (request <span class="hljs-keyword">instanceof</span> HttpServletRequest &amp;&amp; response <span class="hljs-keyword">instanceof</span> HttpServletResponse &amp;&amp; Globals.IS_SECURITY_ENABLED) &#123;<br>        <span class="hljs-type">Principal</span> <span class="hljs-variable">principal</span> <span class="hljs-operator">=</span> ((HttpServletRequest)request).getUserPrincipal();<br>        Object[] args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;request, response&#125;;<br>        SecurityUtil.doAsPrivilege(<span class="hljs-string">&quot;service&quot;</span>, <span class="hljs-built_in">this</span>.servlet, classTypeUsedInService, args, principal);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">this</span>.servlet.service(request, response);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>就开始调用 servlet 的 service 函数，往后就是项目的具体实现代码了，就不提了。</p>
<hr>
<p>Orz</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Web/" class="print-no-link">#Web</a>
      
        <a href="/tags/Java/" class="print-no-link">#Java</a>
      
        <a href="/tags/Tomcat/" class="print-no-link">#Tomcat</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Tomcat源码观测</div>
      <div>http://yoursite.com/2020/11/10/Tomcat源码观测/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Aluvion</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2020年11月10日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/11/24/Jenkins%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/" title="Jenkins相关漏洞学习（一）">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Jenkins相关漏洞学习（一）</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/10/21/Java-7u21-8u20-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/" title="Java 7u21/8u20 反序列化漏洞">
                        <span class="hidden-mobile">Java 7u21/8u20 反序列化漏洞</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
