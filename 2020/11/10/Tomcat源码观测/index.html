<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/css/images/bg/favicon.ico">
  <link rel="icon" type="image/png" href="/css/images/bg/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="摸鱼">
  <meta name="author" content="Aluvion">
  <meta name="keywords" content="">
  <title>Tomcat源码观测 - Twings</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.13.0/css/mdb.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css" />

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link  rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css" />

<link  rel="stylesheet" href="/css/main.css" />


  <link defer rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />


<!-- 自定义样式保持在最底部 -->


<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Twings</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">归档</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">标签</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">关于</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/links/">友链</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/css/images/bg/bg5.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <p class="mt-3 post-meta">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                  星期二, 十一月 10日 2020, 9:51 晚上
                </p>
              

              <p class="mt-1">
                
                  
                  <span class="post-meta">
                    <i class="far fa-chart-bar"></i>
                    7.5k 字
                  </span>
                

                
                  
                  <span class="post-meta">
                      <i class="far fa-clock"></i>
                      39 分钟
                  </span>
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  <span id="busuanzi_container_page_pv" class="post-meta" style="display: none">
                    <i class="far fa-eye" aria-hidden="true"></i>
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5 z-depth-3" id="board">
          <div class="post-content mx-auto" id="post">
            
            <div class="markdown-body">
              <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p> 说到 Java Web 就是 Tomcat，在后面学习 Java 无文件 WebShell 之前先来观摩一下 Tomcat 源码。</p>
<p>主要看看 filter、servlet 等。</p>
<span id="more"></span>

<hr>
<h3 id="catalina-sh"><a href="#catalina-sh" class="headerlink" title="catalina.sh"></a>catalina.sh</h3><p>启动 Tomcat 的方法之一：.&#x2F;catalina.sh start，在脚本中执行的启动如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">eval</span> <span class="built_in">exec</span> <span class="string">&quot;\&quot;<span class="variable">$_RUNJAVA</span>\&quot;&quot;</span> <span class="string">&quot;\&quot;<span class="variable">$CATALINA_LOGGING_CONFIG</span>\&quot;&quot;</span> <span class="variable">$LOGGING_MANAGER</span> <span class="string">&quot;<span class="variable">$JAVA_OPTS</span>&quot;</span> <span class="string">&quot;<span class="variable">$CATALINA_OPTS</span>&quot;</span> \</span><br><span class="line">    -D<span class="variable">$ENDORSED_PROP</span>=<span class="string">&quot;\&quot;<span class="variable">$JAVA_ENDORSED_DIRS</span>\&quot;&quot;</span> \</span><br><span class="line">    -classpath <span class="string">&quot;\&quot;<span class="variable">$CLASSPATH</span>\&quot;&quot;</span> \</span><br><span class="line">    -Dcatalina.base=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_BASE</span>\&quot;&quot;</span> \</span><br><span class="line">    -Dcatalina.home=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_HOME</span>\&quot;&quot;</span> \</span><br><span class="line">    -Djava.io.tmpdir=<span class="string">&quot;\&quot;<span class="variable">$CATALINA_TMPDIR</span>\&quot;&quot;</span> \</span><br><span class="line">    org.apache.catalina.startup.Bootstrap <span class="string">&quot;<span class="variable">$@</span>&quot;</span> start</span><br></pre></td></tr></table></figure>

<p>通过 ps 查看到的完整命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/jvm/jdk1.8.0_191/jre/bin/java </span><br><span class="line">-Djava.util.logging.config.file=/opt/apache-tomcat-9.0.12/conf/logging.properties </span><br><span class="line">-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager </span><br><span class="line">-Djdk.tls.ephemeralDHKeySize=2048 </span><br><span class="line">-Djava.protocol.handler.pkgs=org.apache.catalina.webresources </span><br><span class="line">-Dorg.apache.catalina.security.SecurityListener.UMASK=0027 </span><br><span class="line">-Dignore.endorsed.dirs= </span><br><span class="line">-classpath /opt/apache-tomcat-9.0.12/bin/bootstrap.jar:/opt/apache-tomcat-9.0.12/bin/tomcat-juli.jar </span><br><span class="line">-Dcatalina.base=/opt/apache-tomcat-9.0.12 </span><br><span class="line">-Dcatalina.home=/opt/apache-tomcat-9.0.12 </span><br><span class="line">-Djava.io.tmpdir=/opt/apache-tomcat-9.0.12/temp </span><br><span class="line">org.apache.catalina.startup.Bootstrap start</span><br></pre></td></tr></table></figure>

<p>这里的 classpath 主要是两个 jar：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-classpath /opt/apache-tomcat-9.0.12/bin/bootstrap.jar:/opt/apache-tomcat-9.0.12/bin/tomcat-juli.jar </span><br></pre></td></tr></table></figure>

<p>以 start 为参数调用了 org.apache.catalina.startup.Bootstrap 类。</p>
<h3 id="load-init"><a href="#load-init" class="headerlink" title="load&#x2F;init"></a>load&#x2F;init</h3><p>这个类在 bootstrap.jar 中，静态代码块主要是设置各种环境变量，就不提了，看下 main 函数，前一半代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(daemonLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (daemon == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            	bootstrap.init();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            daemon = bootstrap;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        	Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先设置线程的环境，初始化环境的代码在 Bootstrap 的 init 函数中，前一半如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="built_in">this</span>.initClassLoaders();</span><br><span class="line">    Thread.currentThread().setContextClassLoader(<span class="built_in">this</span>.catalinaLoader);</span><br><span class="line">    SecurityClassLoad.securityClassLoad(<span class="built_in">this</span>.catalinaLoader);</span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">    	log.debug(<span class="string">&quot;Loading startup class&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先初始化了类加载器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initClassLoaders</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.commonLoader = <span class="built_in">this</span>.createClassLoader(<span class="string">&quot;common&quot;</span>, (ClassLoader)<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.commonLoader == <span class="literal">null</span>) &#123;</span><br><span class="line">        	<span class="built_in">this</span>.commonLoader = <span class="built_in">this</span>.getClass().getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.catalinaLoader = <span class="built_in">this</span>.createClassLoader(<span class="string">&quot;server&quot;</span>, <span class="built_in">this</span>.commonLoader);</span><br><span class="line">        <span class="built_in">this</span>.sharedLoader = <span class="built_in">this</span>.createClassLoader(<span class="string">&quot;shared&quot;</span>, <span class="built_in">this</span>.commonLoader);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var2) &#123;</span><br><span class="line">        handleThrowable(var2);</span><br><span class="line">        log.error(<span class="string">&quot;Class loader creation threw exception&quot;</span>, var2);</span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里会创建三个类加载器，其中 catalinaLoader 和 sharedLoader 是 commonLoader 的子类加载器，createClassLoader 函数中的创建代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ClassLoader <span class="title function_">createClassLoader</span><span class="params">(String name, ClassLoader parent)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> CatalinaProperties.getProperty(name + <span class="string">&quot;.loader&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp; !value.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        value = <span class="built_in">this</span>.replace(value);</span><br><span class="line">        List&lt;Repository&gt; repositories = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        String[] repositoryPaths = getPaths(value);</span><br><span class="line">        String[] var6 = repositoryPaths;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var7</span> <span class="operator">=</span> repositoryPaths.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var8</span> <span class="operator">=</span> <span class="number">0</span>; var8 &lt; var7; ++var8) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">repository</span> <span class="operator">=</span> var6[var8];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">URL</span>(repository);</span><br><span class="line">                repositories.add(<span class="keyword">new</span> <span class="title class_">Repository</span>(repository, RepositoryType.URL));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (MalformedURLException var11) &#123;</span><br><span class="line">                <span class="keyword">if</span> (repository.endsWith(<span class="string">&quot;*.jar&quot;</span>)) &#123;</span><br><span class="line">                    repository = repository.substring(<span class="number">0</span>, repository.length() - <span class="string">&quot;*.jar&quot;</span>.length());</span><br><span class="line">                    repositories.add(<span class="keyword">new</span> <span class="title class_">Repository</span>(repository, RepositoryType.GLOB));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (repository.endsWith(<span class="string">&quot;.jar&quot;</span>)) &#123;</span><br><span class="line">                    repositories.add(<span class="keyword">new</span> <span class="title class_">Repository</span>(repository, RepositoryType.JAR));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    repositories.add(<span class="keyword">new</span> <span class="title class_">Repository</span>(repository, RepositoryType.DIR));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> ClassLoaderFactory.createClassLoader(repositories, parent);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="keyword">return</span> parent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来说，就是从配置中获取加载类的路径然后创建类加载器，观察 CatalinaProperties 类的 getProperty 和 loadProperties 函数，可以看到配置来自 &#x2F;org&#x2F;apache&#x2F;catalina&#x2F;startup&#x2F;catalina.properties：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">common.loader=&quot;$&#123;catalina.base&#125;/lib&quot;,&quot;$&#123;catalina.base&#125;/lib/*.jar&quot;,&quot;$&#123;catalina.home&#125;/lib&quot;,&quot;$&#123;catalina.home&#125;/lib/*.jar&quot;</span><br><span class="line">server.loader=</span><br><span class="line">shared.loader=</span><br></pre></td></tr></table></figure>

<p>可以看到，commonLoader 类加载器的加载路径是 Tomcat 的 lib 目录，而 catalinaLoader 和 sharedLoader 的加载路径为空，也就是说他们的值都是 commonLoader。</p>
<p>创建完类加载器后， 会加载一个 org.apache.catalina.startup.Catalina 类，实例化并将 sharedLoader，即 commonLoader 放入其中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; startupClass = <span class="built_in">this</span>.catalinaLoader.loadClass(<span class="string">&quot;org.apache.catalina.startup.Catalina&quot;</span>);</span><br><span class="line"><span class="type">Object</span> <span class="variable">startupInstance</span> <span class="operator">=</span> startupClass.getConstructor().newInstance();</span><br><span class="line"><span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">    log.debug(<span class="string">&quot;Setting startup class properties&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> <span class="string">&quot;setParentClassLoader&quot;</span>;</span><br><span class="line">Class&lt;?&gt;[] paramTypes = <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Class.forName(<span class="string">&quot;java.lang.ClassLoader&quot;</span>)&#125;;</span><br><span class="line">Object[] paramValues = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="built_in">this</span>.sharedLoader&#125;;</span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> startupInstance.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">method.invoke(startupInstance, paramValues);</span><br><span class="line"><span class="built_in">this</span>.catalinaDaemon = startupInstance;</span><br></pre></td></tr></table></figure>

<p>回到 main 函数，start 命令会执行的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;start&quot;</span>)) &#123;</span><br><span class="line">    daemon.setAwait(<span class="literal">true</span>);</span><br><span class="line">    daemon.load(args);</span><br><span class="line">    daemon.start();</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == daemon.getServer()) &#123;</span><br><span class="line">    	System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>setAwait 只是给一个布尔属性赋值，跳过它看 load 函数。</p>
<p>调用的 load 函数来自 org.apache.catalina.startup.Catalina 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.loaded) &#123;</span><br><span class="line">        <span class="built_in">this</span>.loaded = <span class="literal">true</span>;</span><br><span class="line">        <span class="type">long</span> <span class="variable">t1</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">        <span class="built_in">this</span>.initDirs();</span><br><span class="line">        <span class="built_in">this</span>.initNaming();</span><br><span class="line">        <span class="built_in">this</span>.parseServerXml(<span class="literal">true</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时还没有加载，所以 loaded 为 false，前面的环境变量设置（时间、目录等）跳过，后面的 parseServerXml 函数一看就是跟加载 web 配置文件相关的函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">parseServerXml</span><span class="params">(<span class="type">boolean</span> start)</span> &#123;</span><br><span class="line">    ConfigFileLoader.setSource(<span class="keyword">new</span> <span class="title class_">CatalinaBaseConfigurationSource</span>(Bootstrap.getCatalinaBaseFile(), <span class="built_in">this</span>.getConfigFile()));</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="built_in">this</span>.configFile();</span><br><span class="line">    <span class="type">File</span> <span class="variable">serverXmlLocation</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.generateCode) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Catalina.<span class="type">ServerXml</span> <span class="variable">serverXml</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.useGeneratedCode) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (serverXml != <span class="literal">null</span>) &#123;</span><br><span class="line">        serverXml.load(<span class="built_in">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Resource</span> <span class="variable">resource</span> <span class="operator">=</span> ConfigFileLoader.getSource().getServerXml();</span><br><span class="line">            <span class="type">Throwable</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Digester</span> <span class="variable">digester</span> <span class="operator">=</span> start ? <span class="built_in">this</span>.createStartDigester() : <span class="built_in">this</span>.createStopDigester();</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> resource.getInputStream();</span><br><span class="line">                <span class="type">InputSource</span> <span class="variable">inputSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputSource</span>(resource.getURI().toURL().toString());</span><br><span class="line">                inputSource.setByteStream(inputStream);</span><br><span class="line">                digester.push(<span class="built_in">this</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.generateCode) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                digester.parse(inputSource);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.generateCode) &#123;</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; </span><br><span class="line">            ...</span><br><span class="line">        &#125; </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实例化了一个 Digester XML 解析器，并将自身 Catalina 对象放入栈中，用于后面保存解析过程中生成的对象。</p>
<p>配置文件来自 CatalinaBaseConfigurationSource 类，使用 ConfigFileLoader.getSource().getServerXml() 获取配置文件资源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Resource <span class="title function_">getServerXml</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">IOException</span> <span class="variable">ioe</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Resource</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.serverXmlPath != <span class="literal">null</span> &amp;&amp; !<span class="built_in">this</span>.serverXmlPath.equals(<span class="string">&quot;conf/server.xml&quot;</span>)) &#123;</span><br><span class="line">            result = <span class="built_in">this</span>.getResource(<span class="built_in">this</span>.serverXmlPath);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = <span class="built_in">super</span>.getServerXml();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var6) &#123;</span><br><span class="line">        ioe = var6;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span> &amp;&amp; ioe != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ioe;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>this.serverXmlPath 来自实例化时传入的 this.getConfigFile()，即 Catalina 类的 configFile 属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">String</span> <span class="variable">configFile</span> <span class="operator">=</span> <span class="string">&quot;conf/server.xml&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>获取配置文件资源后，然后开始使用 Digester 解析 xml（<a href="https://www.cnblogs.com/cenyu/p/11079144.html">参考文章</a>），这是个匹配 -&gt; 回调感觉的解析器，详细的规则可以在 createStartDigester 函数中看到，比如这三句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">digester.addObjectCreate(<span class="string">&quot;Server&quot;</span>, <span class="string">&quot;org.apache.catalina.core.StandardServer&quot;</span>, <span class="string">&quot;className&quot;</span>);</span><br><span class="line">digester.addSetProperties(<span class="string">&quot;Server&quot;</span>);</span><br><span class="line">digester.addSetNext(<span class="string">&quot;Server&quot;</span>, <span class="string">&quot;setServer&quot;</span>, <span class="string">&quot;org.apache.catalina.Server&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这里的规则匹配 Server 标签，addObjectCreate 规则在没有 className 属性的情况下默认实例化一个 org.apache.catalina.core.StandardServer 类并放入栈中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">(String namespace, String name, Attributes attributes)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">realClassName</span> <span class="operator">=</span> <span class="built_in">this</span>.getRealClassName(attributes);</span><br><span class="line">    <span class="keyword">if</span> (realClassName == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(sm.getString(<span class="string">&quot;rule.noClassName&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;namespace, name&#125;));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = <span class="built_in">this</span>.digester.getClassLoader().loadClass(realClassName);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> clazz.getConstructor().newInstance();</span><br><span class="line">        <span class="built_in">this</span>.digester.push(instance);</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> String <span class="title function_">getRealClassName</span><span class="params">(Attributes attributes)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">realClassName</span> <span class="operator">=</span> <span class="built_in">this</span>.className;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.attributeName != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> attributes.getValue(<span class="built_in">this</span>.attributeName);</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="literal">null</span>) &#123;</span><br><span class="line">            realClassName = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> realClassName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>addSetProperties 规则用其他属性给 StandardServer 类赋值，跳过。</p>
<p>addSetNext 规则将 StandardServer 对象作为参数，调用 Catalina 对象的 setServer 函数将 StandardServer 保存起来。</p>
<p>解析完 server.xml 之后，Tomcat 服务端对象已经创建好并按层次保存在 Catalina 对象的 server 属性中了，回到 load 函数，接下来的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Server</span> <span class="variable">s</span> <span class="operator">=</span> <span class="built_in">this</span>.getServer();</span><br><span class="line"><span class="keyword">if</span> (s != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.getServer().setCatalina(<span class="built_in">this</span>);</span><br><span class="line">    <span class="built_in">this</span>.getServer().setCatalinaHome(Bootstrap.getCatalinaHomeFile());</span><br><span class="line">    <span class="built_in">this</span>.getServer().setCatalinaBase(Bootstrap.getCatalinaBaseFile());</span><br><span class="line">    <span class="built_in">this</span>.initStreams();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.getServer().init();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (LifecycleException var5) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">        log.info(...);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 this.getServer().init() 开始初始化服务端，看了一下各个模块类的 initInternal 函数，好像没什么特别的，那就直接回到 main 函数里面 daemon.start() 这一句吧。</p>
<h3 id="start"><a href="#start" class="headerlink" title="start"></a>start</h3><p>观察 server.xml 中的配置，可以发现一个 Service 就是一个 Web 服务，所以我们关注 Service 的启动，Service 的配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;localhost&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.realm.LockOutRealm&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">resourceName</span>=<span class="string">&quot;UserDatabase&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;localhost&quot;</span>  <span class="attr">appBase</span>=<span class="string">&quot;webapps&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">unpackWARs</span>=<span class="string">&quot;true&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.valves.AccessLogValve&quot;</span> <span class="attr">directory</span>=<span class="string">&quot;logs&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">prefix</span>=<span class="string">&quot;localhost_access_log&quot;</span> <span class="attr">suffix</span>=<span class="string">&quot;.txt&quot;</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">pattern</span>=<span class="string">&quot;%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>观察里面的配置项，可以看出 Connector 应该用于处理 HTTP 协议，而 Host 部分应该用于处理 HTTP 请求。</p>
<p>跟 init 类似，start 主要调用的是 startInternal 函数，Service 的 startInternal 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException &#123;</span><br><span class="line">    <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">        log.info(sm.getString(<span class="string">&quot;standardService.start.name&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="built_in">this</span>.name&#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.setState(LifecycleState.STARTING);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.engine != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="built_in">this</span>.engine) &#123;</span><br><span class="line">            <span class="built_in">this</span>.engine.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>.executors) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.mapperListener.start();</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>.connectorsLock) &#123;</span><br><span class="line">        Connector[] var10 = <span class="built_in">this</span>.connectors;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var11</span> <span class="operator">=</span> var10.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="number">0</span>; var4 &lt; var11; ++var4) &#123;</span><br><span class="line">            <span class="type">Connector</span> <span class="variable">connector</span> <span class="operator">=</span> var10[var4];</span><br><span class="line">            <span class="keyword">if</span> (connector.getState() != LifecycleState.FAILED) &#123;</span><br><span class="line">                connector.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为配置文件中没有 executors，所以就跳过了，简单来说就是启动 engine、mapperListener 和 connector，我们先看看 engine：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException &#123;</span><br><span class="line">    <span class="keyword">if</span> (log.isInfoEnabled()) &#123;</span><br><span class="line">        log.info(sm.getString(<span class="string">&quot;standardEngine.start&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;ServerInfo.getServerInfo()&#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">super</span>.startInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>engine 的启动没什么特别的，再看看 mapperListener：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(LifecycleState.STARTING);</span><br><span class="line">    <span class="type">Engine</span> <span class="variable">engine</span> <span class="operator">=</span> <span class="built_in">this</span>.service.getContainer();</span><br><span class="line">    <span class="keyword">if</span> (engine != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.findDefaultHost();</span><br><span class="line">        <span class="built_in">this</span>.addListeners(engine);</span><br><span class="line">        Container[] conHosts = engine.findChildren();</span><br><span class="line">        Container[] var3 = conHosts;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var4</span> <span class="operator">=</span> conHosts.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="number">0</span>; var5 &lt; var4; ++var5) &#123;</span><br><span class="line">            <span class="type">Container</span> <span class="variable">conHost</span> <span class="operator">=</span> var3[var5];</span><br><span class="line">            <span class="type">Host</span> <span class="variable">host</span> <span class="operator">=</span> (Host)conHost;</span><br><span class="line">            <span class="keyword">if</span> (!LifecycleState.NEW.equals(host.getState())) &#123;</span><br><span class="line">                <span class="built_in">this</span>.registerHost(host);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看代码中的命名，engine 应该就是我们在 Tomcat 中常常看到的 container。</p>
<p>mapperListener 启动时首先调用 findDefaultHost：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">findDefaultHost</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Engine</span> <span class="variable">engine</span> <span class="operator">=</span> <span class="built_in">this</span>.service.getContainer();</span><br><span class="line">    <span class="type">String</span> <span class="variable">defaultHost</span> <span class="operator">=</span> engine.getDefaultHost();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">found</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (defaultHost != <span class="literal">null</span> &amp;&amp; defaultHost.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Container[] containers = engine.findChildren();</span><br><span class="line">        Container[] var5 = containers;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var6</span> <span class="operator">=</span> containers.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var7</span> <span class="operator">=</span> <span class="number">0</span>; var7 &lt; var6; ++var7) &#123;</span><br><span class="line">            <span class="type">Container</span> <span class="variable">container</span> <span class="operator">=</span> var5[var7];</span><br><span class="line">            <span class="type">Host</span> <span class="variable">host</span> <span class="operator">=</span> (Host)container;</span><br><span class="line">            <span class="keyword">if</span> (defaultHost.equalsIgnoreCase(host.getName())) &#123;</span><br><span class="line">                found = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String[] aliases = host.findAliases();</span><br><span class="line">            String[] var11 = aliases;</span><br><span class="line">            <span class="type">int</span> <span class="variable">var12</span> <span class="operator">=</span> aliases.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var13</span> <span class="operator">=</span> <span class="number">0</span>; var13 &lt; var12; ++var13) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">alias</span> <span class="operator">=</span> var11[var13];</span><br><span class="line">                <span class="keyword">if</span> (defaultHost.equalsIgnoreCase(alias)) &#123;</span><br><span class="line">                    found = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (found) &#123;</span><br><span class="line">        <span class="built_in">this</span>.mapper.setDefaultHostName(defaultHost);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.error(sm.getString(<span class="string">&quot;mapperListener.unknownDefaultHost&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;defaultHost, <span class="built_in">this</span>.service&#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，只有在 engine 的 children 中找到一个其 name 和 defaultHost 相对应的，才会给 this.mapper 赋值。</p>
<p>engine 的 children 是通过 addChild 添加的，具体的解析规则可以到 HostRuleSet 类中找到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">digester.addObjectCreate(<span class="built_in">this</span>.prefix + <span class="string">&quot;Host&quot;</span>, <span class="string">&quot;org.apache.catalina.core.StandardHost&quot;</span>, <span class="string">&quot;className&quot;</span>);</span><br><span class="line">digester.addSetProperties(<span class="built_in">this</span>.prefix + <span class="string">&quot;Host&quot;</span>);</span><br><span class="line">...</span><br><span class="line">digester.addSetNext(<span class="built_in">this</span>.prefix + <span class="string">&quot;Host&quot;</span>, <span class="string">&quot;addChild&quot;</span>, <span class="string">&quot;org.apache.catalina.Container&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>简单来说它的 children 就是 Host，因为 Host 中配置的 name 和 engine 中的 defaultHost 相同，所以会将 defaultHost 赋给 mapper。 </p>
<p>findDefaultHost 结束后，调用 addListeners 将自身这个 MapperListener 对象放入 Host 及 Host 的 children 中（默认配置时应该为空）。</p>
<p>最后调用 registerHost，将 Host 注册进 mapper 中（感觉 MapperListener 跟 Host 互相套娃的）。</p>
<p>回到 Service，下一步执行的是 connector 的 start：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.getPortWithOffset() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LifecycleException</span>(sm.getString(<span class="string">&quot;coyoteConnector.invalidPort&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="built_in">this</span>.getPortWithOffset()&#125;));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setState(LifecycleState.STARTING);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.protocolHandler.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">LifecycleException</span>(sm.getString(<span class="string">&quot;coyoteConnector.protocolHandlerStartFailed&quot;</span>), var2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里启动了 protocolHandler，看名字就是用于处理协议的类，是在 connector 的构造函数中初始化的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ProtocolHandler</span> <span class="variable">p</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    p = ProtocolHandler.create(protocol, apr);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">    log.error(sm.getString(<span class="string">&quot;coyoteConnector.protocolHandlerInstantiationFailed&quot;</span>), var5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (p != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.protocolHandler = p;</span><br><span class="line">    <span class="built_in">this</span>.protocolHandlerClassName = <span class="built_in">this</span>.protocolHandler.getClass().getName();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.protocolHandler = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.protocolHandlerClassName = protocol;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而配置的协议为 HTTP&#x2F;1.1：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ProtocolHandler <span class="title function_">create</span><span class="params">(String protocol, <span class="type">boolean</span> apr)</span> <span class="keyword">throws</span> ClassNotFoundException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException, NoSuchMethodException, SecurityException &#123;</span><br><span class="line">    <span class="keyword">if</span> (protocol == <span class="literal">null</span> || <span class="string">&quot;HTTP/1.1&quot;</span>.equals(protocol) || !apr &amp;&amp; Http11NioProtocol.class.getName().equals(protocol) || apr &amp;&amp; Http11AprProtocol.class.getName().equals(protocol)) &#123;</span><br><span class="line">        <span class="keyword">return</span> (ProtocolHandler)(apr ? <span class="keyword">new</span> <span class="title class_">Http11AprProtocol</span>() : <span class="keyword">new</span> <span class="title class_">Http11NioProtocol</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;AJP/1.3&quot;</span>.equals(protocol) || !apr &amp;&amp; AjpNioProtocol.class.getName().equals(protocol) || apr &amp;&amp; AjpAprProtocol.class.getName().equals(protocol)) &#123;</span><br><span class="line">        <span class="keyword">return</span> (ProtocolHandler)(apr ? <span class="keyword">new</span> <span class="title class_">AjpAprProtocol</span>() : <span class="keyword">new</span> <span class="title class_">AjpNioProtocol</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(protocol);</span><br><span class="line">        <span class="keyword">return</span> (ProtocolHandler)clazz.getConstructor().newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认没有开启 apr 的情况下，处理 HTTP 协议的类应该就是 Http11NioProtocol。</p>
<h3 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown"></a>shutdown</h3><p>回到 Catalina 类的 start 函数，最后会执行 await 开始监听请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.await) &#123;</span><br><span class="line">    <span class="built_in">this</span>.await();</span><br><span class="line">    <span class="built_in">this</span>.stop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>this.await 在 Bootstrap 对象执行 daemon.setAwait(true) 时赋值为 true，await 函数会执行到 Server 的 await 函数，首先在 8005 端口创建了一个监听本地请求的 ServerSocket：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.awaitSocket = <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="built_in">this</span>.getPortWithOffset(), <span class="number">1</span>, InetAddress.getByName(<span class="built_in">this</span>.address));</span><br></pre></td></tr></table></figure>

<p>然后从 client 读取字符，如果收到的命令为 shutdown 就会中断监听并关闭 socket：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">match</span> <span class="operator">=</span> command.toString().equals(<span class="built_in">this</span>.shutdown);</span><br><span class="line"><span class="keyword">if</span> (match) &#123;</span><br><span class="line">    log.info(sm.getString(<span class="string">&quot;standardServer.shutdownViaPort&quot;</span>));</span><br><span class="line">    var32 = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">serverSocket = <span class="built_in">this</span>.awaitSocket;</span><br><span class="line"><span class="built_in">this</span>.awaitThread = <span class="literal">null</span>;</span><br><span class="line"><span class="built_in">this</span>.awaitSocket = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (serverSocket != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        serverSocket.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var65) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的死循环结束之后，就会结束 await 函数并调用 this.stop：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.useShutdownHook) &#123;</span><br><span class="line">            Runtime.getRuntime().removeShutdownHook(<span class="built_in">this</span>.shutdownHook);</span><br><span class="line">            <span class="type">LogManager</span> <span class="variable">logManager</span> <span class="operator">=</span> LogManager.getLogManager();</span><br><span class="line">            <span class="keyword">if</span> (logManager <span class="keyword">instanceof</span> ClassLoaderLogManager) &#123;</span><br><span class="line">                ((ClassLoaderLogManager)logManager).setUseShutdownHook(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(var3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Server</span> <span class="variable">s</span> <span class="operator">=</span> <span class="built_in">this</span>.getServer();</span><br><span class="line">        <span class="type">LifecycleState</span> <span class="variable">state</span> <span class="operator">=</span> s.getState();</span><br><span class="line">        <span class="keyword">if</span> (LifecycleState.STOPPING_PREP.compareTo(state) &gt; <span class="number">0</span> || LifecycleState.DESTROYED.compareTo(state) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            s.stop();</span><br><span class="line">            s.destroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (LifecycleException var4) &#123;</span><br><span class="line">        log.error(sm.getString(<span class="string">&quot;catalina.stopError&quot;</span>), var4);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 Server 的 stop 和 destroy，大体来说就是一级级下去分别调用了 Service、Engine 等模块类的停止函数，就把整个 Tomcat 服务关闭了。</p>
<p>当我们使用 stop 命令关闭 Tomcat 时，Catalina 类会解析配置文件，获取 IP 端口等信息并传输 shutdown 命令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Socket</span>(s.getAddress(), s.getPortWithOffset());</span><br><span class="line">    <span class="type">Throwable</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">stream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">var6</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">shutdown</span> <span class="operator">=</span> s.getShutdown();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; shutdown.length(); ++i) &#123;</span><br><span class="line">                stream.write(shutdown.charAt(i));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            stream.flush();</span><br><span class="line">        &#125; </span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样一来就实现了关闭 Tomcat。</p>
<h3 id="await"><a href="#await" class="headerlink" title="await"></a>await</h3><p>回到 connector 中执行的这一句代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.protocolHandler.start();</span><br></pre></td></tr></table></figure>

<p>这里就开始启动 web 部分的监听了，来到 Http11NioProtocol 父类 AbstractProtocol 的 start 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.getLog().isInfoEnabled()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.getLog().info(sm.getString(<span class="string">&quot;abstractProtocolHandler.start&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="built_in">this</span>.getName()&#125;));</span><br><span class="line">        <span class="built_in">this</span>.logPortOffset();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.endpoint.start();</span><br><span class="line">    <span class="built_in">this</span>.monitorFuture = <span class="built_in">this</span>.getUtilityExecutor().scheduleWithFixedDelay(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!AbstractProtocol.<span class="built_in">this</span>.isPaused()) &#123;</span><br><span class="line">                AbstractProtocol.<span class="built_in">this</span>.startAsyncTimeout();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">0L</span>, <span class="number">60L</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先调用了 endpoint.start，看下 endpoint 是个什么对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Http11NioProtocol</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">NioEndpoint</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后来到 Http11NioProtocol 类的 startInternal 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.running) &#123;</span><br><span class="line">        <span class="built_in">this</span>.running = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">this</span>.paused = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.socketProperties.getProcessorCache() != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.processorCache = <span class="keyword">new</span> <span class="title class_">SynchronizedStack</span>(<span class="number">128</span>, <span class="built_in">this</span>.socketProperties.getProcessorCache());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.socketProperties.getEventCache() != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.eventCache = <span class="keyword">new</span> <span class="title class_">SynchronizedStack</span>(<span class="number">128</span>, <span class="built_in">this</span>.socketProperties.getEventCache());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.socketProperties.getBufferPool() != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.nioChannels = <span class="keyword">new</span> <span class="title class_">SynchronizedStack</span>(<span class="number">128</span>, <span class="built_in">this</span>.socketProperties.getBufferPool());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.getExecutor() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.createExecutor();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.initializeConnectionLatch();</span><br><span class="line">        <span class="built_in">this</span>.poller = <span class="keyword">new</span> <span class="title class_">NioEndpoint</span>.Poller();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">pollerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>.poller, <span class="built_in">this</span>.getName() + <span class="string">&quot;-ClientPoller&quot;</span>);</span><br><span class="line">        pollerThread.setPriority(<span class="built_in">this</span>.threadPriority);</span><br><span class="line">        pollerThread.setDaemon(<span class="literal">true</span>);</span><br><span class="line">        pollerThread.start();</span><br><span class="line">        <span class="built_in">this</span>.startAcceptorThread();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Tomcat 中的客户端请求处理是通过 Acceptor 和 Poller 两部分实现的，我们先看看 Acceptor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">byte</span> <span class="variable">errorDelay</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">this</span>.endpoint.isRunning()) &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.state = Acceptor.AcceptorState.RUNNING;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.endpoint.countUpOrAwaitConnection();</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.endpoint.isPaused()) &#123;</span><br><span class="line">                <span class="type">Object</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    socket = <span class="built_in">this</span>.endpoint.serverSocketAccept();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.endpoint.countDownConnection();</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">this</span>.endpoint.isRunning()) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">this</span>.handleExceptionWithDelay(errorDelay);</span><br><span class="line">                    <span class="keyword">throw</span> var6;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                errorDelay = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.endpoint.isRunning() &amp;&amp; !<span class="built_in">this</span>.endpoint.isPaused()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="built_in">this</span>.endpoint.setSocketOptions(socket)) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.endpoint.closeSocket(socket);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">this</span>.endpoint.destroySocket(socket);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.state = Acceptor.AcceptorState.ENDED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 this.endpoint.serverSocketAccept 获取一个 SocketChannel：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> SocketChannel <span class="title function_">serverSocketAccept</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.serverSock.accept();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>accept 函数会一直阻塞直到新的请求到来。serverSock 的初始化在 initServerSocket 函数中（往上可以追溯到 Connector 的 this.protocolHandler.init() 这一句）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.serverSock = ServerSocketChannel.open();</span><br><span class="line"><span class="built_in">this</span>.socketProperties.setProperties(<span class="built_in">this</span>.serverSock.socket());</span><br><span class="line"><span class="type">InetSocketAddress</span> <span class="variable">addr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="built_in">this</span>.getAddress(), <span class="built_in">this</span>.getPortWithOffset());</span><br><span class="line"><span class="built_in">this</span>.serverSock.socket().bind(addr, <span class="built_in">this</span>.getAcceptCount());</span><br></pre></td></tr></table></figure>

<p>可以看到监听的地址和端口来自自身的两个属性，他们的赋值方式要追溯到 connector 的创建去了，解析 XML 时：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Connector</span> <span class="variable">con</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Connector</span>(protocolName);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="built_in">this</span>.digester.push(con);</span><br></pre></td></tr></table></figure>

<p>创建一个 Connector 并放入栈中（如上文所说，protocolHandler 就是在 connector 构造函数中创建的），然后下一条规则：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">digester.addSetProperties(<span class="string">&quot;Server/Service/Connector&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;executor&quot;</span>, <span class="string">&quot;sslImplementationName&quot;</span>, <span class="string">&quot;protocol&quot;</span>&#125;);</span><br></pre></td></tr></table></figure>

<p>除了这三个属性，其他都会进行赋值，SetPropertiesRule 的赋值处理如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!IntrospectionUtils.setProperty(top, name, value, <span class="literal">true</span>, actualMethod)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.digester.getRulesValidation() &amp;&amp; !<span class="string">&quot;optional&quot;</span>.equals(name)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.digester.log.warn(sm.getString(<span class="string">&quot;rule.noProperty&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="built_in">this</span>.digester.match, name, value&#125;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IntrospectionUtils 的处理比较别致，找不到特定属性的 setter 时会调用 setProperty：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">&quot;setProperty&quot;</span>.equals(method.getName())) &#123;</span><br><span class="line">    <span class="keyword">if</span> (method.getReturnType() == Boolean.TYPE) &#123;</span><br><span class="line">        setPropertyMethodBool = method;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setPropertyMethodVoid = method;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于 connector 来说就是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">setProperty</span><span class="params">(String name, String value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.protocolHandler == <span class="literal">null</span> ? <span class="literal">false</span> : IntrospectionUtils.setProperty(<span class="built_in">this</span>.protocolHandler, name, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于 protocolHandler（Http11NioProtocol）来说就是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAddress</span><span class="params">(InetAddress ia)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.endpoint.setAddress(ia);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以一层层反射下去就会给 endpoint 赋值。</p>
<p>不过又有个问题，connector 反射的参数类型为 String，而 protocolHandler 却是 InetAddress，所以中间还存在一个类型转换的操作。再回到了 IntrospectionUtils，这里又有个对 InetAddress 类型参数的别致操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="string">&quot;java.net.InetAddress&quot;</span>.equals(paramType.getName())) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        params[<span class="number">0</span>] = InetAddress.getByName(value);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnknownHostException var20) &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;IntrospectionUtils: Unable to resolve host name:&quot;</span> + value);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ok = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (actualMethod != <span class="literal">null</span>) &#123;</span><br><span class="line">        actualMethod.append(method.getName()).append(<span class="string">&quot;(InetAddress.getByName(\&quot;&quot;</span>).append(value).append(<span class="string">&quot;\&quot;))&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以在 connector 中配置 address 可以设置 Tomcat 的监听地址。</p>
<p>不过看 server.xml，里面是没有配置 address 的，所以就是默认的 0.0.0.0：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InetSocketAddress</span><span class="params">(InetAddress addr, <span class="type">int</span> port)</span> &#123;</span><br><span class="line">    holder = <span class="keyword">new</span> <span class="title class_">InetSocketAddressHolder</span>(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        addr == <span class="literal">null</span> ? InetAddress.anyLocalAddress() : addr,</span><br><span class="line">        checkPort(port));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回到 Acceptor，在接收到请求并获取到一个 SocketChannel 之后，会调用 setSocketOptions：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">setSocketOptions</span><span class="params">(SocketChannel socket)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">socketWrapper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">NioChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.nioChannels != <span class="literal">null</span>) &#123;</span><br><span class="line">            channel = (NioChannel)<span class="built_in">this</span>.nioChannels.pop();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (channel == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">SocketBufferHandler</span> <span class="variable">bufhandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SocketBufferHandler</span>(<span class="built_in">this</span>.socketProperties.getAppReadBufSize(), <span class="built_in">this</span>.socketProperties.getAppWriteBufSize(), <span class="built_in">this</span>.socketProperties.getDirectBuffer());</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.isSSLEnabled()) &#123;</span><br><span class="line">                channel = <span class="keyword">new</span> <span class="title class_">SecureNioChannel</span>(bufhandler, <span class="built_in">this</span>.selectorPool, <span class="built_in">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                channel = <span class="keyword">new</span> <span class="title class_">NioChannel</span>(bufhandler);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        NioEndpoint.<span class="type">NioSocketWrapper</span> <span class="variable">newWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEndpoint</span>.NioSocketWrapper((NioChannel)channel, <span class="built_in">this</span>);</span><br><span class="line">        ((NioChannel)channel).reset(socket, newWrapper);</span><br><span class="line">        <span class="built_in">this</span>.connections.put(socket, newWrapper);</span><br><span class="line">        socket.configureBlocking(<span class="literal">false</span>);</span><br><span class="line">        <span class="built_in">this</span>.socketProperties.setProperties(socket.socket());</span><br><span class="line">        newWrapper.setReadTimeout((<span class="type">long</span>)<span class="built_in">this</span>.getConnectionTimeout());</span><br><span class="line">        newWrapper.setWriteTimeout((<span class="type">long</span>)<span class="built_in">this</span>.getConnectionTimeout());</span><br><span class="line">        newWrapper.setKeepAliveLeft(<span class="built_in">this</span>.getMaxKeepAliveRequests());</span><br><span class="line">        <span class="built_in">this</span>.poller.register((NioChannel)channel, newWrapper);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新建一个 NioChannel，将 SocketChannel 和 NioSocketWrapper 放进去，再将新生成的 channel 和 wrapper 一起放入 connections Map 并注册进 Poller 中，注册进 Poller 中的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(NioChannel socket, NioEndpoint.NioSocketWrapper socketWrapper)</span> &#123;</span><br><span class="line">    socketWrapper.interestOps(<span class="number">1</span>);</span><br><span class="line">    NioEndpoint.<span class="type">PollerEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (NioEndpoint.<span class="built_in">this</span>.eventCache != <span class="literal">null</span>) &#123;</span><br><span class="line">        event = (NioEndpoint.PollerEvent)NioEndpoint.<span class="built_in">this</span>.eventCache.pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (event == <span class="literal">null</span>) &#123;</span><br><span class="line">        event = <span class="keyword">new</span> <span class="title class_">NioEndpoint</span>.PollerEvent(socket, <span class="number">256</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        event.reset(socket, <span class="number">256</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.addEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来说就是会添加进 events 这个队列中，Acceptor 的 run 函数大致结束了，接下来看看 Poller 的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasEvents</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        label59: &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">this</span>.close) &#123;</span><br><span class="line">                    hasEvents = <span class="built_in">this</span>.events();</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">this</span>.close) &#123;</span><br><span class="line">                    <span class="keyword">break</span> label59;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ...</span><br><span class="line">            &#125; </span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看看 events 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">events</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    NioEndpoint.<span class="type">PollerEvent</span> <span class="variable">pe</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="built_in">this</span>.events.size(); i &lt; size &amp;&amp; (pe = (NioEndpoint.PollerEvent)<span class="built_in">this</span>.events.poll()) != <span class="literal">null</span>; ++i) &#123;</span><br><span class="line">        result = <span class="literal">true</span>;</span><br><span class="line">        <span class="type">NioChannel</span> <span class="variable">channel</span> <span class="operator">=</span> pe.getSocket();</span><br><span class="line">        NioEndpoint.<span class="type">NioSocketWrapper</span> <span class="variable">socketWrapper</span> <span class="operator">=</span> channel.getSocketWrapper();</span><br><span class="line">        <span class="type">int</span> <span class="variable">interestOps</span> <span class="operator">=</span> pe.getInterestOps();</span><br><span class="line">        <span class="keyword">if</span> (interestOps == <span class="number">256</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                channel.getIOChannel().register(<span class="built_in">this</span>.getSelector(), <span class="number">1</span>, socketWrapper);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">                NioEndpoint.log.error(AbstractEndpoint.sm.getString(<span class="string">&quot;endpoint.nio.registerFail&quot;</span>), var12);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (NioEndpoint.<span class="built_in">this</span>.running &amp;&amp; !NioEndpoint.<span class="built_in">this</span>.paused &amp;&amp; NioEndpoint.<span class="built_in">this</span>.eventCache != <span class="literal">null</span>) &#123;</span><br><span class="line">            pe.reset();</span><br><span class="line">            NioEndpoint.<span class="built_in">this</span>.eventCache.push(pe);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 poll 从中队列中取出一个 event（并从队列中删除），关注这一句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.getIOChannel().register(<span class="built_in">this</span>.getSelector(), <span class="number">1</span>, socketWrapper);</span><br></pre></td></tr></table></figure>

<p>这里将 channel 注册到了 selector 上，并监听 read 事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">OP_READ</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>继续看 run 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.wakeupCounter.getAndSet(-<span class="number">1L</span>) &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.keyCount = <span class="built_in">this</span>.selector.selectNow();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.keyCount = <span class="built_in">this</span>.selector.select(NioEndpoint.<span class="built_in">this</span>.selectorTimeout);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">this</span>.wakeupCounter.set(<span class="number">0L</span>);</span><br></pre></td></tr></table></figure>

<p>wakeupCounter 是一个初始为 0 的计数器，每次 addEvent 就会 +1，没有 event 时就会为 0，从而进入 this.selector.select 的阻塞，超时时间为 1 秒。</p>
<p>如果存在有效事件，keyCount 就是有效事件的数量，后面就开始处理这些事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Iterator</span> <span class="variable">iterator</span> <span class="operator">=</span> <span class="built_in">this</span>.keyCount &gt; <span class="number">0</span> ? <span class="built_in">this</span>.selector.selectedKeys().iterator() : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(iterator != <span class="literal">null</span> &amp;&amp; iterator.hasNext()) &#123;</span><br><span class="line">    <span class="type">SelectionKey</span> <span class="variable">sk</span> <span class="operator">=</span> (SelectionKey)iterator.next();</span><br><span class="line">    NioEndpoint.<span class="type">NioSocketWrapper</span> <span class="variable">socketWrapper</span> <span class="operator">=</span> (NioEndpoint.NioSocketWrapper)sk.attachment();</span><br><span class="line">    <span class="keyword">if</span> (socketWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">        iterator.remove();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        iterator.remove();</span><br><span class="line">        <span class="built_in">this</span>.processKey(sk, socketWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看看 processKey 函数，关注 read 的部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (sk.isReadable()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (socketWrapper.readOperation != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!socketWrapper.readOperation.process()) &#123;</span><br><span class="line">            closeSocket = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!NioEndpoint.<span class="built_in">this</span>.processSocket(socketWrapper, SocketEvent.OPEN_READ, <span class="literal">true</span>)) &#123;</span><br><span class="line">        closeSocket = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下一步 processSocket：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (handshake == <span class="number">0</span>) &#123;</span><br><span class="line">    AbstractEndpoint.Handler.<span class="type">SocketState</span> <span class="variable">state</span> <span class="operator">=</span> AbstractEndpoint.Handler.SocketState.OPEN;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.event == <span class="literal">null</span>) &#123;</span><br><span class="line">        state = NioEndpoint.<span class="built_in">this</span>.getHandler().process(<span class="built_in">this</span>.socketWrapper, SocketEvent.OPEN_READ);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        state = NioEndpoint.<span class="built_in">this</span>.getHandler().process(<span class="built_in">this</span>.socketWrapper, <span class="built_in">this</span>.event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (state == AbstractEndpoint.Handler.SocketState.CLOSED) &#123;</span><br><span class="line">        poller.cancelledKey(socket.getIOChannel().keyFor(poller.getSelector()), <span class="built_in">this</span>.socketWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>handshake 为 0 代表 TCP 握手完成（大概），然后调用 handler 的 process 函数，这里的 handler 是个 ConnectionHandler 类，在 protocolHandler 实例化时赋值（AbstractHttp11Protocol 类构造函数）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AbstractProtocol.ConnectionHandler&lt;S&gt; cHandler = <span class="keyword">new</span> <span class="title class_">AbstractProtocol</span>.ConnectionHandler(<span class="built_in">this</span>);</span><br><span class="line"><span class="built_in">this</span>.setHandler(cHandler);</span><br><span class="line"><span class="built_in">this</span>.getEndpoint().setHandler(cHandler);</span><br></pre></td></tr></table></figure>

<p>process：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (processor == <span class="literal">null</span>) &#123;</span><br><span class="line">    processor = <span class="built_in">this</span>.getProtocol().createProcessor();</span><br><span class="line">    <span class="built_in">this</span>.register(processor);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.getLog().isDebugEnabled()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.getLog().debug(AbstractProtocol.sm.getString(<span class="string">&quot;abstractConnectionHandler.processorCreate&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;processor&#125;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一次访问时没有 processor，所以会调用 createProcessor 生成一个，AbstractHttp11Protocol 类的 createProcessor  函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Processor <span class="title function_">createProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Http11Processor</span> <span class="variable">processor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Http11Processor</span>(<span class="built_in">this</span>, <span class="built_in">this</span>.adapter);</span><br><span class="line">    <span class="keyword">return</span> processor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成的是 Http11Processor，然后调用其 process 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">state = processor.process(wrapper, status);</span><br></pre></td></tr></table></figure>

<p>然后来到 AbstractProcessorLight 类的 process：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (status == SocketEvent.OPEN_READ) &#123;</span><br><span class="line">    state = <span class="built_in">this</span>.service(socketWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回到 Http11Processor 类的 service 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.getAdapter().service(<span class="built_in">this</span>.request, <span class="built_in">this</span>.response);</span><br></pre></td></tr></table></figure>

<p>可以看到，这里有 request 和 response 两个属性，都来自 org.apache.coyote 包，找一下他们的生成方式，在父类 AbstractProcessor 的构造函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AbstractProcessor</span><span class="params">(Adapter adapter)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(adapter, <span class="keyword">new</span> <span class="title class_">Request</span>(), <span class="keyword">new</span> <span class="title class_">Response</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="title function_">AbstractProcessor</span><span class="params">(Adapter adapter, Request coyoteRequest, Response coyoteResponse)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.hostNameC = <span class="keyword">new</span> <span class="title class_">char</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">this</span>.asyncTimeout = -<span class="number">1L</span>;</span><br><span class="line">    <span class="built_in">this</span>.asyncTimeoutGeneration = <span class="number">0L</span>;</span><br><span class="line">    <span class="built_in">this</span>.socketWrapper = <span class="literal">null</span>;</span><br><span class="line">    <span class="built_in">this</span>.errorState = ErrorState.NONE;</span><br><span class="line">    <span class="built_in">this</span>.adapter = adapter;</span><br><span class="line">    <span class="built_in">this</span>.asyncStateMachine = <span class="keyword">new</span> <span class="title class_">AsyncStateMachine</span>(<span class="built_in">this</span>);</span><br><span class="line">    <span class="built_in">this</span>.request = coyoteRequest;</span><br><span class="line">    <span class="built_in">this</span>.response = coyoteResponse;</span><br><span class="line">    <span class="built_in">this</span>.response.setHook(<span class="built_in">this</span>);</span><br><span class="line">    <span class="built_in">this</span>.request.setResponse(<span class="built_in">this</span>.response);</span><br><span class="line">    <span class="built_in">this</span>.request.setHook(<span class="built_in">this</span>);</span><br><span class="line">    <span class="built_in">this</span>.userDataHelper = <span class="keyword">new</span> <span class="title class_">UserDataHelper</span>(<span class="built_in">this</span>.getLog());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 response 就存放在 request 中，Http11Processor 放在 request 和 response 中。不过仔细观察这个 request 中的属性，会发现他们似乎并不是我们习惯的那个 request。</p>
<p>而 Adapter 的赋值要追溯到 Connector 的 initInternal 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.adapter = <span class="keyword">new</span> <span class="title class_">CoyoteAdapter</span>(<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure>

<p>跟进 CoyoteAdapter 类的 service 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request)req.getNote(<span class="number">1</span>);</span><br><span class="line"><span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> (Response)res.getNote(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (request == <span class="literal">null</span>) &#123;</span><br><span class="line">    request = <span class="built_in">this</span>.connector.createRequest();</span><br><span class="line">    request.setCoyoteRequest(req);</span><br><span class="line">    response = <span class="built_in">this</span>.connector.createResponse();</span><br><span class="line">    response.setCoyoteResponse(res);</span><br><span class="line">    request.setResponse(response);</span><br><span class="line">    response.setRequest(request);</span><br><span class="line">    req.setNote(<span class="number">1</span>, request);</span><br><span class="line">    res.setNote(<span class="number">1</span>, response);</span><br><span class="line">    req.getParameters().setQueryStringCharset(<span class="built_in">this</span>.connector.getURICharset());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到我们习惯的 request（org.apache.catalina.connector），第一次访问时 request（org.apache.coyote）是刚刚生成的，所以 note 属性里面没有保存 request（org.apache.catalina.connector），这时会调用 createRequest&#x2F;createResponse 从 connector 生成并保存起来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Request <span class="title function_">createRequest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Request</span>(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Response <span class="title function_">createResponse</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="built_in">this</span>.protocolHandler.getDesiredBufferSize();</span><br><span class="line">    <span class="keyword">return</span> size &gt; <span class="number">0</span> ? <span class="keyword">new</span> <span class="title class_">Response</span>(size) : <span class="keyword">new</span> <span class="title class_">Response</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>request 和 response 互相嵌套，connector 套进了 request 中。</p>
<p>然后开始处理 HTTP 请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postParseSuccess = <span class="built_in">this</span>.postParseRequest(req, request, res, response);</span><br><span class="line"><span class="keyword">if</span> (postParseSuccess) &#123;</span><br><span class="line">    request.setAsyncSupported(<span class="built_in">this</span>.connector.getService().getContainer().getPipeline().isAsyncSupported());</span><br><span class="line">    <span class="built_in">this</span>.connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 postParseRequest 解析请求，如果解析成功就会开始反射，看这一长串链式执行，可以简化成 engine.getPipeline().getFirst().invoke(request, response)，我们回到 engine 去看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">Pipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardPipeline</span>(<span class="built_in">this</span>);</span><br></pre></td></tr></table></figure>

<p>StandardPipeline 类的 getFirst 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Valve <span class="title function_">getFirst</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.first != <span class="literal">null</span> ? <span class="built_in">this</span>.first : <span class="built_in">this</span>.basic;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调试可以发现，这里的 first 为 null，basic 来自 engine 的构造函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.pipeline.setBasic(<span class="keyword">new</span> <span class="title class_">StandardEngineValve</span>());</span><br></pre></td></tr></table></figure>

<p>所以最后的反射函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="type">Host</span> <span class="variable">host</span> <span class="operator">=</span> request.getHost();</span><br><span class="line">    <span class="keyword">if</span> (host != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</span><br><span class="line">            request.setAsyncSupported(host.getPipeline().isAsyncSupported());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        host.getPipeline().getFirst().invoke(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看看这里的 host 是怎么生成的，回到 postParseRequest，里面有一句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.connector.getService().getMapper().map(serverName, decodedURI, version, request.getMappingData());</span><br></pre></td></tr></table></figure>

<p>会来到 Mapper 类的 internalMap 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Mapper.MappedHost[] hosts = <span class="built_in">this</span>.hosts;</span><br><span class="line">Mapper.<span class="type">MappedHost</span> <span class="variable">mappedHost</span> <span class="operator">=</span> (Mapper.MappedHost)exactFindIgnoreCase(hosts, host);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">mappingData.host = (Host)mappedHost.object;</span><br></pre></td></tr></table></figure>

<p>hosts 是一个数组，通过 addHost 函数进行添加，再往上回到 MapperListener 类的 registerHost 函数中，在前面 start 的时候会注册进去：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException &#123;</span><br><span class="line">    <span class="built_in">this</span>.setState(LifecycleState.STARTING);</span><br><span class="line">    <span class="type">Engine</span> <span class="variable">engine</span> <span class="operator">=</span> <span class="built_in">this</span>.service.getContainer();</span><br><span class="line">    <span class="keyword">if</span> (engine != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.findDefaultHost();</span><br><span class="line">        <span class="built_in">this</span>.addListeners(engine);</span><br><span class="line">        Container[] conHosts = engine.findChildren();</span><br><span class="line">        Container[] var3 = conHosts;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var4</span> <span class="operator">=</span> conHosts.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="number">0</span>; var5 &lt; var4; ++var5) &#123;</span><br><span class="line">            <span class="type">Container</span> <span class="variable">conHost</span> <span class="operator">=</span> var3[var5];</span><br><span class="line">            <span class="type">Host</span> <span class="variable">host</span> <span class="operator">=</span> (Host)conHost;</span><br><span class="line">            <span class="keyword">if</span> (!LifecycleState.NEW.equals(host.getState())) &#123;</span><br><span class="line">                <span class="built_in">this</span>.registerHost(host);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到源数据来自 engine，即 server.xml 中配置并解析生成的 standardHost 对象。然后再调用 exactFindIgnoreCase 从这些 hosts 中获取该次请求对应的 host：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> &lt;T, E <span class="keyword">extends</span> <span class="title class_">Mapper</span>.MapElement&lt;T&gt;&gt; E <span class="title function_">exactFindIgnoreCase</span><span class="params">(E[] map, CharChunk name)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> findIgnoreCase(map, name);</span><br><span class="line">    <span class="keyword">if</span> (pos &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">E</span> <span class="variable">result</span> <span class="operator">=</span> map[pos];</span><br><span class="line">        <span class="keyword">if</span> (name.equalsIgnoreCase(result.name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来说就是将访问的 host 和 sever.xml 中配置的 host 匹配一下。</p>
<p>除了 host，mappingData 中还存放了其他重要属性，比如说 context，我们继续往下看 internalMap 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mapper.<span class="type">ContextList</span> <span class="variable">contextList</span> <span class="operator">=</span> mappedHost.contextList;</span><br><span class="line">Mapper.MappedContext[] contexts = contextList.contexts;</span><br><span class="line"><span class="type">int</span> <span class="variable">pos</span> <span class="operator">=</span> find(contexts, (CharChunk)uri);</span><br></pre></td></tr></table></figure>

<p>这里出现了一个 host 中的属性 contextList，它是在 registerHost 的时候注册的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerHost</span><span class="params">(Host host)</span> &#123;</span><br><span class="line">    String[] aliases = host.findAliases();</span><br><span class="line">    <span class="built_in">this</span>.mapper.addHost(host.getName(), aliases, host);</span><br><span class="line">    Container[] var3 = host.findChildren();</span><br><span class="line">    <span class="type">int</span> <span class="variable">var4</span> <span class="operator">=</span> var3.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="number">0</span>; var5 &lt; var4; ++var5) &#123;</span><br><span class="line">        <span class="type">Container</span> <span class="variable">container</span> <span class="operator">=</span> var3[var5];</span><br><span class="line">        <span class="keyword">if</span> (container.getState().isAvailable()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.registerContext((Context)container);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.findDefaultHost();</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在 addContextVersion 函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Mapper.<span class="type">ContextVersion</span> <span class="variable">newContextVersion</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mapper</span>.ContextVersion(version, path, slashCount, context, resources, welcomeResources);</span><br><span class="line"><span class="keyword">if</span> (wrappers != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.addWrappers(newContextVersion, wrappers);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Mapper.<span class="type">ContextList</span> <span class="variable">contextList</span> <span class="operator">=</span> mappedHost.contextList;</span><br><span class="line">Mapper.<span class="type">MappedContext</span> <span class="variable">mappedContext</span> <span class="operator">=</span> (Mapper.MappedContext)exactFind(contextList.contexts, (String)path);</span><br><span class="line"><span class="keyword">if</span> (mappedContext == <span class="literal">null</span>) &#123;</span><br><span class="line">    mappedContext = <span class="keyword">new</span> <span class="title class_">Mapper</span>.MappedContext(path, newContextVersion);</span><br><span class="line">    Mapper.<span class="type">ContextList</span> <span class="variable">newContextList</span> <span class="operator">=</span> contextList.addContext(mappedContext, slashCount);</span><br><span class="line">    <span class="keyword">if</span> (newContextList != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.updateContextList(mappedHost, newContextList);</span><br><span class="line">        <span class="built_in">this</span>.contextObjectToContextVersionMap.put(context, newContextVersion);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>context 和 contextVersion 放入 MappedContext，再放入 contextList 中。</p>
<p>context 配置在 server.xml 的 host 模块下面，代表一个 web 项目（war 包或其解压后的目录），而因为 Tomcat 开启了 autoDeploy 和 unpackWARs，所以文件中没有静态配置，而是由 Tomcat 进行动态加载。顺带一提的是 context 的 name 就是配置中的 path，在 setPath 函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.getName() == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.setName(<span class="built_in">this</span>.path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续 internalMap，通过 uri 匹配到对应的 context 后，会将其放入 mappingData 中。（standardContext 就保存在 contextVersion 中）</p>
<p>还有一个重要属性 wrapper，获取 context 之后，会调用 internalMapWrapper 获取相应的 wrapper，先来看看 wrapper 的生成方式，context 中的 wrapper 在 ContextConfig 类中生成，这个类会解析 web.xml 并做相应处理，其 configureContext 函数一部分如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var35 = webxml.getServlets().values().iterator();</span><br><span class="line"></span><br><span class="line">Iterator var7;</span><br><span class="line"><span class="keyword">while</span>(var35.hasNext()) &#123;</span><br><span class="line">    <span class="type">ServletDef</span> <span class="variable">servlet</span> <span class="operator">=</span> (ServletDef)var35.next();</span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="built_in">this</span>.context.createWrapper();</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">this</span>.context.addChild(wrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成 wrapper 然后用 addChild 添加到 context 中，可以发现  wrapper 和 servlet 是对应的，中间有一大段将 servlet 相关数据存储在 wrapper 中的代码被我省略了，接下来回到 standardContext 类的 createWrapper 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrapper = <span class="keyword">new</span> <span class="title class_">StandardWrapper</span>();</span><br></pre></td></tr></table></figure>

<p>wrapper 是一个 StandardWrapper 类，其他的没有什么特别操作了。在注册 context 的时候（registerContext），这些 wrapper 会经过 prepareWrapperMappingInfo 函数处理，合成一个 List：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">prepareWrapperMappingInfo</span><span class="params">(Context context, Wrapper wrapper, List&lt;WrapperMappingInfo&gt; wrappers)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">wrapperName</span> <span class="operator">=</span> wrapper.getName();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">resourceOnly</span> <span class="operator">=</span> context.isResourceOnlyServlet(wrapperName);</span><br><span class="line">    String[] mappings = wrapper.findMappings();</span><br><span class="line">    String[] var7 = mappings;</span><br><span class="line">    <span class="type">int</span> <span class="variable">var8</span> <span class="operator">=</span> mappings.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var9</span> <span class="operator">=</span> <span class="number">0</span>; var9 &lt; var8; ++var9) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">mapping</span> <span class="operator">=</span> var7[var9];</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">jspWildCard</span> <span class="operator">=</span> wrapperName.equals(<span class="string">&quot;jsp&quot;</span>) &amp;&amp; mapping.endsWith(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        wrappers.add(<span class="keyword">new</span> <span class="title class_">WrapperMappingInfo</span>(mapping, wrapper, jspWildCard, resourceOnly));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后通过 addWrappers 分门别类组装成 MappedWrapper 放入 contextVersion：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addWrappers</span><span class="params">(Mapper.ContextVersion contextVersion, Collection&lt;WrapperMappingInfo&gt; wrappers)</span> &#123;</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var3</span> <span class="operator">=</span> wrappers.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var3.hasNext()) &#123;</span><br><span class="line">        <span class="type">WrapperMappingInfo</span> <span class="variable">wrapper</span> <span class="operator">=</span> (WrapperMappingInfo)var3.next();</span><br><span class="line">        <span class="built_in">this</span>.addWrapper(contextVersion, wrapper.getMapping(), wrapper.getWrapper(), wrapper.isJspWildCard(), wrapper.isResourceOnly());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">addWrapper</span><span class="params">(Mapper.ContextVersion context, String path, Wrapper wrapper, <span class="type">boolean</span> jspWildCard, <span class="type">boolean</span> resourceOnly)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(context) &#123;</span><br><span class="line">        String name;</span><br><span class="line">        Mapper.MappedWrapper newWrapper;</span><br><span class="line">        Mapper.MappedWrapper[] oldWrappers;</span><br><span class="line">        Mapper.MappedWrapper[] newWrappers;</span><br><span class="line">        <span class="keyword">if</span> (path.endsWith(<span class="string">&quot;/*&quot;</span>)) &#123;</span><br><span class="line">            name = path.substring(<span class="number">0</span>, path.length() - <span class="number">2</span>);</span><br><span class="line">            newWrapper = <span class="keyword">new</span> <span class="title class_">Mapper</span>.MappedWrapper(name, wrapper, jspWildCard, resourceOnly);</span><br><span class="line">            oldWrappers = context.wildcardWrappers;</span><br><span class="line">            newWrappers = <span class="keyword">new</span> <span class="title class_">Mapper</span>.MappedWrapper[oldWrappers.length + <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;</span><br><span class="line">                context.Wrappers = newWrappers;</span><br><span class="line">                <span class="type">int</span> <span class="variable">slashCount</span> <span class="operator">=</span> slashCount(newWrapper.name);</span><br><span class="line">                <span class="keyword">if</span> (slashCount &gt; context.nesting) &#123;</span><br><span class="line">                    context.nesting = slashCount;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.startsWith(<span class="string">&quot;*.&quot;</span>)) &#123;</span><br><span class="line">            name = path.substring(<span class="number">2</span>);</span><br><span class="line">            newWrapper = <span class="keyword">new</span> <span class="title class_">Mapper</span>.MappedWrapper(name, wrapper, jspWildCard, resourceOnly);</span><br><span class="line">            oldWrappers = context.extensionWrappers;</span><br><span class="line">            newWrappers = <span class="keyword">new</span> <span class="title class_">Mapper</span>.MappedWrapper[oldWrappers.length + <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;</span><br><span class="line">                context.extensionWrappers = newWrappers;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.equals(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">            Mapper.<span class="type">MappedWrapper</span> <span class="variable">newWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mapper</span>.MappedWrapper(<span class="string">&quot;&quot;</span>, wrapper, jspWildCard, resourceOnly);</span><br><span class="line">            context.defaultWrapper = newWrapper;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (path.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                name = <span class="string">&quot;/&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                name = path;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            newWrapper = <span class="keyword">new</span> <span class="title class_">Mapper</span>.MappedWrapper(name, wrapper, jspWildCard, resourceOnly);</span><br><span class="line">            oldWrappers = context.exactWrappers;</span><br><span class="line">            newWrappers = <span class="keyword">new</span> <span class="title class_">Mapper</span>.MappedWrapper[oldWrappers.length + <span class="number">1</span>];</span><br><span class="line">            <span class="keyword">if</span> (insertMap(oldWrappers, newWrappers, newWrapper)) &#123;</span><br><span class="line">                context.exactWrappers = newWrappers;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要有几个分类：</p>
<ul>
<li>wildcardWrappers：&#x2F;* 通配符结尾的路径</li>
<li>extensionWrappers：某一类后缀的路径</li>
<li>defaultWrapper：&#x2F; 结尾的默认（首页?）路径</li>
<li>exactWrappers：全匹配的详细路径</li>
</ul>
<p>现在回到 internalMapWrapper，可以看到匹配成功后，会将 wrapper 放入 mappingData 中。</p>
<p>回到反射，下一步是 StandardHostValve 类，获取的 context 就是前面 internalMap 函数匹配到的那个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> request.getContext();</span><br><span class="line">...</span><br><span class="line">context.getPipeline().getFirst().invoke(request, response);</span><br></pre></td></tr></table></figure>

<p>然后是 StandardContextValve 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="type">MessageBytes</span> <span class="variable">requestPathMB</span> <span class="operator">=</span> request.getRequestPathMB();</span><br><span class="line">    <span class="keyword">if</span> (!requestPathMB.startsWithIgnoreCase(<span class="string">&quot;/META-INF/&quot;</span>, <span class="number">0</span>) &amp;&amp; !requestPathMB.equalsIgnoreCase(<span class="string">&quot;/META-INF&quot;</span>) &amp;&amp; !requestPathMB.startsWithIgnoreCase(<span class="string">&quot;/WEB-INF/&quot;</span>, <span class="number">0</span>) &amp;&amp; !requestPathMB.equalsIgnoreCase(<span class="string">&quot;/WEB-INF&quot;</span>)) &#123;</span><br><span class="line">        <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> request.getWrapper();</span><br><span class="line">        <span class="keyword">if</span> (wrapper != <span class="literal">null</span> &amp;&amp; !wrapper.isUnavailable()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                response.sendAcknowledgement();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var6) &#123;</span><br><span class="line">                <span class="built_in">this</span>.container.getLogger().error(sm.getString(<span class="string">&quot;standardContextValve.acknowledgeException&quot;</span>), var6);</span><br><span class="line">                request.setAttribute(<span class="string">&quot;javax.servlet.error.exception&quot;</span>, var6);</span><br><span class="line">                response.sendError(<span class="number">500</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</span><br><span class="line">                request.setAsyncSupported(wrapper.getPipeline().isAsyncSupported());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            wrapper.getPipeline().getFirst().invoke(request, response);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            response.sendError(<span class="number">404</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        response.sendError(<span class="number">404</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是 StandardWrapperValve 类，首先会生成一个 Servlet 对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!unavailable) &#123;</span><br><span class="line">        servlet = wrapper.allocate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>wrapper 的 allocate 函数中，会先检查自身的 instance 属性中有没有加载好的 servlet，没有则会调用 loadServlet 进行加载：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">servlet = (Servlet)instanceManager.newInstance(<span class="built_in">this</span>.servletClass);</span><br></pre></td></tr></table></figure>

<p>这里的 servletClass 来自 web.xml 中配置的类。</p>
<p>获取到 servlet 后，会调用 createFilterChain 创建 filterChain：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApplicationFilterChain</span> <span class="variable">filterChain</span> <span class="operator">=</span> ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br></pre></td></tr></table></figure>

<p>createFilterChain：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApplicationFilterChain</span> <span class="variable">filterChain</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (request <span class="keyword">instanceof</span> Request) &#123;</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request)request;</span><br><span class="line">    <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">        filterChain = <span class="keyword">new</span> <span class="title class_">ApplicationFilterChain</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        filterChain = (ApplicationFilterChain)req.getFilterChain();</span><br><span class="line">        <span class="keyword">if</span> (filterChain == <span class="literal">null</span>) &#123;</span><br><span class="line">            filterChain = <span class="keyword">new</span> <span class="title class_">ApplicationFilterChain</span>();</span><br><span class="line">            req.setFilterChain(filterChain);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    filterChain = <span class="keyword">new</span> <span class="title class_">ApplicationFilterChain</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先该 request 对象中有没有存放有 filterChain，如果没有（比如第一次访问）则生成一个 ApplicationFilterChain 对象。继续往下看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">filterChain.setServlet(servlet);</span><br><span class="line">filterChain.setServletSupportsAsync(wrapper.isAsyncSupported());</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">context</span> <span class="operator">=</span> (StandardContext)wrapper.getParent();</span><br><span class="line">FilterMap[] filterMaps = context.findFilterMaps();</span><br></pre></td></tr></table></figure>

<p>将 servlet 放入 filterChain，取出 context，再从 context 中取出 filterMaps，filterMaps 的赋值可以回到 configureContext：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var2 = webxml.getFilterMappings().iterator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(var2.hasNext()) &#123;</span><br><span class="line">    <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> (FilterMap)var2.next();</span><br><span class="line">    <span class="built_in">this</span>.context.addFilterMap(filterMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单来说也是从 web.xml 中来的。回到 createFilterChain：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">servletName</span> <span class="operator">=</span> wrapper.getName();</span><br><span class="line">FilterMap[] var10 = filterMaps;</span><br><span class="line"><span class="type">int</span> <span class="variable">var11</span> <span class="operator">=</span> filterMaps.length;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> var12;</span><br><span class="line">FilterMap filterMap;</span><br><span class="line">ApplicationFilterConfig filterConfig;</span><br><span class="line"><span class="keyword">for</span>(var12 = <span class="number">0</span>; var12 &lt; var11; ++var12) &#123;</span><br><span class="line">    filterMap = var10[var12];</span><br><span class="line">    <span class="keyword">if</span> (matchDispatcher(filterMap, dispatcher) &amp;&amp; matchFiltersURL(filterMap, requestPath)) &#123;</span><br><span class="line">        filterConfig = (ApplicationFilterConfig)context.findFilterConfig(filterMap.getFilterName());</span><br><span class="line">        <span class="keyword">if</span> (filterConfig != <span class="literal">null</span>) &#123;</span><br><span class="line">            filterChain.addFilter(filterConfig);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>匹配上 DispatcherType 和 requestPath 就会加入 filterChain 中。</p>
<p>回到 StandardWrapperValve，创建完 filterChain 之后执行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filterChain.doFilter(request.getRequest(), response.getResponse());</span><br></pre></td></tr></table></figure>

<p>即：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.pos &lt; <span class="built_in">this</span>.n) &#123;</span><br><span class="line">    <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> <span class="built_in">this</span>.filters[<span class="built_in">this</span>.pos++];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> filterConfig.getFilter();</span><br><span class="line">        <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; <span class="string">&quot;false&quot;</span>.equalsIgnoreCase(filterConfig.getFilterDef().getAsyncSupported())) &#123;</span><br><span class="line">            request.setAttribute(<span class="string">&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;</span>, Boolean.FALSE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">            <span class="type">Principal</span> <span class="variable">principal</span> <span class="operator">=</span> ((HttpServletRequest)request).getUserPrincipal();</span><br><span class="line">            Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;request, response, <span class="built_in">this</span>&#125;;</span><br><span class="line">            SecurityUtil.doAsPrivilege(<span class="string">&quot;doFilter&quot;</span>, filter, classType, args, principal);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            filter.doFilter(request, response, <span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ServletException | RuntimeException | IOException var15) &#123;</span><br><span class="line">        <span class="keyword">throw</span> var15;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var16) &#123;</span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">e</span> <span class="operator">=</span> ExceptionUtils.unwrapInvocationTargetException(var16);</span><br><span class="line">        ExceptionUtils.handleThrowable(e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(sm.getString(<span class="string">&quot;filterChain.filter&quot;</span>), e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>依次调用这些 filter 的 doFilter 函数，在处理完 filter 之后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</span><br><span class="line">        lastServicedRequest.set(request);</span><br><span class="line">        lastServicedResponse.set(response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request.isAsyncSupported() &amp;&amp; !<span class="built_in">this</span>.servletSupportsAsync) &#123;</span><br><span class="line">        request.setAttribute(<span class="string">&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;</span>, Boolean.FALSE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (request <span class="keyword">instanceof</span> HttpServletRequest &amp;&amp; response <span class="keyword">instanceof</span> HttpServletResponse &amp;&amp; Globals.IS_SECURITY_ENABLED) &#123;</span><br><span class="line">        <span class="type">Principal</span> <span class="variable">principal</span> <span class="operator">=</span> ((HttpServletRequest)request).getUserPrincipal();</span><br><span class="line">        Object[] args = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;request, response&#125;;</span><br><span class="line">        SecurityUtil.doAsPrivilege(<span class="string">&quot;service&quot;</span>, <span class="built_in">this</span>.servlet, classTypeUsedInService, args, principal);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.servlet.service(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就开始调用 servlet 的 service 函数，往后就是项目的具体实现代码了，就不提了。</p>
<hr>
<p>Orz</p>

            </div>
            <hr>
            <div>
              <p>
                
                
                  <span>
                <i class="iconfont icon-tag"></i>
                    
                      <a class="hover-with-bg" href="/tags/Web/">Web</a>
                    
                      <a class="hover-with-bg" href="/tags/Java/">Java</a>
                    
                      <a class="hover-with-bg" href="/tags/Tomcat/">Tomcat</a>
                    
                  </span>
                
              </p>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-12 col-md-6">
                    
                      <a href="/2020/11/24/Jenkins%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/">
                        <i class="fa fa-chevron-left"></i>
                        <span>Jenkins相关漏洞学习（一）</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-12 col-md-6">
                    
                      <a href="/2020/10/21/Java-7u21-8u20-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">
                        <span>Java 7u21/8u20 反序列化漏洞</span>
                        <i class="fa fa-chevron-right"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

              
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc-start"></div>
<div id="toc">
  <p class="h5"><i class="far fa-list-alt"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="https://cdn.staticfile.org/mdbootstrap/4.13.0/js/mdb.min.js" ></script>
<script  src="/js/main.js" ></script>


  <script  src="/js/lazyload.js" ></script>



  
  <script  src="https://cdn.staticfile.org/tocbot/4.10.0/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var navHeight = $('#navbar').height();
      var toc = $('#toc');
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;
      var tocLimMax = 2 * boardTop + boardCtn.height();

      $(window).scroll(function () {
        var tocLimMin = $('#toc-start').offset().top - navHeight;
        var scroH = document.body.scrollTop + document.documentElement.scrollTop;

        if (tocLimMin <= scroH && scroH <= tocLimMax) {
          toc.css({
            'display': 'block',
            'position': 'fixed',
            'top': navHeight,
          });
        } else if (scroH <= tocLimMin) {
          toc.css({
            'position': '',
            'top': '',
          });
        } else if (scroH > tocLimMax) {
          toc.css('display', 'none');
        }
      });
      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc > p').css('visibility', 'visible');
      }
      var offset = boardCtn.css('margin-right')
      $('#toc-ctn').css({
        'right': offset
      })
    });
  </script>







  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




<!-- Plugins -->



  <script  src="https://cdn.staticfile.org/prettify/188.0.0/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Tomcat源码观测&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script defer src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>












</body>
</html>
